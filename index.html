<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Arnavutköy Belediyesi - JD-R Anket</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries,typography"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Playfair+Display:ital,wght@0,400;0,500;0,600;0,700;1,400&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="rapor_verileri.js"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: "#F5A58D",
                        "page-bg": "#FBF7EF",
                        "sidebar-bg": "#F8F4EC",
                        "sidebar-active": "#C86A3C",
                        "sidebar-active-text": "#FFF9F3",
                        "text-sidebar": "#7B746A",
                        "text-body": "#2F2A24",
                        "text-meta": "#7B746A",
                        "background-dark": "#1C1917",
                        "surface-light": "#FFFFFF",
                        "surface-dark": "#292524",
                        "text-main-light": "#2F2A24",
                        "text-main-dark": "#E7E5E4",
                        "text-muted-light": "#7B746A",
                        "text-muted-dark": "#A8A29E",
                        "border-light": "#E2D9CA",
                        "border-dark": "#44403C",
                        "label-subtle": "#9A8F80",
                        "title-brown": "#2B241C",
                        "logo-charcoal": "#211A16",
                    },
                    fontFamily: {
                        sans: ["Inter", "sans-serif"],
                        serif: ["Playfair Display", "serif"],
                    },
                    boxShadow: {
                        'soft': '0 4px 20px -2px rgba(226, 217, 202, 0.5)',
                        'soft-dark': '0 4px 20px -2px rgba(0, 0, 0, 0.3)',
                    },
                },
            },
        };
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        .material-icons-outlined, .material-symbols-outlined {
            vertical-align: middle;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #FBF7EF;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* SIDEBAR TOGGLE - Mobile only */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.3);
            z-index: 40;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .sidebar-overlay.active {
            display: block;
            opacity: 1;
        }

        /* Hamburger button inside sidebar */
        .hamburger-btn {
            display: flex;
            width: 36px;
            height: 36px;
            border-radius: 10px;
            background: transparent;
            border: 1px solid #E2D9CA;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .hamburger-btn:hover {
            background: rgba(255,255,255,0.6);
        }

        .hamburger-btn span {
            font-size: 22px;
            color: #7B746A;
        }

        /* Floating hamburger when sidebar hidden */
        .hamburger-floating {
            display: none;
            position: fixed;
            top: 12px;
            left: 12px;
            z-index: 60;
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: rgba(248, 244, 236, 0.95);
            border: 1px solid #E2D9CA;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
            transition: all 0.2s;
            backdrop-filter: blur(8px);
        }
        
        /* When sidebar is hidden on desktop, add left padding to main content */
        .sidebar.desktop-hidden ~ .main-content {
            padding-left: 60px;
        }

        .hamburger-floating.visible {
            display: flex;
        }

        .hamburger-floating:hover {
            background: #FFFFFF;
            transform: scale(1.05);
        }

        .hamburger-floating span {
            font-size: 24px;
            color: #7B746A;
        }

        /* SIDEBAR */
        .sidebar {
            width: 320px;
            background: #F8F4EC;
            color: #2F2A24;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            position: relative;
            height: 100vh;
            z-index: 50;
            transition: width 0.3s ease, transform 0.3s ease;
        }

        .sidebar.desktop-hidden {
            width: 0;
            overflow: hidden;
        }

        /* Mobile styles */
        @media (max-width: 768px) {
            .hamburger-floating {
                display: flex !important;
            }

            .sidebar {
                position: fixed;
                left: 0;
                top: 0;
                width: 85vw;
                max-width: 320px;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
                box-shadow: 4px 0 20px rgba(0,0,0,0.1);
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .sidebar.desktop-hidden {
                width: 85vw;
                max-width: 320px;
            }

            .sidebar-header {
                padding: 20px 16px 12px 16px;
                flex-direction: column;
                gap: 12px;
            }

            .sidebar-header .hamburger-btn {
                position: absolute;
                top: 16px;
                right: 16px;
            }

            .sidebar-header-text h1 {
                font-size: 20px !important;
            }

            .sidebar-header-text p {
                font-size: 9px !important;
            }

            .main-content {
                margin-left: 0;
            }

            .content-header {
                padding: 16px 12px;
            }

            .content-header h2 {
                font-size: 11px;
                padding-left: 50px;
            }

            .content-body {
                padding: 0 12px 40px 12px;
            }

            .footer-signature {
                display: none;
            }
        }

        .sidebar-header {
            padding: 32px 32px 16px 32px;
        }

        .sidebar-header-text {
            flex: 1;
        }

        .sidebar-menu {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .menu-category {
            padding: 0 16px 12px 16px;
            font-size: 10px;
            font-weight: 700;
            color: #7B746A;
            text-transform: uppercase;
            letter-spacing: 0.2em;
            margin-top: 32px;
            opacity: 0.7;
        }

        .menu-category:first-child {
            margin-top: 0;
        }

        .menu-item {
            padding: 10px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.2s;
            border-radius: 12px;
            font-size: 14px;
            color: #7B746A;
            font-weight: 500;
            margin: 2px 0;
        }

        .menu-item:hover {
            background: rgba(255, 255, 255, 0.6);
            color: #2F2A24;
        }

        .menu-item.active {
            background: #C86A3C;
            color: #FFF9F3;
            font-weight: 500;
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(200, 106, 60, 0.3);
            transform: translateY(-1px);
        }

        .menu-item-icon {
            font-size: 20px;
            width: 22px;
            text-align: center;
            opacity: 0.8;
        }

        .menu-item.active .menu-item-icon {
            opacity: 1;
        }

        .menu-item-important {
            background: #FDFCFA;
            border-left: 3px solid #C86A3C;
            font-weight: 600;
            margin: 2px 12px;
            border-radius: 6px;
            padding: 12px 16px;
        }

        .menu-item-important:hover {
            background: rgba(74, 144, 226, 0.08);
            transform: translateX(2px);
        }

        .menu-item-important.active {
            background: #C86A3C;
            color: white;
            border-left-color: #2563eb;
        }

        .menu-item-important.active .menu-item-icon {
            color: white;
        }

        /* MAIN CONTENT */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: #FBF7EF;
            position: relative;
        }

        .content-header {
            background: rgba(251, 247, 239, 0.95);
            backdrop-filter: blur(8px);
            padding: 8px 32px;
            position: sticky;
            top: 0;
            z-index: 20;
        }

        .content-header h2 {
            font-size: 11px;
            color: #9A8F80;
            margin-bottom: 0;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.2em;
        }

        .content-body {
            flex: 1;
            overflow-y: auto;
            padding: 0 32px 60px 32px;
            background: #FBF7EF;
        }

        .iframe-fullscreen-container {
            width: 100%;
            height: calc(100vh - 44px);
        }

        .content-body.no-padding {
            padding: 0 !important;
        }

        .footer-signature {
            position: fixed;
            bottom: 16px;
            right: 32px;
            font-size: 11px;
            color: #7B746A;
            font-weight: 500;
            background: white;
            padding: 8px 16px;
            border-radius: 999px;
            box-shadow: 0 4px 20px -2px rgba(226, 217, 202, 0.5);
            border: 1px solid #E2D9CA;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .page-content {
            display: none;
        }

        .page-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* BUTTONS */
        .btn {
            background: #C86A3C;
            color: #FFF9F3;
            border: none;
            padding: 12px 24px;
            border-radius: 999px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(200, 106, 60, 0.3);
            background: #B55D33;
        }

        .btn-success {
            background: #4A9079;
        }

        .btn-success:hover {
            background: #3D7A66;
        }

        .btn-danger {
            background: #C75050;
        }

        .btn-danger:hover {
            background: #B04545;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn-reset {
            background: #6c757d;
            padding: 8px 16px;
            font-size: 13px;
            margin: 0;
        }

        .btn-reset:hover {
            background: #5a6268;
            transform: none;
        }

        /* TABLES */
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            border-radius: 16px;
            overflow: hidden;
            margin: 15px 0;
            font-size: 13px;
            border: 1px solid #E2D9CA;
        }

        th {
            background: #FBF7EF;
            color: #211A16;
            padding: 12px 10px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
            border-bottom: 1px solid #E2D9CA;
            font-size: 13px;
        }

        td {
            padding: 10px;
            border-bottom: 1px solid #F3EDE3;
            color: #211A16;
        }

        tr:hover {
            background: #FBF7EF;
        }

        tr:nth-child(even) {
            background: #FDFCFA;
        }

        tr:hover:nth-child(even) {
            background: #FBF7EF;
        }

        /* RAPOR TABLOLARI */
        #mudurlukRaporlari table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            font-size: 11pt;
            background: white;
            border: 1px solid #E2D9CA;
            border-radius: 12px;
            overflow: hidden;
        }
        
        #mudurlukRaporlari th {
            padding: 10px 12px;
            text-align: left;
            border: 1px solid #E2D9CA;
            background: #C86A3C !important;
            color: white !important;
            font-weight: 600;
        }
        
        #mudurlukRaporlari td {
            padding: 8px 12px;
            text-align: left;
            border: 1px solid #E2D9CA;
            color: #211A16;
        }
        
        #mudurlukRaporlari thead tr {
            background: #C86A3C !important;
        }
        
        #mudurlukRaporlari tbody tr:nth-child(even) {
            background: #FDFCFA;
        }
        
        #mudurlukRaporlari tbody tr:hover {
            background: #FBF7EF;
        }

        .highlight {
            background: #fef3c7 !important;
            font-weight: 600;
        }
        
        /* Critical highlight: ≤ -8 difference (dark red) */
        .highlight-critical {
            background: #fee2e2 !important;
            color: #b91c1c !important;
            font-weight: 700;
        }
        
        /* Warning highlight: -5 to -8 difference (orange) */
        .highlight-warning {
            background: #ffedd5 !important;
            color: #c2410c !important;
            font-weight: 600;
        }
        
        /* Positive highlight: positive differences (green) */
        .highlight-positive {
            background: #dcfce7 !important;
            color: #15803d !important;
            font-weight: 600;
        }

        .positive {
            color: #10b981;
            font-weight: 600;
        }

        .negative {
            color: #ef4444;
            font-weight: 600;
        }
        
        /* Below average spectrum colors */
        .below-avg-mild {
            color: #D97706; /* amber-600 */
        }
        .below-avg-moderate {
            color: #EA580C; /* orange-600 */
        }
        .below-avg-severe {
            color: #DC2626; /* red-600 */
        }

        /* INFO BOXES */
        .info-box,
        .warning-box {
            padding: 16px 20px;
            margin: 15px 0;
            border-radius: 12px;
            border-left: 4px solid;
            font-size: 14px;
        }

        .info-box {
            background: #FBF7EF;
            border-color: #C86A3C;
            color: #211A16;
        }

        .warning-box {
            background: #FEF3C7;
            border-color: #F59E0B;
            color: #92400E;
        }

        .success-message {
            background: #d1fae5;
            border: 1px solid #a7f3d0;
            color: #065f46;
            padding: 14px 16px;
            border-radius: 10px;
            margin: 10px 0;
            animation: slideDown 0.3s;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* STATS CARDS */
        .stats-card {
            background: #FFFFFF;
            border: 1px solid #E2D9CA;
            color: #211A16;
            padding: 20px;
            border-radius: 16px;
            margin: 10px 10px 10px 0;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            display: inline-block;
            min-width: 150px;
        }

        .stats-card h3 {
            font-size: 13px;
            margin-bottom: 8px;
            color: #7B746A;
            font-weight: 500;
        }

        .stats-card p {
            font-size: 28px;
            font-weight: 700;
            color: #211A16;
        }

        /* FORM ELEMENTS */
        select {
            padding: 10px 14px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            min-width: 300px;
            cursor: pointer;
            background: white;
            color: #1f2937;
        }

        select:focus {
            outline: none;
            border-color: #C86A3C;
            box-shadow: 0 0 0 3px rgba(200, 106, 60, 0.1);
        }

        .filter-bar {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 15px 0;
            padding: 12px 16px;
            background: #FBF7EF;
            border-radius: 12px;
            border: 1px solid #E2D9CA;
        }

        .filter-bar input {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 13px;
            flex: 1;
            max-width: 300px;
        }

        .filter-bar input:focus {
            outline: none;
            border-color: #C86A3C;
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
        }

        /* TABLE CONTAINER */
        .table-container {
            overflow-x: auto;
            max-height: 70vh;
            background: white;
            border: 1px solid #E2D9CA;
            border-radius: 16px;
        }

        /* STICKY TABLE WRAPPER - shared class for all sticky tables */
        .sticky-table-wrapper,
        #sorularTableWrapper {
            position: relative;
            overflow: auto !important;
            max-height: 75vh;
            border: 1px solid #E2D9CA;
            border-radius: 16px;
            background: white;
        }
        
        .sticky-table-wrapper table,
        #sorularTable {
            border-collapse: separate !important;
            border-spacing: 0 !important;
            width: max-content;
            overflow: visible !important;
            border-radius: 0 !important;
        }

        /* Sticky first column for all detailed tables */
        #sorularTable th:first-child,
        #sorularTable td:first-child,
        #genelSkorlarTable th:first-child,
        #genelSkorlarTable td:first-child,
        #sosyalMedyaTable th:first-child,
        #sosyalMedyaTable td:first-child,
        #ruhSagligiTable th:first-child,
        #ruhSagligiTable td:first-child,
        #temalarTable th:first-child,
        #temalarTable td:first-child {
            position: -webkit-sticky !important;
            position: sticky !important;
            left: 0 !important;
            z-index: 50 !important;
            background: #fff !important;
            box-shadow: 4px 0 8px -2px rgba(0,0,0,0.1);
            min-width: 280px !important;
        }

        #sorularTable td:first-child {
            min-width: 380px !important;
            max-width: 380px !important;
        }

        /* Sticky headers - warm cream style */
        #sorularTable thead th,
        #genelSkorlarTable thead th,
        #sosyalMedyaTable thead th,
        #ruhSagligiTable thead th,
        #temalarTable thead th {
            position: -webkit-sticky !important;
            position: sticky !important;
            top: 0 !important;
            z-index: 40 !important;
            background: #F8F4EC !important;
            color: #2B241C !important;
            border-bottom: 2px solid #E2D9CA !important;
        }

        #sorularTable thead th:first-child,
        #genelSkorlarTable thead th:first-child,
        #sosyalMedyaTable thead th:first-child,
        #ruhSagligiTable thead th:first-child,
        #temalarTable thead th:first-child {
            position: -webkit-sticky !important;
            position: sticky !important;
            left: 0 !important;
            top: 0 !important;
            z-index: 100 !important;
            background: #F8F4EC !important;
        }

        #sorularTable th,
        #sorularTable td {
            min-width: 140px;
            padding: 12px 10px;
        }

        #sorularTable tr:nth-child(even) td:first-child,
        #genelSkorlarTable tr:nth-child(even) td:first-child,
        #sosyalMedyaTable tr:nth-child(even) td:first-child,
        #ruhSagligiTable tr:nth-child(even) td:first-child,
        #temalarTable tr:nth-child(even) td:first-child {
            background: #FDFCFA !important;
        }
        
        #sorularTable tr:hover td:first-child,
        #genelSkorlarTable tr:hover td:first-child,
        #sosyalMedyaTable tr:hover td:first-child,
        #ruhSagligiTable tr:hover td:first-child,
        #temalarTable tr:hover td:first-child {
            background: #FFF8F0 !important;
        }
        
        /* Override for sticky tables - must have border-collapse: separate */
        #genelSkorlarTable,
        #sosyalMedyaTable,
        #ruhSagligiTable,
        #temalarTable {
            border-collapse: separate !important;
            border-spacing: 0 !important;
            width: max-content;
            overflow: visible !important;
            border-radius: 0 !important;
        }

        /* EXCEL TABLE */
        .excel-table {
            font-size: 12px;
        }

        .excel-table thead th {
            position: sticky;
            top: 0;
            background: #f3f4f6;
            color: #374151;
            padding: 8px 4px;
            font-size: 11px;
            z-index: 10;
            border: 1px solid #e5e7eb;
        }

        .excel-table tbody td {
            border: 1px solid #e5e7eb;
            padding: 6px 4px;
            min-width: 40px;
            text-align: center;
            background: white;
        }

        .excel-table tbody td[contenteditable="true"] {
            cursor: text;
        }

        .excel-table tbody td[contenteditable="true"]:focus {
            outline: 2px solid #C86A3C;
            background: #eff6ff;
        }

        .excel-table tbody td.filled {
            background: #d1fae5;
        }

        .excel-table tbody tr:hover td {
            background: #FDFCFA;
        }

        .excel-table tbody tr:hover td.filled {
            background: #a7f3d0;
        }

        /* STICKY TABLE HEADERS */
        .overflow-x-auto {
            max-height: 70vh;
            overflow-y: auto;
        }

        .overflow-x-auto thead {
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .overflow-x-auto thead th {
            background: #F8F4EC !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .table-container {
            max-height: 70vh;
            overflow: auto;
        }

        .table-container thead {
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .table-container thead th {
            background: #F8F4EC !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        /* Sorular table sticky fix */
        #sorularTable .sticky-col {
            position: sticky !important;
            left: 0 !important;
            z-index: 20 !important;
            background: #fff !important;
        }
        
        #sorularTable thead .sticky-col {
            background: #2B241C !important;
            z-index: 30 !important;
        }

        /* SORTABLE HEADERS */
        .sortable-header {
            cursor: pointer;
            user-select: none;
            position: relative;
            padding-right: 20px;
            transition: all 0.2s;
        }

        .sortable-header:hover {
            background: #e5e7eb;
        }

        .sort-icon {
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 10px;
            opacity: 0.6;
        }

        .sortable-header.sorted-asc .sort-icon::after,
        .sortable-header.sorted-desc .sort-icon::after {
            opacity: 1;
            color: #C86A3C;
        }

        .sortable-header.sorted-asc .sort-icon::after {
            content: '▲';
        }

        .sortable-header.sorted-desc .sort-icon::after {
            content: '▼';
        }

        .sortable-header:not(.sorted-asc):not(.sorted-desc) .sort-icon::after {
            content: '⇅';
        }

        /* SORU HIGHLIGHT */
        .soru-highlighted {
            background: #fff9e6 !important;
            border-left: 4px solid #f59e0b;
        }

        .soru-highlighted td {
            background: #fef3c7 !important;
            font-weight: 700 !important;
        }

        .soru-highlighted:hover td {
            background: #fde68a !important;
        }

        /* SORULAR TABLOSU */
        #sorularTable th {
            min-width: 180px;
            text-align: center;
            vertical-align: middle;
            white-space: normal;
            padding: 16px 12px;
        }

        #sorularTable th:first-child {
            min-width: 400px;
            text-align: left;
        }

        #sorularTable td {
            text-align: center;
            font-size: 14px;
            font-weight: 600;
            min-width: 180px;
        }

        #sorularTable td:first-child {
            text-align: left;
            min-width: 400px;
            font-weight: 400;
            padding: 12px 16px;
        }

        #sorularTable tbody tr:hover {
            background: #FDFCFA;
        }

        #sorularTable .highlight {
            background: #fef3c7 !important;
        }

        #sorularTable .highlight:hover {
            background: #fde68a !important;
        }

        /* LABELS & TAGS */
        .code-label {
            background: #C86A3C;
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            display: inline-block;
        }

        #sorularTable .code-label {
            display: inline-block;
            margin-bottom: 6px;
        }

        .anket-tag {
            display: inline-block;
            background: #C86A3C;
            color: white;
            padding: 4px 8px;
            margin: 2px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 500;
        }

        .anket-tag.gecersiz {
            background: #ef4444;
        }

        .anket-tag .remove-btn {
            margin-left: 6px;
            cursor: pointer;
            font-weight: bold;
            opacity: 0.8;
        }

        .anket-tag .remove-btn:hover {
            opacity: 1;
        }

        /* OPEN-ENDED QUESTIONS */
        .keyword-item {
            display: inline-block;
            position: relative;
            cursor: help;
            transition: all 0.3s;
        }

        .keyword-item:hover {
            color: #C86A3C;
        }

        .keyword-tooltip {
            display: none;
            position: absolute;
            background: #1f2937;
            color: white;
            padding: 10px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 1000;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            margin-bottom: 5px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .keyword-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: #1f2937;
        }

        .keyword-item:hover .keyword-tooltip {
            display: block;
        }

        .clickable-count {
            cursor: pointer;
            color: #C86A3C;
            font-weight: 600;
            transition: all 0.3s;
        }

        .clickable-count:hover {
            color: #2563eb;
            transform: scale(1.05);
        }

        /* RESPONSES CONTAINER */
        .responses-container {
            display: none;
            margin-top: 20px;
            padding: 20px;
            background: #ffffff;
            border-radius: 16px;
            animation: slideDown 0.3s;
            border: 1px solid #e5e7eb;
        }

        .responses-container.active {
            display: block;
        }

        .response-balloon {
            background: #FDFCFA;
            border-radius: 10px;
            padding: 14px 18px;
            margin: 10px 0;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            border-left: 3px solid #C86A3C;
            transition: all 0.3s;
        }

        .response-balloon:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transform: translateX(5px);
        }

        .response-header {
            font-size: 11px;
            color: #C86A3C;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .response-text {
            color: #1f2937;
            line-height: 1.6;
            font-size: 14px;
        }

        .response-empty {
            color: #9ca3af;
            font-style: italic;
        }

        .responses-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e5e7eb;
        }

        .responses-title {
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
        }

        .responses-actions {
            display: flex;
            gap: 10px;
        }

        /* BELEDIYE GENELI RAPOR STILLERI */
        #belediyeGeneliRapor {
            font-family: 'Poppins', Georgia, 'Times New Roman', serif;
        }

        #belediyeGeneliRapor h1 {
            font-size: 28px;
            font-weight: 700;
            color: #211A16;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 3px solid #211A16;
            text-align: center;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            padding: 25px;
            border-radius: 12px 12px 0 0;
            margin: -25px -25px 30px -25px;
        }

        #belediyeGeneliRapor h2 {
            font-size: 20px;
            font-weight: 600;
            color: #211A16;
            margin: 35px 0 20px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #C86A3C;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        #belediyeGeneliRapor h2::before {
            content: '';
            width: 5px;
            height: 24px;
            background: linear-gradient(180deg, #C86A3C 0%, #211A16 100%);
            border-radius: 3px;
        }

        #belediyeGeneliRapor h3 {
            font-size: 17px;
            font-weight: 600;
            color: #374151;
            margin: 25px 0 15px 0;
        }

        #belediyeGeneliRapor .indicators-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin: 20px 0;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        }

        #belediyeGeneliRapor .indicators-table thead tr {
            background: linear-gradient(135deg, #211A16 0%, #2d5a87 100%);
        }

        #belediyeGeneliRapor .indicators-table th {
            color: white;
            padding: 16px 20px;
            font-weight: 600;
            text-align: left;
            font-size: 14px;
            letter-spacing: 0.3px;
        }

        #belediyeGeneliRapor .indicators-table td {
            padding: 14px 20px;
            border-bottom: 1px solid #e5e7eb;
            font-size: 14px;
        }

        #belediyeGeneliRapor .indicators-table td.label {
            background: #f8fafc;
        }

        #belediyeGeneliRapor .indicators-table td.value {
            font-weight: 600;
            color: #211A16;
            font-size: 15px;
        }

        #belediyeGeneliRapor .indicators-table .highlight-row {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%) !important;
        }

        #belediyeGeneliRapor .indicators-table .highlight-row td {
            border-bottom: 2px solid #10b981;
        }

        #belediyeGeneliRapor .indicators-table .highlight-row td.value {
            color: #059669;
            font-size: 18px;
            font-weight: 700;
        }

        #belediyeGeneliRapor .indicators-table .label-desc {
            display: block;
            font-size: 11px;
            color: #6b7280;
            margin-top: 4px;
            font-weight: 400;
        }

        #belediyeGeneliRapor .indicators-table tbody tr:hover {
            background: #f1f5f9;
        }

        #belediyeGeneliRapor .indicators-table tbody tr:last-child td {
            border-bottom: none;
        }

        #belediyeGeneliRapor .summary-box {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 1px solid #bae6fd;
            border-left: 5px solid #0284c7;
            border-radius: 12px;
            padding: 25px 30px;
            margin: 30px 0;
            box-shadow: 0 4px 12px rgba(2, 132, 199, 0.1);
        }

        #belediyeGeneliRapor .summary-box h3 {
            color: #0369a1;
            margin-top: 0;
            font-size: 18px;
        }

        #belediyeGeneliRapor .summary-box p {
            margin: 12px 0;
            line-height: 1.7;
            color: #334155;
        }

        #belediyeGeneliRapor table:not(.indicators-table) {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin: 20px 0;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.06);
            border: 1px solid #e2e8f0;
        }

        #belediyeGeneliRapor table:not(.indicators-table) thead tr {
            background: linear-gradient(135deg, #374151 0%, #4b5563 100%);
        }

        #belediyeGeneliRapor table:not(.indicators-table) th {
            color: white;
            padding: 14px 12px;
            font-weight: 600;
            font-size: 13px;
            text-align: left;
        }

        #belediyeGeneliRapor table:not(.indicators-table) td {
            padding: 12px;
            border-bottom: 1px solid #e5e7eb;
            font-size: 13px;
            line-height: 1.5;
        }

        #belediyeGeneliRapor table:not(.indicators-table) tbody tr:nth-child(even) {
            background: #f8fafc;
        }

        #belediyeGeneliRapor table:not(.indicators-table) tbody tr:hover {
            background: #f1f5f9;
        }

        #belediyeGeneliRapor ul {
            margin: 15px 0;
            padding-left: 25px;
        }

        #belediyeGeneliRapor ul li {
            margin: 10px 0;
            line-height: 1.6;
            color: #374151;
        }

        #belediyeGeneliRapor p {
            margin: 12px 0;
            line-height: 1.7;
            color: #374151;
        }

        #belediyeGeneliRapor hr {
            margin: 40px 0;
            border: none;
            height: 2px;
            background: linear-gradient(90deg, transparent 0%, #cbd5e1 50%, transparent 100%);
        }

        #belediyeGeneliRapor strong {
            color: #211A16;
        }

        /* Mobile Responsive for Reports */
        @media (max-width: 768px) {
            #belediyeGeneliRapor {
                padding: 16px 8px;
                max-width: 100%;
            }

            #belediyeGeneliRapor h1 {
                font-size: 24px;
                margin-bottom: 16px;
            }

            #belediyeGeneliRapor h2 {
                font-size: 18px;
                padding-left: 0;
            }

            #belediyeGeneliRapor h2::before {
                display: none;
            }

            #belediyeGeneliRapor h3 {
                font-size: 15px;
            }

            #belediyeGeneliRapor .summary-box {
                padding: 16px;
            }

            #belediyeGeneliRapor table {
                font-size: 11px;
            }

            #belediyeGeneliRapor th,
            #belediyeGeneliRapor td {
                padding: 8px 6px;
            }

            #mudurlukRaporlari {
                padding: 0;
            }

            #mudurlukRaporlari table {
                font-size: 10px;
            }

            #mudurlukRaporlari th,
            #mudurlukRaporlari td {
                padding: 6px 4px;
            }

            .table-container {
                max-height: none;
                overflow-x: auto;
            }

            .stats-card {
                min-width: 120px;
                padding: 14px;
                margin: 6px 6px 6px 0;
            }

            .stats-card h3 {
                font-size: 11px;
            }

            .stats-card p {
                font-size: 22px;
            }

            .filter-bar {
                flex-wrap: wrap;
                padding: 10px;
            }

            .filter-bar select,
            .filter-bar input {
                min-width: auto;
                width: 100%;
                max-width: none;
            }

            select {
                min-width: auto;
                width: 100%;
            }
        }
    </style>
</head>

<body>
    <!-- FLOATING HAMBURGER (visible when sidebar hidden) -->
    <button class="hamburger-floating" onclick="toggleSidebar()" id="hamburgerFloating">
        <span class="material-icons-outlined">menu</span>
    </button>

    <!-- SIDEBAR OVERLAY -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

    <!-- SIDEBAR -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header" style="display: flex; align-items: flex-start; justify-content: space-between; position: relative;">
            <div class="sidebar-header-text">
                <h1 style="font-family: 'Playfair Display', serif; font-size: 24px; font-weight: 600; color: #211A16; line-height: 1.1; letter-spacing: -0.02em;">
                    Arnavutköy<br/>Belediyesi
                </h1>
                <p style="font-size: 10px; color: #7B746A; font-weight: 500; text-transform: uppercase; letter-spacing: 0.2em; margin-top: 8px;">
                    Anket Değerlendirme Sistemi
                </p>
            </div>
            <button class="hamburger-btn" onclick="toggleSidebar()" id="hamburgerBtn">
                <span class="material-icons-outlined">menu</span>
            </button>
        </div>
        <div class="sidebar-menu" id="sidebarMenu"></div>
    </div>

    <!-- MAIN CONTENT -->
    <div class="main-content">
        <div class="content-header">
            <h2 id="pageTitle">Veri Girişi</h2>
        </div>
        <div class="content-body" id="contentBody"></div>
    </div>

    <script>
        'use strict';

        // Sidebar Toggle Function
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            const floatingBtn = document.getElementById('hamburgerFloating');
            const isMobile = window.innerWidth <= 768;

            if (isMobile) {
                sidebar.classList.toggle('open');
                overlay.classList.toggle('active');
            } else {
                sidebar.classList.toggle('desktop-hidden');
                floatingBtn.classList.toggle('visible');
            }
        }

        // Close sidebar only (for mobile navigation)
        function closeSidebarIfMobile() {
            if (window.innerWidth <= 768) {
                const sidebar = document.getElementById('sidebar');
                const overlay = document.getElementById('sidebarOverlay');
                sidebar.classList.remove('open');
                overlay.classList.remove('active');
            }
        }

        const CONFIG = {
            QUESTIONS_PER_SURVEY: 49,
            SOCIAL_MEDIA_COLUMNS: 8,
            MAX_TABLE_ROWS_INITIAL: 1600,
            LIKERT_SCALE_MAX: 4,
            VALIDATION_CONTROL_QUESTION: 44,
            CONSISTENCY_CHECK_QUESTIONS: [24, 43],
            CONSISTENCY_THRESHOLD: 2,
            TOP_KEYWORDS: 5,
            MESSAGE_TIMEOUT: 5000
        };

        const KELIME_GRUPLARI = {
            'Yönetici': ['amir', 'yönetici', 'müdür', 'şef', 'başkan', 'amirlik'],
            'Yemek': ['yemek', 'yemekhane', 'kahvaltı', 'öğle', 'akşam', 'menü', 'mutfak'],
            'Temizlik': ['temizlik', 'hijyen', 'pis', 'kirli', 'düzen', 'tertip'],
            'Maaş': ['maaş', 'ücret', 'ödeme', 'para', 'prim', 'ikramiye', 'hak'],
            'Eğitim': ['eğitim', 'kurs', 'seminer', 'gelişim', 'öğrenme', 'ders'],
            'Servis': ['servis', 'taşıma', 'ulaşım', 'araç', 'otobüs', 'minibüs'],
            'İletişim': ['iletişim', 'bilgi', 'haberleşme', 'duyuru', 'haber'],
            'Fiziksel Alan': ['masa', 'sandalye', 'oda', 'alan', 'mekan', 'ofis'],
            'İklim': ['sıcak', 'soğuk', 'klima', 'ısıtma', 'soğutma', 'havalandırma'],
            'Teknoloji': ['bilgisayar', 'yazılım', 'sistem', 'program', 'internet'],
            'İş Yükü': ['iş', 'yük', 'fazla', 'mesai', 'zaman', 'saat'],
            'Ekip': ['ekip', 'takım', 'birlik', 'dayanışma', 'işbirliği'],
            'Sağlık': ['sağlık', 'hastalık', 'doktor', 'revir'],
            'Güvenlik': ['güvenlik', 'koruma', 'can'],
            'Araç-Gereç': ['malzeme', 'ekipman', 'alet', 'donanım'],
            'Sosyal': ['sosyal', 'aktivite', 'etkinlik', 'tesis'],
            'Tuvalet': ['tuvalet', 'wc', 'banyo'],
            'Çay Ocağı': ['çay', 'ocak', 'kahve'],
            'Park': ['park', 'otopark'],
            'İzin': ['izin', 'tatil', 'dinlenme', 'rapor']
        };

        const STOPWORDS = new Set([
            've', 'veya', 'ile', 'için', 'bir', 'bu', 'şu', 'o', 'ne', 'nasıl',
            'neden', 'gibi', 'göre', 'kadar', 'daha', 'çok', 'az', 'ben', 'sen',
            'biz', 'siz', 'onlar', 'var', 'yok', 'mi', 'mu', 'mı', 'mü', 'da',
            'de', 'ta', 'te', 'ama', 'fakat', 'ancak', 'ya', 'yahut', 'ki',
            'diye', 'şey', 'şeyler', 'hem', 'hep', 'her', 'hiç', 'bazı', 'birçok',
            'olarak', 'olmak', 'olan', 'olduğu', 'ise', 'işte', 'artık', 'sadece',
            'düşünüyorum', 'istiyorum', 'olmalı', 'gerekli', 'memnun', 'iyi', 'kötü',
            'soru', 'cevap', 'anket', 'evet', 'hayır'
        ]);

        const SENTIMENT_WORDS = {
            positive: [
                'memnun', 'iyi', 'güzel', 'harika', 'mükemmel', 'başarılı', 'teşekkür',
                'kaliteli', 'yeterli', 'pratik', 'hızlı', 'güçlü', 'uyumlu', 'rahat',
                'düzenli', 'temiz', 'hijyenik', 'lezzetli', 'taze', 'çeşitli',
                'destekleyici', 'yardımcı', 'saygılı', 'adil', 'şeffaf', 'profesyonel',
                'verimli', 'etkili', 'kolay', 'anlaşılır', 'net', 'pozitif', 'mutlu',
                'keyifli', 'konforlu', 'modern', 'yenilikçi', 'gelişmiş', 'uygun'
            ],
            negative: [
                'kötü', 'yetersiz', 'sorun', 'problem', 'eksik', 'pis', 'kirli',
                'düzensiz', 'karışık', 'belirsiz', 'zor', 'yavaş', 'eski', 'bozuk',
                'arızalı', 'kalitesiz', 'lezzetsiz', 'bayat', 'az', 'dar', 'sıkışık',
                'gürültülü', 'rahatsız', 'stresli', 'gergin', 'yorucu', 'zorlu',
                'adaletsiz', 'ayrımcı', 'saygısız', 'ilgisiz', 'duyarsız', 'geç',
                'yok', 'hiç', 'asla', 'kesinlikle', 'çok fazla', 'çok az', 'berbat',
                'rezalet', 'felaket', 'soğuk', 'sıcak', 'nemli', 'havasız', 'karanlık'
            ]
        };

        const MUDURLUKLER = {
            101: {name: 'AFET İŞLERİ MÜDÜRLÜĞÜ', personel: 12},
            102: {name: 'AKILLI ULAŞIM SİSTEMLERİ MÜDÜRLÜĞÜ', personel: 19},
            103: {name: 'BASIN VE YAYIN MÜDÜRLÜĞÜ', personel: 21},
            104: {name: 'DESTEK HİZMETLERİ MÜDÜRLÜĞÜ', personel: 366},
            105: {name: 'EMLAK VE İSTİMLAK MÜDÜRLÜĞÜ', personel: 26},
            106: {name: 'FEN İŞLERİ MÜDÜRLÜĞÜ', personel: 120},
            107: {name: 'GELİRLER MÜDÜRLÜĞÜ', personel: 39},
            108: {name: 'GENÇLİK VE SPOR HİZMETLERİ MÜDÜRLÜĞÜ', personel: 131},
            109: {name: 'HALKLA İLİŞKİLER MÜDÜRLÜĞÜ', personel: 30},
            110: {name: 'HUKUK İŞLERİ MÜDÜRLÜĞÜ', personel: 12},
            111: {name: 'İKLİM DEĞİŞİKLİĞİ VE SIFIR ATIK MÜDÜRLÜĞÜ', personel: 24},
            112: {name: 'İMAR VE ŞEHİRCİLİK MÜDÜRLÜĞÜ', personel: 47},
            113: {name: 'İNOVASYON VE TEKNOLOJİ MÜDÜRLÜĞÜ', personel: 41},
            114: {name: 'İNSAN KAYNAKLARI VE EĞİTİM MÜDÜRLÜĞÜ', personel: 13},
            115: {name: 'İŞLETME VE İŞTİRAKLER MÜDÜRLÜĞÜ', personel: 18},
            116: {name: 'KOORDİNASYON İŞLERİ MÜDÜRLÜĞÜ', personel: 7},
            117: {name: 'KÜLTÜR İŞLERİ MÜDÜRLÜĞÜ', personel: 87},
            118: {name: 'MALİ HİZMETLER MÜDÜRLÜĞÜ', personel: 9},
            119: {name: 'MUHTARLIK İŞLERİ MÜDÜRLÜĞÜ', personel: 6},
            120: {name: 'ÖZEL KALEM MÜDÜRLÜĞÜ', personel: 16},
            121: {name: 'PARK VE BAHÇELER MÜDÜRLÜĞÜ', personel: 85},
            122: {name: 'PLAN VE PROJE MÜDÜRLÜĞÜ', personel: 17},
            123: {name: 'RUHSAT VE DENETİM MÜDÜRLÜĞÜ', personel: 12},
            124: {name: 'SOSYAL DESTEK HİZMETLERİ MÜDÜRLÜĞÜ', personel: 97},
            125: {name: 'STRATEJİ GELİŞTİRME MÜDÜRLÜĞÜ', personel: 10},
            126: {name: 'TEMİZLİK İŞLERİ MÜDÜRLÜĞÜ', personel: 578},
            127: {name: 'VETERİNER İŞLERİ MÜDÜRLÜĞÜ', personel: 38},
            1288: {name: 'YAPI KONTROL MÜDÜRLÜĞÜ', personel: 37},
            129: {name: 'YAZI İŞLERİ MÜDÜRLÜĞÜ', personel: 37},
            130: {name: 'ZABITA MÜDÜRLÜĞÜ', personel: 134}
        };

        const SORULAR = [
            "Yaptığım iş, yetenek ve becerilerimle uyumludur.",
            "Bu işi seçtiğim için mutluyum.",
            "Yaptığım işi anlamlı buluyorum.",
            "Görev tanımım ve sorumluluklarım açıkça belirlenmiştir.",
            "Birimimde hangi işlerin kimin sorumluluğunda olduğu nettir.",
            "Yetki ve karar sınırlarım konusunda belirsizlik yaşamam.",
            "Görev ve talimatlar birbiriyle uyumludur.",
            "İşim gereği duygusal olarak zorlayıcı durumlarla oldukça sık karşılaşırım.",
            "Gün içinde yetiştirmem gereken görevler çoğu zaman fazla olur.",
            "Vatandaş/başvuru talep yoğunluğu işim gereği fazladır.",
            "İşimi tamamlamak için sık sık zaman sıkışıklığı yaşarım.",
            "İhtiyaç duyduğumda amirime kolaylıkla ulaşabilirim.",
            "Amirimin verdiği geri bildirimler gelişimime yardımcı olur.",
            "Sorun yaşadığımda amirim destek olmak için çaba gösterir.",
            "Kendi çalışmamı etkileyen kararlara katılma ve fikirlerimi söyleme fırsatı buluyorum.",
            "Amirim çalışanlara eşit yaklaşır, ayrımcılık yapmaz.",
            "Amirim bana karşı saygılıdır.",
            "İş arkadaşlarımla uyum içinde çalışırım.",
            "Ekibimizde dayanışma güçlüdür.",
            "Bilgi ve deneyim paylaşımı yaygındır.",
            "İş arkadaşlarımın teknik/sosyal desteği işimi kolaylaştırır.",
            "Anlaşmazlıkları iş arkadaşlarımızla kendi aramızda çözeriz.",
            "Yaptığımız öneri ve geri bildirimlerin sonuçları hakkında bilgilendiriliriz.",
            "Belediyede alınan karar ve gelişmelerden iletişim kanalları üzerinden haberdar edilirim.",
            "Bu kurumda çalışmaktan genel olarak memnunum.",
            "Çalışma alanlarımın temizliği yeterlidir.",
            "Isıtma/soğutma (iklimlendirme) sistemleri yeterlidir.",
            "Bireysel çalışma alanım (masa, sandalye, priz vb.) işimi rahat yapmama elverişlidir.",
            "Ortak alanlar (çay ocağı, dinlenme alanı, tuvaletler vb.) yeterlidir.",
            "Yemekhane/yemek hizmeti kalitesinden memnunum.",
            "İş sağlığı ve güvenliği (İSG) uygulamaları düzenli ve yeterlidir.",
            "Servis (ulaşım) hizmeti kalitesi yeterlidir.",
            "Sağlanan teknoloji altyapısı yeterlidir.",
            "Piyasa koşullarıyla kıyaslandığında verilen ücretler makuldür.",
            "İşim aracılığıyla topluma/kamuya hizmet etmekten gurur duyuyorum.",
            "Topluma gerçekten katkı sunmak isteyen birine, kamu kurumlarında çalışmayı tavsiye ederim.",
            "Yaptığım işin toplum için anlamlı ve faydalı olduğunu düşünüyorum.",
            "Yetkinlik Bazlı Performans değerlendirme kriterleri nettir.",
            "Yetkinlik Bazlı Performans değerlendirme kriterleri adildir.",
            "Performansım düzenli aralıklarla değerlendirilir.",
            "Değerlendirme sonrasında yapıcı geri bildirim alırım.",
            "Kurumda yapılan eğitim faaliyetlerini yeterli buluyorum.",
            "Yapılan eğitimlerin kişisel ve mesleki gelişimime katkısı olduğunu düşünüyorum.",
            "Bu kurumda çalışmaktan genel olarak memnunum.",
            "Dikkat kontrol sorusu (3 olmalı)",
            "Son 2 hafta içinde, zevk aldığım şeylere karşı keyif alamadığım günler çok oldu.",
            "Son 2 hafta içinde, kendimi sık sık üzgün, çökkün veya umutsuz hissettim.",
            "Son 2 haftada, sık sık gergin veya kaygılı hissettim.",
            "Son 2 haftada, endişelerimi kontrol etmekte zorlandığım günler çok oldu."
        ];

        const THEME_QUESTIONS = {
            calismaKosullari: [25, 26, 27, 28, 29, 30, 31, 32, 33],
            yoneticilerleIliskiler: [11, 12, 13, 14, 15, 16],
            calismaArkadaslari: [17, 18, 19, 20, 21],
            kamuHizmetiMotivasyonu: [34, 35, 36],
            gorevRolNetligi: [3, 4, 5, 6],
            isKisiUyumu: [0, 1, 2],
            hizmetTalepYogunlugu: [7, 8, 9, 10],
            kurumIciIletisim: [22, 23],
            yetkinlikPerformans: [37, 38, 39, 40],
            egitimGelisim: [41, 42]
        };

        const THEME_INFO = {
            calismaKosullari: {
                title: 'Çalışma Koşulları',
                icon: '🏢',
                keywords: ['temizlik', 'masa', 'oda', 'yemek', 'servis', 'klima', 'ısıtma', 'teknoloji', 'maaş', 'ücret'],
                description: 'Fiziksel çalışma ortamı, hijyen standartları, yemek-ulaşım hizmetleri, teknolojik altyapı ve ücret adaleti'
            },
            yoneticilerleIliskiler: {
                title: 'Yöneticilerle İlişkiler',
                icon: '👔',
                keywords: ['amir', 'yönetici', 'müdür', 'destek', 'geri bildirim', 'saygı'],
                description: 'Amirler ve müdürlere ulaşılabilirlik, yönetici desteği, gelişim amaçlı geri bildirim, karar süreçlerine katılım ve yönetici adaleti'
            },
            calismaArkadaslari: {
                title: 'Çalışma Arkadaşları',
                icon: '👥',
                keywords: ['ekip', 'takım', 'arkadaş', 'dayanışma', 'işbirliği', 'paylaşım'],
                description: 'Ekip içi uyum, çalışma arkadaşları arası dayanışma, bilgi paylaşımı kültürü ve sosyal destek düzeyi'
            },
            kamuHizmetiMotivasyonu: {
                title: 'Kamu Hizmeti Motivasyonu',
                icon: '🎖️',
                keywords: ['toplum', 'hizmet', 'kamu', 'gurur', 'fayda', 'katkı'],
                description: 'Kamusal misyon bilinci, toplumsal fayda odaklılık, kamu hizmeti değeri ve kurumsal aidiyet hissi'
            },
            gorevRolNetligi: {
                title: 'Görev ve Rol Netliği',
                icon: '📋',
                keywords: ['görev', 'sorumluluk', 'yetki', 'talimat', 'belirsiz', 'net'],
                description: 'Görev tanımlarının açıklığı, sorumluluk alanlarının netliği, yetki-karar sınırları ve talimat tutarlılığı'
            },
            isKisiUyumu: {
                title: 'İş-Kişi Uyumu',
                icon: '🎯',
                keywords: ['iş', 'uyum', 'yetenek', 'beceri', 'mutlu', 'anlamlı'],
                description: 'Çalışanların mevcut görevlerinin yetenek ve becerilerine uygunluğu, iş tatmini ve işin anlamlılığı algısı'
            },
            hizmetTalepYogunlugu: {
                title: 'Hizmet ve İş Yükü/Stresi',
                icon: '⚡',
                keywords: ['yoğunluk', 'iş yükü', 'zaman', 'yetiş', 'talep', 'vatandaş'],
                description: 'İş yoğunluğu, zaman baskısı, duygusal emek gereksinimi ve hizmet talep düzeyi'
            },
            kurumIciIletisim: {
                title: 'Kurum İçi İletişim',
                icon: '💬',
                keywords: ['iletişim', 'bilgi', 'duyuru', 'haber', 'karar', 'gelişme'],
                description: 'Kurumsal bilgi akışı, geri bildirim mekanizmaları, şeffaflık ve çalışanın karar süreçlerinden haberdar olma düzeyi'
            },
            yetkinlikPerformans: {
                title: 'Yetkinlik ve Performans',
                icon: '📊',
                keywords: ['performans', 'değerlendirme', 'kriter', 'adil', 'geri bildirim'],
                description: 'Performans değerlendirme sisteminin şeffaflığı, kriterlerin netliği, süreç adaleti ve gelişimsel geri bildirim'
            },
            egitimGelisim: {
                title: 'Eğitim ve Gelişim',
                icon: '📚',
                keywords: ['eğitim', 'kurs', 'seminer', 'gelişim', 'öğrenme'],
                description: 'Kurumsal eğitim programlarının yeterliliği, mesleki gelişim fırsatları ve eğitimlerin etkililiği'
            }
        };

        const MENU_ITEMS = [
            {
                category: 'RAPOR', items: [
                    {id: 'belediye-geneli', icon: 'apartment', title: 'Belediye Geneli', iconColor: '#C86A3C'},
                    {id: 'mudurluk-raporlari', icon: 'description', title: 'Müdürlük Raporları', iconColor: '#C86A3C'}
                ]
            },
            {
                category: 'Detaylı Tablolar (tüm müdürlükler)', items: [
                    {id: 'genel-skorlar', icon: 'dashboard', title: 'Genel Skorlar', iconColor: '#3B82F6'},
                    {id: 'temalar', icon: 'insights', title: 'Konular Üzerinden Analiz', iconColor: '#8B5CF6'},
                    {id: 'sosyal-medya', icon: 'groups', title: 'Sosyal Medya Takip Oranları', iconColor: '#06B6D4'},
                    {id: 'ruh-sagligi', icon: 'stethoscope', title: 'Ruh Sağlığı Taraması', iconColor: '#EF4444', useSymbols: true},
                    {id: 'sorular', icon: 'analytics', title: 'Sorular Üzerinden Analiz', iconColor: '#F59E0B'},
                    {id: 'mudurluk-karsilastir', icon: 'compare_arrows', title: 'Müdürlük Karşılaştırma', iconColor: '#10B981'},
                    {id: 'mudurluk-sec', icon: 'check_circle_outline', title: 'Müdürlük Detay Analizi', iconColor: '#6366F1'},
                    {id: 'acik-uclu', icon: 'rule', title: 'Açık Uçlu Cevaplar', iconColor: '#EC4899'}
                ]
            },
            {
                category: 'VERİ PANELİ', items: [
                    {id: 'veri-girisi', icon: 'input', title: 'Veri Girişi', iconColor: '#22C55E'},
                    {id: 'girilen-anketler', icon: 'list_alt', title: 'Girilen Anketler', iconColor: '#64748B'}
                ]
            },
            {
                category: 'AYARLAR', items: [
                    {id: 'giris-loglari', icon: 'history', title: 'Giriş Logları', iconColor: '#94A3B8'}
                ]
            },
            {
                category: 'PSİKOLOJİ MODÜLÜ', items: [
                    {id: 'psikoloji-modulu', icon: 'psychology', title: 'Psikoloji Modülüne Git', iconColor: '#8B5CF6', useSymbols: true, externalLink: '/psikoloji/'}
                ]
            }
        ];

        const MUDURLUK_EMOJIS = {
            'veteriner_isleri': '🐾',
            'gelirler': '🧾',
            'imar_sehircilik': '🏗️',
            'iklim_degisikligi': '♻️',
            'emlak_istimlak': '🏠',
            'fen_isleri': '🛠️',
            'yapi_kontrol': '🏗️',
            'zabita': '👮',
            'sosyal_destek': '❤️',
            'temizlik_isleri': '🧹',
            'halkla_iliskiler': '📞',
            'park_bahceler': '🌳',
            'plan_proje': '📍',
            'hukuk_isleri': '⚖️',
            'isletme_istirakler': '🏭',
            'yazi_isleri': '✍️',
            'mali_hizmetler': '📈',
            'kultur_isleri': '🎨',
            'genclik_spor': '⚽',
            'basin_yayin': '🎙️',
            'ozel_kalem': '⭐',
            'muhtarlik': '📩',
            'akilli_ulasim': '🚌',
            'inovasyon': '💡',
            'destek_hizmetleri': '🔧',
            'insan_kaynaklari': '👥',
            'ruhsat_denetim': '📝',
            'strateji_gelistirme': '📊',
            'afet_isleri': '🚨',
            'koordinasyon': '🔗'
        };
        
        // Müdürlük kodu -> emoji eşleştirmesi
        const MUDURLUK_KOD_EMOJI = {
            101: '🚨', 102: '🚌', 103: '🎙️', 104: '🔧', 105: '🏠',
            106: '🛠️', 107: '🧾', 108: '⚽', 109: '📞', 110: '⚖️',
            111: '♻️', 112: '🏗️', 113: '💡', 114: '👥', 115: '🏭',
            116: '🔗', 117: '🎨', 118: '📈', 119: '📩', 120: '⭐',
            121: '🌳', 122: '📍', 123: '📝', 124: '❤️', 125: '📊',
            126: '🧹', 127: '🐾', 1288: '🏗️', 129: '✍️', 130: '👮'
        };

        const state = {
            allSurveys: [],
            processedData: null,
            currentOpenResponses: null,
            charts: {}
        };

        const utils = {
            formatPercentage: (value) => {
                const num = parseFloat(value);
                return isNaN(num) ? '0' : num.toFixed(1);
            },
            
            // Ters kodlanacak sorular (psikoloji soruları - düşük = iyi)
            REVERSE_CODED_QUESTIONS: [45, 46, 47, 48],
            
            getBelowAvgClass: (value, baseline, reverse = false) => {
                if (baseline === null || baseline === undefined) return '';
                const val = parseFloat(value) || 0;
                const base = parseFloat(baseline) || 0;
                if (base <= 0) return '';
                
                if (reverse) {
                    // Ters kodlama: yüksek değer = kötü
                    if (val <= base) return '';
                    const diff = ((val - base) / base) * 100;
                    if (isNaN(diff) || !isFinite(diff)) return '';
                    if (diff > 20) return 'below-avg-severe';
                    if (diff > 10) return 'below-avg-moderate';
                    return 'below-avg-mild';
                } else {
                    // Normal kodlama: düşük değer = kötü
                    if (val >= base) return '';
                    const diff = ((base - val) / base) * 100;
                    if (isNaN(diff) || !isFinite(diff)) return '';
                    if (diff > 20) return 'below-avg-severe';
                    if (diff > 10) return 'below-avg-moderate';
                    return 'below-avg-mild';
                }
            },
            
            getBelowAvgTooltip: (value, baseline, reverse = false) => {
                if (baseline === null || baseline === undefined) return '';
                const val = parseFloat(value) || 0;
                const base = parseFloat(baseline) || 0;
                if (base <= 0) return '';
                
                if (reverse) {
                    // Ters kodlama: yüksek değer = kötü
                    if (val <= base) return '';
                    const diff = ((val - base) / base) * 100;
                    if (isNaN(diff) || !isFinite(diff)) return '';
                    return `Belediye ortalamasının %${diff.toFixed(1)} üstünde (risk)`;
                } else {
                    // Normal kodlama: düşük değer = kötü
                    if (val >= base) return '';
                    const diff = ((base - val) / base) * 100;
                    if (isNaN(diff) || !isFinite(diff)) return '';
                    return `Belediye ortalamasının %${diff.toFixed(1)} altında`;
                }
            },

            calculateAverage: (surveys, questionIndices) => {
                const {total, count} = surveys.reduce((acc, survey) => {
                    questionIndices.forEach(idx => {
                        const val = survey.cevaplar[idx];
                        if (val !== null && val !== undefined && !isNaN(val)) {
                            acc.total += val;
                            acc.count++;
                        }
                    });
                    return acc;
                }, {total: 0, count: 0});

                if (count === 0) return '0';
                const average = (total / count / CONFIG.LIKERT_SCALE_MAX * 100);
                return utils.formatPercentage(average);
            },

            calculateSocialMedia: (surveys) => {
                const total = surveys.length;
                if (total === 0) return utils.getEmptySocialMediaData();

                const aggregated = surveys.reduce((acc, survey) => {
                    if (!survey.sosyalMedya) return acc;

                    Object.keys(acc.detay).forEach(key => {
                        acc.detay[key] += survey.sosyalMedya[key] || 0;
                    });

                    return acc;
                }, {
                    detay: {
                        instagram_belediye: 0, instagram_baskan: 0,
                        twitter_belediye: 0, twitter_baskan: 0,
                        facebook_belediye: 0, facebook_baskan: 0,
                        nextsosyal_belediye: 0, nextsosyal_baskan: 0
                    }
                });

                const belediye = ['instagram_belediye', 'twitter_belediye', 'facebook_belediye', 'nextsosyal_belediye']
                    .reduce((sum, key) => sum + aggregated.detay[key], 0);

                const baskan = ['instagram_baskan', 'twitter_baskan', 'facebook_baskan', 'nextsosyal_baskan']
                    .reduce((sum, key) => sum + aggregated.detay[key], 0);

                return {
                    belediye: utils.formatPercentage(belediye / (total * 4) * 100),
                    baskan: utils.formatPercentage(baskan / (total * 4) * 100),
                    toplam: utils.formatPercentage((belediye + baskan) / (total * 8) * 100),
                    detay: Object.fromEntries(
                        Object.entries(aggregated.detay).map(([k, v]) =>
                            [k, utils.formatPercentage(v / total * 100)]
                        )
                    )
                };
            },

            getEmptySocialMediaData: () => ({
                belediye: '0', baskan: '0', toplam: '0',
                detay: {
                    instagram_belediye: '0', instagram_baskan: '0',
                    twitter_belediye: '0', twitter_baskan: '0',
                    facebook_belediye: '0', facebook_baskan: '0',
                    nextsosyal_belediye: '0', nextsosyal_baskan: '0'
                }
            }),

            showMessage: (message, type = 'success') => {
                const statusDiv = document.getElementById('processStatus');
                if (!statusDiv) return;

                const colors = {
                    success: {bg: '#d4edda', text: '#155724', border: '#c3e6cb'},
                    warning: {bg: '#fff3cd', text: '#856404', border: '#ffeaa7'},
                    error: {bg: '#f8d7da', text: '#721c24', border: '#f5c6cb'}
                };

                const color = colors[type] || colors.success;
                statusDiv.innerHTML = `
                    <div style="background: ${color.bg}; border: 1px solid ${color.border}; 
                                color: ${color.text}; padding: 15px; border-radius: 8px; animation: slideDown 0.3s;">
                        ${message}
                    </div>
                `;

                setTimeout(() => statusDiv.innerHTML = '', CONFIG.MESSAGE_TIMEOUT);
            },

            parseSocialMediaFromText: (text) => {
                const sm = text.toLowerCase();
                const platforms = [
                    {key: 'instagram_belediye', conditions: ['instagram', 'arnavutkoybelediyesi']},
                    {key: 'instagram_baskan', conditions: ['instagram', 'mcandaroglutr']},
                    {key: 'twitter_belediye', conditions: ['twitter', 'x:', 'arnavutkoy']},
                    {key: 'twitter_baskan', conditions: ['twitter', 'x:', 'mcandaroglutr']},
                    {key: 'facebook_belediye', conditions: ['facebook', 'arnavutkoybelediyesi']},
                    {key: 'facebook_baskan', conditions: ['facebook', 'mcandaroglutr']},
                    {key: 'nextsosyal_belediye', conditions: ['nextsosyal', 'arnavutkoybelediyesi']},
                    {key: 'nextsosyal_baskan', conditions: ['nextsosyal', 'mustafa']}
                ];

                return platforms.reduce((acc, {key, conditions}) => {
                    acc[key] = conditions.every(cond => sm.includes(cond)) ? 1 : 0;
                    return acc;
                }, {});
            },

            parseTsvRow: (line) => {
                const cells = [];
                let current = '';
                let inQuotes = false;

                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    const nextChar = line[i + 1];

                    if (char === '"') {
                        if (inQuotes && nextChar === '"') {
                            current += '"';
                            i++;
                        } else {
                            inQuotes = !inQuotes;
                        }
                    } else if (char === '\t' && !inQuotes) {
                        cells.push(current);
                        current = '';
                    } else {
                        current += char;
                    }
                }

                cells.push(current);
                return cells;
            },

            parseClipboardTsv: (text) => {
                const rows = [];
                let current = '';
                let inQuotes = false;

                for (let i = 0; i < text.length; i++) {
                    const char = text[i];
                    const nextChar = text[i + 1];

                    if (char === '"') {
                        if (inQuotes && nextChar === '"') {
                            current += '"';
                            i++;
                        } else {
                            inQuotes = !inQuotes;
                        }
                    } else if (char === '\n' && !inQuotes) {
                        if (current.trim()) {
                            rows.push(utils.parseTsvRow(current));
                        }
                        current = '';
                    } else if (char === '\r') {
                        continue;
                    } else {
                        current += char;
                    }
                }

                if (current.trim()) {
                    rows.push(utils.parseTsvRow(current));
                }

                return rows;
            },

            stemWord: (word) => {
                const suffixes = ['lik', 'lük', 'lık', 'luk', 'ler', 'lar', 'im', 'ım', 'um', 'üm',
                    'ye', 'ya', 'den', 'dan', 'ten', 'tan', 'in', 'ın', 'un', 'ün'];

                for (const suffix of suffixes) {
                    if (word.endsWith(suffix) && word.length > suffix.length + 2) {
                        return word.slice(0, -suffix.length);
                    }
                }
                return word;
            },

            cleanWord: (word) => word.toLowerCase().replace(/[.,!?;:()"""']/g, '').trim(),

            extractKeywords: (text) => {
                if (!text || typeof text !== 'string') return [];

                return text.split(/\s+/)
                    .map(w => utils.cleanWord(w))
                    .filter(w => w.length >= 3)
                    .map(w => utils.stemWord(w))
                    .filter(w => !STOPWORDS.has(w));
            },

            analyzeKeywords: (surveys) => {
                const wordFreq = {};
                const groupFreq = {};

                surveys.forEach(survey => {
                    utils.extractKeywords(survey.acikUclu || '').forEach(word => {
                        wordFreq[word] = (wordFreq[word] || 0) + 1;
                    });
                });

                Object.entries(KELIME_GRUPLARI).forEach(([groupName, keywords]) => {
                    const groupDetails = {};
                    let groupCount = 0;

                    keywords.forEach(keyword => {
                        const stemmed = utils.stemWord(keyword);
                        if (wordFreq[stemmed]) {
                            groupCount += wordFreq[stemmed];
                            groupDetails[keyword] = wordFreq[stemmed];
                            delete wordFreq[stemmed];
                        }
                    });

                    if (groupCount > 0) {
                        groupFreq[groupName] = {count: groupCount, isGroup: true, details: groupDetails};
                    }
                });

                Object.entries(wordFreq).forEach(([word, count]) => {
                    groupFreq[word] = {count, isGroup: false};
                });

                return Object.entries(groupFreq)
                    .sort(([, a], [, b]) => b.count - a.count)
                    .slice(0, CONFIG.TOP_KEYWORDS)
                    .map(([name, data]) => ({
                        name,
                        count: data.count,
                        isGroup: data.isGroup,
                        details: data.details || {}
                    }));
            },

            analyzeThemeKeywords: (surveys, themeKeywords) => {
                const wordFreq = {};

                surveys.forEach(survey => {
                    const text = survey.acikUclu || '';
                    const words = utils.extractKeywords(text);

                    words.forEach(word => {
                        if (themeKeywords.some(kw => utils.stemWord(kw).includes(word) || word.includes(utils.stemWord(kw)))) {
                            wordFreq[word] = (wordFreq[word] || 0) + 1;
                        }
                    });
                });

                return Object.entries(wordFreq)
                    .sort(([, a], [, b]) => b - a)
                    .slice(0, 5)
                    .map(([word, count]) => ({word, count}));
            },

            calculateThemeSentiment: (surveys, themeKeywords) => {
                let positive = 0;
                let negative = 0;
                let total = 0;

                surveys.forEach(survey => {
                    const text = (survey.acikUclu || '').toLowerCase();
                    const hasThemeWord = themeKeywords.some(kw => text.includes(kw.toLowerCase()));

                    if (hasThemeWord) {
                        total++;
                        const words = text.split(/\s+/);

                        words.forEach(word => {
                            if (SENTIMENT_WORDS.positive.some(pw => word.includes(pw))) positive++;
                            if (SENTIMENT_WORDS.negative.some(nw => word.includes(nw))) negative++;
                        });
                    }
                });

                if (total === 0) return {positive: 0, negative: 0, neutral: 0};

                const posPercent = positive > 0 ? Math.round((positive / (positive + negative)) * 100) : 0;
                const negPercent = negative > 0 ? Math.round((negative / (positive + negative)) * 100) : 0;

                return {
                    positive: posPercent,
                    negative: negPercent,
                    neutral: 100 - posPercent - negPercent,
                    mentionCount: total
                };
            },

            getGradientColor: (value, baseline) => {
                const val = parseFloat(value) || 0;
                const base = parseFloat(baseline) || 0;
                const diff = val - base;

                if (Math.abs(diff) < 0.5) {
                    return 'background: white;';
                }

                if (diff > 0) {
                    const intensity = Math.min(Math.abs(diff) / 15, 1);
                    const green = Math.floor(220 - (intensity * 100));
                    const opacity = 0.3 + (intensity * 0.5);
                    return `background: rgba(34, ${green}, 34, ${opacity});`;
                } else {
                    const intensity = Math.min(Math.abs(diff) / 15, 1);
                    const red = Math.floor(220 - (intensity * 60));
                    const opacity = 0.2 + (intensity * 0.5);
                    return `background: rgba(${red}, 100, 100, ${opacity});`;
                }
            }
        };

        const dataProcessor = {
            validateSurvey: (survey) => {
                const q25 = survey.cevaplar[24];
                const q44 = survey.cevaplar[43];
                const q45 = survey.cevaplar[44];

                if (q45 === null || q45 !== 3) return false;

                if (q25 === null || q44 === null) return false;

                if (Math.abs(q25 - q44) >= CONFIG.CONSISTENCY_THRESHOLD) return false;

                return true;
            },

            analyzeMudurluk: (mudurlukData) => {
                const {gecerliAnketler} = mudurlukData;

                if (gecerliAnketler.length === 0) {
                    return dataProcessor.getEmptyMudurlukData();
                }

                const workloadQuestions = [7, 8, 9, 10];
                const supportQuestions = [0, 1, 2, 3, 4, 5, 6, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23,
                    25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42];

                const isYuku = utils.calculateAverage(gecerliAnketler, workloadQuestions);
                const kurumDestegi = utils.calculateAverage(gecerliAnketler, supportQuestions);

                return {
                    genelMemnuniyet: utils.calculateAverage(gecerliAnketler, [24]),
                    isYuku,
                    kurumDestegi,
                    denge: utils.formatPercentage(parseFloat(kurumDestegi) - parseFloat(isYuku)),
                    temalar: dataProcessor.calculateThemes(gecerliAnketler),
                    ruhSagligi: utils.calculateAverage(gecerliAnketler, [45, 46, 47, 48]),
                    ruhSagligiDetay: {
                        keyifAlamama: utils.calculateAverage(gecerliAnketler, [45]),
                        uzgunCokkun: utils.calculateAverage(gecerliAnketler, [46]),
                        gerginKaygili: utils.calculateAverage(gecerliAnketler, [47]),
                        endiseKontrol: utils.calculateAverage(gecerliAnketler, [48])
                    },
                    sigaraOrani: dataProcessor.calculateSmokingRate(gecerliAnketler),
                    sosyalMedya: utils.calculateSocialMedia(gecerliAnketler),
                    soruOrtalamalar: dataProcessor.calculateQuestionAverages(gecerliAnketler),
                    acikUcluKeywords: utils.analyzeKeywords(gecerliAnketler)
                };
            },

            calculateThemes: (surveys) =>
                Object.fromEntries(
                    Object.entries(THEME_QUESTIONS).map(([key, questions]) =>
                        [key, utils.calculateAverage(surveys, questions)]
                    )
                ),

            calculateSmokingRate: (surveys) => {
                const smokers = surveys.filter(s =>
                    s.sigara && ['evet', 'yes'].includes(s.sigara.toLowerCase())
                ).length;
                return utils.formatPercentage(smokers / surveys.length * 100);
            },

            calculateQuestionAverages: (surveys) =>
                Array.from({length: CONFIG.QUESTIONS_PER_SURVEY}, (_, i) =>
                    utils.calculateAverage(surveys, [i])
                ),

            getEmptyMudurlukData: () => ({
                genelMemnuniyet: '0',
                isYuku: '0',
                kurumDestegi: '0',
                denge: '0',
                temalar: {},
                ruhSagligi: '0',
                ruhSagligiDetay: {},
                sigaraOrani: '0',
                sosyalMedya: utils.getEmptySocialMediaData(),
                soruOrtalamalar: new Array(CONFIG.QUESTIONS_PER_SURVEY).fill('0'),
                acikUcluKeywords: []
            }),

            analyzeAllData: (rawSurveys) => {
                const mudurlukData = Object.fromEntries(
                    Object.keys(MUDURLUKLER).map(kod => [kod, {
                        kod,
                        ad: MUDURLUKLER[kod].name,
                        toplamPersonel: MUDURLUKLER[kod].personel,
                        anketler: [],
                        gecerliAnketler: [],
                        gecersizAnketler: []
                    }])
                );

                rawSurveys.forEach(survey => {
                    const md = mudurlukData[survey.mudurlukKod];
                    if (!md) return;

                    md.anketler.push(survey);

                    if (dataProcessor.validateSurvey(survey)) {
                        md.gecerliAnketler.push(survey);
                    } else {
                        md.gecersizAnketler.push(survey);
                    }
                });

                Object.values(mudurlukData).forEach(md => {
                    md.katilimOrani = md.toplamPersonel > 0
                        ? utils.formatPercentage(md.anketler.length / md.toplamPersonel * 100)
                        : '0';

                    Object.assign(md, dataProcessor.analyzeMudurluk(md));
                });

                return mudurlukData;
            }
        };

        const tableRenderer = {
            createSortableHeader: (text, tableId, columnIndex) => `
                <th class="sortable-header" onclick="tableSorter.sort('${tableId}', ${columnIndex})">
                    ${text}<span class="sort-icon"></span>
                </th>
            `,

            createFilterBar: (inputId, tableId) => `
                <div class="filter-bar">
                    <span class="material-icons-outlined" style="color: #6b7280;">search</span>
                    <input type="text" id="${inputId}" placeholder="Müdürlük adı yazın..." 
                           onkeyup="tableFilter.filter('${tableId}', '${inputId}', 0)">
                    <button class="btn btn-reset" onclick="tableFilter.reset('${tableId}', '${inputId}')">
                        <span class="material-icons-outlined" style="font-size: 16px;">refresh</span> Sıfırla
                    </button>
                </div>
            `,

            renderGenelSkorlar: () => {
                const tbody = document.getElementById('genelSkorlarBody');
                if (!tbody) return;

                tbody.innerHTML = '';

                const genelBelediye = tableRenderer.calculateGenelBelediye();
                tbody.innerHTML += tableRenderer.createGenelSkorRow('GENEL BELEDİYE', genelBelediye, true, null);

                const sortedMudurlukler = Object.values(state.processedData)
                    .sort((a, b) => parseFloat(b.genelMemnuniyet || 0) - parseFloat(a.genelMemnuniyet || 0));

                sortedMudurlukler.forEach(md => {
                    const emoji = MUDURLUK_KOD_EMOJI[md.kod] || '📋';
                    tbody.innerHTML += tableRenderer.createGenelSkorRow(
                        `${emoji} ${md.ad}`,
                        md,
                        false,
                        genelBelediye
                    );
                });
            },

            createGenelSkorRow: (name, data, isGenel, baseline) => {
                const denge = parseFloat(data.denge) || 0;
                const dengeClass = denge >= 0 ? 'positive' : 'negative';
                const dengeSymbol = denge >= 0 ? '+' : '';

                const toplamPersonel = data.toplamPersonel || 0;
                const toplamKatilan = data.anketler?.length || 0;
                const katilmayan = toplamPersonel - toplamKatilan;
                const katilimOrani = parseFloat(data.katilimOrani) || 0;

                // Katılmayan sütunu için renk hesapla (katılım oranına göre)
                let katilmayanClass = '';
                let katilmayanTooltip = '';
                if (!isGenel && baseline) {
                    const baseKatilim = parseFloat(baseline.katilimOrani) || 0;
                    if (baseKatilim > 0 && katilimOrani < baseKatilim) {
                        const diff = ((baseKatilim - katilimOrani) / baseKatilim) * 100;
                        if (diff > 20) katilmayanClass = 'below-avg-severe';
                        else if (diff > 10) katilmayanClass = 'below-avg-moderate';
                        else katilmayanClass = 'below-avg-mild';
                        katilmayanTooltip = `Katılım oranı ortalamanın %${diff.toFixed(1)} altında`;
                    }
                }

                const fields = [
                    {value: toplamPersonel},
                    {value: toplamKatilan},
                    {value: katilmayan, colorClass: katilmayanClass, tooltip: katilmayanTooltip},
                    {value: data.gecerliAnketler?.length || 0},
                    {value: data.gecersizAnketler?.length || 0},
                    {value: data.katilimOrani || 0, percent: true, baselineKey: 'katilimOrani'},
                    {value: data.genelMemnuniyet || 0, percent: true, bold: true, baselineKey: 'genelMemnuniyet'},
                    {value: data.isYuku || 0, percent: true, baselineKey: 'isYuku'},
                    {value: data.kurumDestegi || 0, percent: true, baselineKey: 'kurumDestegi'}
                ];

                let rowHTML = `<tr class="${isGenel ? 'highlight' : ''}"><td><strong>${name}</strong></td>`;

                fields.forEach(field => {
                    const displayValue = field.percent ? `${field.value}%` : field.value;
                    let colorClass = field.colorClass || '';
                    let tooltip = field.tooltip || '';
                    
                    if (!colorClass && baseline && field.baselineKey) {
                        const baseVal = baseline[field.baselineKey];
                        colorClass = !isGenel && baseVal ? utils.getBelowAvgClass(field.value, baseVal) : '';
                        tooltip = !isGenel && baseVal ? utils.getBelowAvgTooltip(field.value, baseVal) : '';
                    }
                    
                    const titleAttr = tooltip ? ` title="${tooltip}"` : '';
                    const content = field.bold ? `<strong>${displayValue}</strong>` : displayValue;
                    rowHTML += `<td class="${colorClass}"${titleAttr}>${content}</td>`;
                });

                rowHTML += `<td class="${dengeClass}"><strong>${dengeSymbol}${data.denge || 0}%</strong></td>`;
                return rowHTML + '</tr>';
            },

            calculateGenelBelediye: () => {
                const allValidSurveys = Object.values(state.processedData)
                    .flatMap(md => md.gecerliAnketler);

                const totals = Object.values(state.processedData).reduce((acc, md) => ({
                    personel: acc.personel + md.toplamPersonel,
                    anketler: acc.anketler + md.anketler.length,
                    gecerli: acc.gecerli + md.gecerliAnketler.length,
                    gecersiz: acc.gecersiz + md.gecersizAnketler.length
                }), {personel: 0, anketler: 0, gecerli: 0, gecersiz: 0});

                const workload = utils.calculateAverage(allValidSurveys, [7, 8, 9, 10]);
                const support = utils.calculateAverage(allValidSurveys,
                    [0, 1, 2, 3, 4, 5, 6, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23,
                        25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42]);

                return {
                    toplamPersonel: totals.personel,
                    anketler: {length: totals.anketler},
                    gecerliAnketler: {length: totals.gecerli},
                    gecersizAnketler: {length: totals.gecersiz},
                    katilimOrani: totals.personel > 0
                        ? utils.formatPercentage(totals.anketler / totals.personel * 100)
                        : '0',
                    genelMemnuniyet: utils.calculateAverage(allValidSurveys, [24]),
                    isYuku: workload,
                    kurumDestegi: support,
                    denge: utils.formatPercentage(parseFloat(support) - parseFloat(workload))
                };
            },

            renderAllTables: () => {
                tableRenderer.renderGirilenAnketler();

                if (!state.processedData || Object.keys(state.processedData).length === 0) {
                    return;
                }

                surveyManager.renderGenelBakisCards();
                surveyManager.renderEnMemnunMudurlukler();
                tableRenderer.renderGenelSkorlar();
                tableRenderer.renderSosyalMedya();
                tableRenderer.renderRuhSagligi();
                tableRenderer.renderThemeCards();
                tableRenderer.renderTemalar();
                tableRenderer.renderSorular();
                tableRenderer.renderAcikUclu();
                tableRenderer.populateMudurlukSelect();
            },

            renderGirilenAnketler: () => {
                const tbody = document.getElementById('girilenAnketlerBody');
                if (!tbody) return;

                tbody.innerHTML = '';

                if (state.allSurveys.length === 0 || !state.processedData) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:30px;">Henüz anket girişi yapılmamış...</td></tr>';
                    ['toplamAnketSayisi', 'gecerliAnketSayisi', 'gecersizAnketSayisi'].forEach(id => {
                        const el = document.getElementById(id);
                        if (el) el.textContent = '0';
                    });
                    return;
                }

                const mudurlukAnketleri = Object.fromEntries(
                    Object.keys(MUDURLUKLER).map(kod => [kod, {gecerli: [], gecersiz: []}])
                );

                let toplamGecerli = 0;
                let toplamGecersiz = 0;

                state.allSurveys.forEach(anket => {
                    const md = state.processedData[anket.mudurlukKod];
                    if (!md) return;

                    const isGecerli = md.gecerliAnketler.find(a => a.kod === anket.kod);
                    if (isGecerli) {
                        mudurlukAnketleri[anket.mudurlukKod].gecerli.push(anket.kod);
                        toplamGecerli++;
                    } else {
                        mudurlukAnketleri[anket.mudurlukKod].gecersiz.push(anket.kod);
                        toplamGecersiz++;
                    }
                });

                Object.entries(MUDURLUKLER).forEach(([kod, md]) => {
                    const anketler = mudurlukAnketleri[kod];
                    const toplamAnket = anketler.gecerli.length + anketler.gecersiz.length;

                    if (toplamAnket === 0) return;

                    const createTags = (kodlar, gecersiz = false) =>
                        kodlar.map(anketKod =>
                            `<span class="anket-tag ${gecersiz ? 'gecersiz' : ''}" ${gecersiz ? 'title="Geçersiz"' : ''}>
                                ${anketKod}<span class="remove-btn" data-kod="${anketKod}">×</span>
                            </span>`
                        ).join('');

                    tbody.innerHTML += `
                        <tr>
                            <td><span class="code-label">#${kod}</span> <strong>${md.name}</strong></td>
                            <td><strong>${toplamAnket}</strong></td>
                            <td>${anketler.gecerli.length}</td>
                            <td>${anketler.gecersiz.length}</td>
                            <td>${createTags(anketler.gecerli)}${createTags(anketler.gecersiz, true)}</td>
                            <td>
                                <button class="btn btn-small btn-danger btn-remove-mudurluk" data-mudurluk="${kod}">
                                    <span class="material-icons-outlined" style="font-size: 16px;">delete</span> Tümünü Sil
                                </button>
                            </td>
                        </tr>
                    `;
                });

                document.getElementById('toplamAnketSayisi').textContent = state.allSurveys.length;
                document.getElementById('gecerliAnketSayisi').textContent = toplamGecerli;
                document.getElementById('gecersizAnketSayisi').textContent = toplamGecersiz;
            },

            renderSosyalMedya: () => {
                sosyalMedyaManager.renderDashboard();

                const tbody = document.getElementById('sosyalMedyaBody');
                if (!tbody) return;

                tbody.innerHTML = '';

                const genelBelediye = tableRenderer.calculateGenelBelediyeAggregate('sosyalMedya');
                tbody.innerHTML += tableRenderer.createSosyalMedyaRow('GENEL BELEDİYE', genelBelediye, true, null);

                Object.values(state.processedData).forEach(md => {
                    if (md.sosyalMedya) {
                        const emoji = MUDURLUK_KOD_EMOJI[md.kod] || '📋';
                        tbody.innerHTML += tableRenderer.createSosyalMedyaRow(
                            `${emoji} ${md.ad}`,
                            md.sosyalMedya,
                            false,
                            genelBelediye
                        );
                    }
                });
            },

            createSosyalMedyaRow: (name, sm, isGenel, baseline) => {
                const platforms = ['instagram_belediye', 'instagram_baskan', 'twitter_belediye', 'twitter_baskan',
                    'facebook_belediye', 'facebook_baskan', 'nextsosyal_belediye', 'nextsosyal_baskan'];

                let rowHTML = `<tr class="${isGenel ? 'highlight' : ''}"><td><strong>${name}</strong></td>`;

                platforms.forEach(platform => {
                    const value = sm.detay?.[platform] || 0;
                    const baseVal = baseline?.detay?.[platform];
                    const colorClass = !isGenel && baseVal !== undefined ? utils.getBelowAvgClass(value, baseVal) : '';
                    const tooltip = !isGenel && baseVal !== undefined ? utils.getBelowAvgTooltip(value, baseVal) : '';
                    const titleAttr = tooltip ? ` title="${tooltip}"` : '';
                    rowHTML += `<td class="${colorClass}"${titleAttr}>${value}%</td>`;
                });

                return rowHTML + '</tr>';
            },

            renderRuhSagligi: () => {
                const tbody = document.getElementById('ruhSagligiBody');
                if (!tbody) return;

                tbody.innerHTML = '';

                const genelBelediye = tableRenderer.calculateGenelBelediyeRuhSagligi();
                tbody.innerHTML += tableRenderer.createRuhSagligiRow('GENEL BELEDİYE', genelBelediye, true, null);

                Object.values(state.processedData).forEach(md => {
                    const emoji = MUDURLUK_KOD_EMOJI[md.kod] || '📋';
                    tbody.innerHTML += tableRenderer.createRuhSagligiRow(
                        `${emoji} ${md.ad}`,
                        {
                            ruhSagligi: md.ruhSagligi,
                            sigaraOrani: md.sigaraOrani,
                            ruhSagligiDetay: md.ruhSagligiDetay
                        },
                        false,
                        genelBelediye
                    );
                });
            },

            createRuhSagligiRow: (name, data, isGenel, baseline) => {
                const fields = [
                    {key: 'ruhSagligi', value: data.ruhSagligi || 0, reverse: true},
                    {key: 'sigaraOrani', value: data.sigaraOrani || 0, reverse: true},
                    {key: 'keyifAlamama', value: data.ruhSagligiDetay?.keyifAlamama || 0, detayKey: 'keyifAlamama', reverse: true},
                    {key: 'uzgunCokkun', value: data.ruhSagligiDetay?.uzgunCokkun || 0, detayKey: 'uzgunCokkun', reverse: true},
                    {key: 'gerginKaygili', value: data.ruhSagligiDetay?.gerginKaygili || 0, detayKey: 'gerginKaygili', reverse: true},
                    {key: 'endiseKontrol', value: data.ruhSagligiDetay?.endiseKontrol || 0, detayKey: 'endiseKontrol', reverse: true}
                ];

                let rowHTML = `<tr class="${isGenel ? 'highlight' : ''}"><td><strong>${name}</strong></td>`;

                fields.forEach(field => {
                    let baseVal = null;
                    if (baseline) {
                        if (field.detayKey) {
                            baseVal = baseline.ruhSagligiDetay?.[field.detayKey];
                        } else {
                            baseVal = baseline[field.key];
                        }
                    }
                    const colorClass = !isGenel && baseVal !== undefined ? utils.getBelowAvgClass(field.value, baseVal, field.reverse) : '';
                    const tooltip = !isGenel && baseVal !== undefined ? utils.getBelowAvgTooltip(field.value, baseVal, field.reverse) : '';
                    const titleAttr = tooltip ? ` title="${tooltip}"` : '';
                    rowHTML += `<td class="${colorClass}"${titleAttr}>${field.value}%</td>`;
                });

                return rowHTML + '</tr>';
            },

            calculateGenelBelediyeRuhSagligi: () => {
                const allValidSurveys = Object.values(state.processedData)
                    .flatMap(md => md.gecerliAnketler);

                const smokers = allValidSurveys.filter(s =>
                    s.sigara && ['evet', 'yes'].includes(s.sigara.toLowerCase())
                ).length;

                return {
                    ruhSagligi: utils.calculateAverage(allValidSurveys, [45, 46, 47, 48]),
                    sigaraOrani: allValidSurveys.length > 0
                        ? utils.formatPercentage(smokers / allValidSurveys.length * 100)
                        : '0',
                    ruhSagligiDetay: {
                        keyifAlamama: utils.calculateAverage(allValidSurveys, [45]),
                        uzgunCokkun: utils.calculateAverage(allValidSurveys, [46]),
                        gerginKaygili: utils.calculateAverage(allValidSurveys, [47]),
                        endiseKontrol: utils.calculateAverage(allValidSurveys, [48])
                    }
                };
            },

            renderTemalar: () => {
                const tbody = document.getElementById('temalarBody');
                if (!tbody) return;

                tbody.innerHTML = '';

                const genelBelediye = tableRenderer.calculateGenelBelediyeTemalar();
                tbody.innerHTML += tableRenderer.createTemalarRow('GENEL BELEDİYE', genelBelediye, true, null);

                Object.values(state.processedData).forEach(md => {
                    const emoji = MUDURLUK_KOD_EMOJI[md.kod] || '📋';
                    tbody.innerHTML += tableRenderer.createTemalarRow(
                        `${emoji} ${md.ad}`,
                        md.temalar,
                        false,
                        genelBelediye
                    );
                });
            },

            createTemalarRow: (name, temalar, isGenel, baseline) => {
                const temaKeys = ['isKisiUyumu', 'gorevRolNetligi', 'hizmetTalepYogunlugu', 'yoneticilerleIliskiler',
                    'calismaArkadaslari', 'kurumIciIletisim', 'calismaKosullari', 'kamuHizmetiMotivasyonu',
                    'yetkinlikPerformans', 'egitimGelisim'];

                let rowHTML = `<tr class="${isGenel ? 'highlight' : ''}"><td><strong>${name}</strong></td>`;

                temaKeys.forEach(key => {
                    const value = temalar[key] || 0;
                    const baseVal = baseline?.[key];
                    const colorClass = !isGenel && baseVal !== undefined ? utils.getBelowAvgClass(value, baseVal) : '';
                    const tooltip = !isGenel && baseVal !== undefined ? utils.getBelowAvgTooltip(value, baseVal) : '';
                    const titleAttr = tooltip ? ` title="${tooltip}"` : '';
                    rowHTML += `<td class="${colorClass}"${titleAttr}>${value}%</td>`;
                });

                return rowHTML + '</tr>';
            },

            calculateGenelBelediyeTemalar: () => {
                const allValidSurveys = Object.values(state.processedData)
                    .flatMap(md => md.gecerliAnketler);

                return Object.fromEntries(
                    Object.entries(THEME_QUESTIONS).map(([key, questions]) =>
                        [key, utils.calculateAverage(allValidSurveys, questions)]
                    )
                );
            },

            renderSorular: () => {
                const thead = document.getElementById('sorularTableHead');
                const tbody = document.getElementById('sorularBody');
                const soruSelect = document.getElementById('soruSelect');
                const mudurlukSelect = document.getElementById('mudurlukSoruSelect');

                if (!thead || !tbody) return;

                if (!state.processedData || Object.keys(state.processedData).length === 0) {
                    thead.innerHTML = '<tr><th style="min-width:400px;">Soru</th></tr>';
                    tbody.innerHTML = '<tr><td style="text-align:center; padding:30px;">Lütfen veri girişi yapınız...</td></tr>';
                    if (soruSelect) {
                        soruSelect.innerHTML = '<option value="">-- Tüm Sorular --</option>';
                    }
                    if (mudurlukSelect) {
                        mudurlukSelect.innerHTML = '<option value="">-- Tüm Müdürlükler --</option>';
                    }
                    return;
                }

                // Soru dropdown'ını doldur
                if (soruSelect && soruSelect.options.length === 1) {
                    SORULAR.forEach((soru, i) => {
                        const option = document.createElement('option');
                        option.value = i;
                        option.textContent = `S${i + 1}. ${soru.substring(0, 60)}${soru.length > 60 ? '...' : ''}`;
                        soruSelect.appendChild(option);
                    });
                }

                // Müdürlük dropdown'ını doldur
                if (mudurlukSelect && mudurlukSelect.options.length === 1) {
                    Object.values(state.processedData).forEach(md => {
                        const option = document.createElement('option');
                        option.value = md.kod;
                        option.textContent = `#${md.kod} - ${md.ad}`;
                        mudurlukSelect.appendChild(option);
                    });
                }

                let headerHTML = '<tr>';

                // Soru sütunu - sticky
                headerHTML += '<th data-col="0" class="sticky-col" style="min-width: 350px; text-align: left; position: sticky; left: 0; background: #2B241C; z-index: 12;">Soru</th>';

                // Genel Belediye sütunu
                headerHTML += `
                    <th class="sortable-header" data-mudurluk="genel" data-col="1" onclick="tableSorter.sort('sorularTable', 1)">
                        <strong>GENEL<br>BELEDİYE</strong><span class="sort-icon"></span>
                    </th>
                `;

                // Müdürlük sütunları
                Object.values(state.processedData).forEach((md, index) => {
                    const mdName = md.ad.length > 25 ? md.ad.substring(0, 22) + '...' : md.ad;
                    const colIndex = index + 2;
                    headerHTML += `
                        <th class="sortable-header" data-mudurluk="md_${md.kod}" data-col="${colIndex}" onclick="tableSorter.sort('sorularTable', ${colIndex})">
                            ${mdName}<span class="sort-icon"></span>
                        </th>
                    `;
                });

                headerHTML += '</tr>';
                thead.innerHTML = headerHTML;

                const genelBelediyeSorular = tableRenderer.calculateGenelBelediyeSorular();

                tbody.innerHTML = SORULAR.map((soru, i) => {
                    let rowHTML = `<tr data-soru-index="${i}"><td data-col="0" class="sticky-col" style="position: sticky; left: 0; background: #fff; z-index: 2; border-right: 2px solid #e5e7eb;"><strong>S${i + 1}.</strong> ${soru}</td>`;
                    rowHTML += `<td class="highlight" data-mudurluk="genel" data-col="1"><strong>${genelBelediyeSorular[i]}%</strong></td>`;

                    Object.values(state.processedData).forEach((md, index) => {
                        const baseVal = genelBelediyeSorular[i];
                        const isReverseCoded = utils.REVERSE_CODED_QUESTIONS.includes(i);
                        const colorClass = utils.getBelowAvgClass(md.soruOrtalamalar[i], baseVal, isReverseCoded);
                        const tooltip = utils.getBelowAvgTooltip(md.soruOrtalamalar[i], baseVal, isReverseCoded);
                        const titleAttr = tooltip ? ` title="${tooltip}"` : '';
                        rowHTML += `<td data-mudurluk="md_${md.kod}" data-col="${index + 2}" class="${colorClass}"${titleAttr}>${md.soruOrtalamalar[i]}%</td>`;
                    });

                    return rowHTML + '</tr>';
                }).join('');
            },

            calculateGenelBelediyeSorular: () => {
                const allValidSurveys = Object.values(state.processedData)
                    .flatMap(md => md.gecerliAnketler);

                return Array.from({length: CONFIG.QUESTIONS_PER_SURVEY}, (_, i) =>
                    utils.calculateAverage(allValidSurveys, [i])
                );
            },

            calculateGenelBelediyeAggregate: (property) => {
                const allValidSurveys = Object.values(state.processedData)
                    .flatMap(md => md.gecerliAnketler);

                return property === 'sosyalMedya'
                    ? utils.calculateSocialMedia(allValidSurveys)
                    : null;
            },

            renderAcikUclu: () => {
                const tbody = document.getElementById('acikUcluBody');
                if (!tbody) return;

                if (!state.processedData || Object.keys(state.processedData).length === 0) {
                    tbody.innerHTML = '<tr><td colspan="3" style="text-align:center; padding:30px;">Lütfen veri girişi yapınız...</td></tr>';
                    return;
                }

                tbody.innerHTML = '';

                const allSurveys = Object.values(state.processedData).flatMap(md => [...md.gecerliAnketler, ...md.gecersizAnketler]);
                const genelKeywords = utils.analyzeKeywords(allSurveys);
                const genelCount = allSurveys.filter(s => s.acikUclu && s.acikUclu.trim()).length;

                tbody.innerHTML += tableRenderer.createAcikUcluRow('GENEL BELEDİYE', genelKeywords, genelCount, 'genel', true);

                Object.values(state.processedData).forEach(md => {
                    const allMdSurveys = [...md.gecerliAnketler, ...md.gecersizAnketler];
                    const count = allMdSurveys.filter(s => s.acikUclu && s.acikUclu.trim()).length;
                    const keywords = utils.analyzeKeywords(allMdSurveys);
                    const emoji = MUDURLUK_KOD_EMOJI[md.kod] || '📋';
                    tbody.innerHTML += tableRenderer.createAcikUcluRow(
                        `${emoji} ${md.ad}`,
                        keywords,
                        count,
                        md.kod,
                        false
                    );
                });
            },

            createAcikUcluRow: (name, keywords, count, mudurlukKod, isGenel) => {
                const keywordsHTML = keywords.map(kw => {
                    const tooltipContent = kw.isGroup
                        ? `<strong>${kw.name} (GRUP)</strong><br>${Object.entries(kw.details).map(([word, cnt]) => `• ${word}: ${cnt}`).join('<br>')}`
                        : `<strong>${kw.name}</strong><br>Tekil kelime`;

                    return `
                        <span class="keyword-item">
                            ${kw.name}(${kw.count})
                            <div class="keyword-tooltip">${tooltipContent}</div>
                        </span>
                    `;
                }).join(', ');

                const countHTML = count > 0
                    ? `<span class="clickable-count" onclick="openEndedManager.showResponses('${mudurlukKod}')">${count} cevap (Tıklayın 👁️)</span>`
                    : `<span style="color: #999; font-style: italic;">Cevap yok</span>`;

                return `
                    <tr class="${isGenel ? 'highlight' : ''}">
                        <td><strong>${name}</strong></td>
                        <td style="max-width: 500px;">${keywordsHTML || '<em style="color:#999;">Cevap yok</em>'}</td>
                        <td>${countHTML}</td>
                    </tr>
                `;
            },

            populateMudurlukSelect: () => {
                const select = document.getElementById('mudurlukSelect');
                if (!select) return;

                select.innerHTML = '<option value="">-- Müdürlük Seçiniz --</option>';

                if (!state.processedData || Object.keys(state.processedData).length === 0) {
                    return;
                }

                Object.values(state.processedData).forEach(md => {
                    const option = document.createElement('option');
                    option.value = md.kod;
                    option.textContent = `#${md.kod} - ${md.ad}`;
                    select.appendChild(option);
                });
            },

            renderThemeCards: () => {
                const container = document.getElementById('themeCardsContainer');
                if (!container || !state.processedData) return;

                const allValidSurveys = Object.values(state.processedData).flatMap(md => md.gecerliAnketler);
                const genelTemalar = tableRenderer.calculateGenelBelediyeTemalar();

                const cardsHTML = Object.entries(THEME_INFO).map(([themeKey, info]) => {
                    const score = parseFloat(genelTemalar[themeKey]) || 0;
                    const sentiment = utils.calculateThemeSentiment(allValidSurveys, info.keywords);
                    const keywords = utils.analyzeThemeKeywords(allValidSurveys, info.keywords);

                    let statusColor = '#10b981';
                    let statusText = 'Çok İyi';
                    let statusIcon = '😊';

                    if (score < 50) {
                        statusColor = '#ef4444';
                        statusText = 'Düşük';
                        statusIcon = '😞';
                    } else if (score < 70) {
                        statusColor = '#f59e0b';
                        statusText = 'Orta';
                        statusIcon = '😐';
                    }

                    const exampleResponses = allValidSurveys
                        .filter(s => {
                            const text = (s.acikUclu || '').toLowerCase();
                            return info.keywords.some(kw => text.includes(kw.toLowerCase()));
                        });

                    const displayResponses = exampleResponses.slice(0, 5);
                    const hasMore = exampleResponses.length > 5;

                    const questionCount = THEME_QUESTIONS[themeKey].length;

                    return `
                        <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border: 1px solid #e5e7eb;">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">
                                <span style="font-size: 32px;">${info.icon}</span>
                                <div style="flex: 1;">
                                    <h3 style="font-size: 16px; font-weight: 600; color: #1a1a1a; margin-bottom: 4px;">${info.title}</h3>
                                </div>
                            </div>
                            
                            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 16px; border-radius: 10px; margin-bottom: 16px;">
                                <div style="font-size: 11px; color: rgba(255,255,255,0.9); font-weight: 600; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">
                                    📊 Anketin Test Sorularından Gelen Ortalama · ${questionCount} Sorudan Ölçülmüştür
                                </div>
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <span style="font-size: 32px; font-weight: 700; color: white;">${score.toFixed(1)}%</span>
                                    <div>
                                        <div style="display: flex; align-items: center; gap: 6px;">
                                            <span style="font-size: 24px;">${statusIcon}</span>
                                            <span style="font-size: 14px; color: white; font-weight: 600;">${statusText}</span>
                                        </div>
                                        <div style="font-size: 11px; color: rgba(255,255,255,0.8); line-height: 1.4; margin-top: 4px;">
                                            ${info.description}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            ${sentiment.mentionCount > 0 ? `
                            <div style="background: #FDFCFA; padding: 16px; border-radius: 10px; border: 1px solid #e5e7eb;">
                                <div style="font-size: 11px; color: #6b7280; font-weight: 600; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px;">
                                    💬 Anketin Açık Uçlu Kısmından Alınan Yanıtlar
                                </div>
                                <div style="font-size: 12px; color: #374151; margin-bottom: 8px;">
                                    <strong>${sentiment.mentionCount} kişi</strong> bu tema hakkında yorum yaptı
                                </div>
                                <div style="display: flex; gap: 8px; font-size: 12px; margin-bottom: 12px;">
                                    ${sentiment.positive > 0 ? `<span style="color: #10b981; font-weight: 600;">😊 %${sentiment.positive} Pozitif</span>` : ''}
                                    ${sentiment.negative > 0 ? `<span style="color: #ef4444; font-weight: 600;">😞 %${sentiment.negative} Negatif</span>` : ''}
                                </div>
                                
                                ${keywords.length > 0 ? `
                                <div style="margin-bottom: 12px; padding-top: 12px; border-top: 1px solid #e5e7eb;">
                                    <div style="font-size: 11px; color: #6b7280; font-weight: 600; margin-bottom: 6px;">🔑 Sık Geçen Kelimeler:</div>
                                    <div style="font-size: 12px; color: #374151;">
                                        ${keywords.map(k => `<span style="background: #e0e7ff; padding: 4px 8px; border-radius: 4px; margin-right: 6px; display: inline-block; margin-bottom: 4px;">${k.word} (${k.count})</span>`).join('')}
                                    </div>
                                </div>
                                ` : ''}
                                
                                ${displayResponses.length > 0 ? `
                                <div style="padding-top: 12px; border-top: 1px solid #e5e7eb;">
                                    <div style="font-size: 11px; color: #6b7280; font-weight: 600; margin-bottom: 8px;">📝 Örnek Yorumlar:</div>
                                    <div id="responses-${themeKey}">
                                        ${displayResponses.map(s => `
                                            <div style="font-size: 12px; color: #374151; padding: 8px; background: white; border-radius: 6px; margin-bottom: 6px; border-left: 3px solid ${statusColor};">
                                                "${s.acikUclu.substring(0, 100)}${s.acikUclu.length > 100 ? '...' : ''}"
                                            </div>
                                        `).join('')}
                                    </div>
                                    ${hasMore ? `
                                    <button class="btn btn-small" onclick="themeManager.showAllResponses('${themeKey}', ${JSON.stringify(exampleResponses.map(s => s.acikUclu)).replace(/"/g, '&quot;')})" style="margin-top: 8px; margin-left: 0;">
                                        <span class="material-icons-outlined" style="font-size: 14px;">visibility</span> 
                                        Tümünü Gör (${exampleResponses.length} yorum)
                                    </button>
                                    ` : ''}
                                </div>
                                ` : ''}
                            </div>
                            </div>
                            ` : `
                            <div style="background: #FDFCFA; padding: 16px; border-radius: 10px; border: 1px solid #e5e7eb;">
                                <div style="font-size: 11px; color: #6b7280; font-weight: 600; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px;">
                                    💬 Anketin Açık Uçlu Kısmından Alınan Yanıtlar
                                </div>
                                <div style="text-align: center; padding: 20px; color: #9ca3af; font-size: 13px;">
                                    <span style="font-size: 32px; display: block; margin-bottom: 8px;">💭</span>
                                    Bu tema ile ilgili açık uçlu yorum bulunamadı
                                </div>
                            </div>
                            `}
                        </div>
                    `;
                }).join('');

                container.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; margin: 20px 0;">
                        ${cardsHTML}
                    </div>
                `;
            }
        };

        const openEndedManager = {
            showResponses: (mudurlukKod) => {
                const container = document.getElementById('responsesContainer');
                if (!container) return;

                let surveys, title;

                if (mudurlukKod === 'genel') {
                    surveys = Object.values(state.processedData).flatMap(md => [...md.gecerliAnketler, ...md.gecersizAnketler]);
                    title = 'GENEL BELEDİYE';
                } else {
                    const md = state.processedData[mudurlukKod];
                    if (!md) return;
                    surveys = [...md.gecerliAnketler, ...md.gecersizAnketler];
                    title = `#${md.kod} - ${md.ad}`;
                }

                const responsesWithText = surveys.filter(s => s.acikUclu && s.acikUclu.trim());
                state.currentOpenResponses = responsesWithText;

                const responsesHTML = responsesWithText.length > 0
                    ? responsesWithText.map(survey => `
                        <div class="response-balloon">
                            <div class="response-header">💬 ${MUDURLUKLER[survey.mudurlukKod]?.name || survey.kod}</div>
                            <div class="response-text">${survey.acikUclu}</div>
                        </div>
                    `).join('')
                    : '<div class="response-balloon"><div class="response-text response-empty">Bu müdürlükten açık uçlu cevap bulunmuyor.</div></div>';

                container.innerHTML = `
                    <div class="responses-header">
                        <div class="responses-title">📋 ${title} - Açık Uçlu Cevaplar (${responsesWithText.length} adet)</div>
                        <div class="responses-actions">
                            <button class="btn btn-small" onclick="openEndedManager.exportResponses()">
                                <span class="material-icons-outlined" style="font-size: 16px;">download</span> Excel'e Aktar
                            </button>
                            <button class="btn btn-small" onclick="openEndedManager.copyResponses()">
                                <span class="material-icons-outlined" style="font-size: 16px;">content_copy</span> Kopyala
                            </button>
                            <button class="btn btn-small btn-danger" onclick="openEndedManager.closeResponses()">
                                <span class="material-icons-outlined" style="font-size: 16px;">close</span> Kapat
                            </button>
                        </div>
                    </div>
                    ${responsesHTML}
                `;

                container.classList.add('active');
                container.scrollIntoView({behavior: 'smooth', block: 'nearest'});
            },

            closeResponses: () => {
                const container = document.getElementById('responsesContainer');
                if (container) {
                    container.classList.remove('active');
                    state.currentOpenResponses = null;
                }
            },

            copyResponses: () => {
                if (!state.currentOpenResponses) return;

                const text = state.currentOpenResponses
                    .map(s => `${s.kod}:\n${s.acikUclu}`)
                    .join('\n\n---\n\n');

                navigator.clipboard.writeText(text).then(() => {
                    utils.showMessage('✅ Cevaplar panoya kopyalandı!', 'success');
                }).catch(() => {
                    utils.showMessage('❌ Kopyalama başarısız oldu.', 'error');
                });
            },

            exportResponses: () => {
                if (!state.currentOpenResponses) return;

                const csv = 'Anket Kodu,Müdürlük,Açık Uçlu Cevap\n' +
                    state.currentOpenResponses.map(s => {
                        const escaped = s.acikUclu.replace(/"/g, '""');
                        return `"${s.kod}","${s.mudurlukAd}","${escaped}"`;
                    }).join('\n');

                const blob = new Blob(['\uFEFF' + csv], {type: 'text/csv;charset=utf-8;'});
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = 'acik_uclu_cevaplar.csv';
                link.click();

                utils.showMessage('✅ Excel dosyası indirildi!', 'success');
            }
        };

        const tableSorter = {
            sort: (tableId, columnIndex) => {
                const table = document.getElementById(tableId);
                const tbody = table.querySelector('tbody');
                const rows = Array.from(tbody.querySelectorAll('tr'));

                if (rows.length === 0) return;

                const thead = table.querySelector('thead');
                const headers = thead ? thead.querySelectorAll('.sortable-header') : table.querySelectorAll('.sortable-header');
                const clickedHeader = Array.from(headers).find(h => {
                    const col = h.getAttribute('data-col');
                    return col ? parseInt(col) === columnIndex : false;
                }) || headers[columnIndex];

                if (!clickedHeader) return;

                const direction = tableSorter.getNextSortDirection(clickedHeader);

                headers.forEach(h => h.classList.remove('sorted-asc', 'sorted-desc'));

                if (direction === 'reset') {
                    tableSorter.resetTableToOriginal(tableId);
                    return;
                }

                clickedHeader.classList.add(direction === 'asc' ? 'sorted-asc' : 'sorted-desc');

                const isNumeric = columnIndex !== 0;

                const dataRows = rows.filter(row => !row.classList.contains('highlight') || tableId === 'sorularTable');
                const highlightRows = tableId !== 'sorularTable' ? rows.filter(row => row.classList.contains('highlight')) : [];

                dataRows.sort((a, b) => {
                    const aCell = a.querySelector(`td[data-col="${columnIndex}"]`) || a.cells[columnIndex];
                    const bCell = b.querySelector(`td[data-col="${columnIndex}"]`) || b.cells[columnIndex];
                    
                    if (!aCell || !bCell) return 0;
                    
                    let aVal = aCell.textContent.trim();
                    let bVal = bCell.textContent.trim();

                    if (isNumeric) {
                        aVal = parseFloat(aVal.replace(/[^0-9.-]/g, '')) || 0;
                        bVal = parseFloat(bVal.replace(/[^0-9.-]/g, '')) || 0;
                        return direction === 'asc' ? (aVal - bVal) : (bVal - aVal);
                    }

                    return direction === 'asc'
                        ? aVal.localeCompare(bVal, 'tr')
                        : bVal.localeCompare(aVal, 'tr');
                });

                tbody.innerHTML = '';
                highlightRows.forEach(row => tbody.appendChild(row));
                dataRows.forEach(row => tbody.appendChild(row));
            },

            getNextSortDirection: (header) => {
                if (header.classList.contains('sorted-asc')) return 'desc';
                if (header.classList.contains('sorted-desc')) return 'reset';
                return 'asc';
            },

            resetTableToOriginal: (tableId) => {
                const renderMap = {
                    'genelSkorlarTable': tableRenderer.renderGenelSkorlar,
                    'sosyalMedyaTable': tableRenderer.renderSosyalMedya,
                    'ruhSagligiTable': tableRenderer.renderRuhSagligi,
                    'temalarTable': tableRenderer.renderTemalar,
                    'sorularTable': tableRenderer.renderSorular
                };

                const renderFn = renderMap[tableId];
                if (renderFn) renderFn();
            }
        };

        const tableFilter = {
            filter: (tableId, inputId, columnIndex) => {
                const input = document.getElementById(inputId);
                const filterText = input.value.toUpperCase().trim();
                const table = document.getElementById(tableId);
                const tbody = table.querySelector('tbody');
                const rows = tbody.querySelectorAll('tr');

                rows.forEach((row, index) => {
                    if (index === 0 && tableId !== 'sorularTable') {
                        row.style.display = '';
                        return;
                    }

                    const cell = row.cells[columnIndex];
                    if (cell) {
                        const txtValue = cell.textContent || cell.innerText;
                        row.style.display = txtValue.toUpperCase().includes(filterText) ? '' : 'none';
                    }
                });
            },

            reset: (tableId, filterId) => {
                const table = document.getElementById(tableId);
                const headers = table.querySelectorAll('.sortable-header');
                headers.forEach(h => h.classList.remove('sorted-asc', 'sorted-desc'));

                const filterInput = document.getElementById(filterId);
                if (filterInput) filterInput.value = '';

                const tbody = table.querySelector('tbody');
                const rows = tbody.querySelectorAll('tr');
                rows.forEach(row => {
                    row.style.display = '';
                });

                tableSorter.resetTableToOriginal(tableId);
                utils.showMessage('🔄 Tablo ve filtre sıfırlandı.', 'success');
            }
        };

        const dataInput = {
            addTableRows: (count) => {
                const tbody = document.getElementById('dataTableBody');
                if (!tbody) return;

                const fragment = document.createDocumentFragment();
                for (let i = 0; i < count; i++) {
                    const row = document.createElement('tr');
                    for (let j = 0; j < 61; j++) {
                        const cell = document.createElement('td');
                        cell.contentEditable = 'true';
                        cell.className = 'editable-cell';
                        row.appendChild(cell);
                    }
                    fragment.appendChild(row);
                }
                tbody.appendChild(fragment);
            },

            clearTableData: () => {
                if (!confirm('Tablodaki tüm verileri temizlemek istediğinizden emin misiniz?')) return;

                const tbody = document.getElementById('dataTableBody');
                if (!tbody) return;

                tbody.querySelectorAll('td').forEach(cell => {
                    cell.textContent = '';
                    cell.classList.remove('filled');
                });
                utils.showMessage('✅ Tablo temizlendi.', 'success');
            },

            setupPasteHandler: () => {
                const table = document.getElementById('dataTable');
                if (!table) return;

                table.addEventListener('paste', (e) => {
                    e.preventDefault();

                    const pastedData = (e.clipboardData || window.clipboardData).getData('text');
                    if (!pastedData) return;

                    const targetCell = e.target;
                    if (targetCell.tagName !== 'TD') return;

                    const targetRow = targetCell.parentElement;
                    const targetRowIndex = Array.from(targetRow.parentElement.children).indexOf(targetRow);
                    const targetCellIndex = Array.from(targetRow.children).indexOf(targetCell);

                    const rows = utils.parseClipboardTsv(pastedData);
                    const tbody = document.getElementById('dataTableBody');

                    const neededRows = targetRowIndex + rows.length;
                    const currentRows = tbody.children.length;
                    if (neededRows > currentRows) {
                        dataInput.addTableRows(neededRows - currentRows);
                    }

                    rows.forEach((cells, i) => {
                        const tableRow = tbody.children[targetRowIndex + i];

                        cells.forEach((cellData, j) => {
                            const cellIndex = targetCellIndex + j;
                            if (cellIndex < tableRow.children.length) {
                                const cell = tableRow.children[cellIndex];
                                cell.textContent = cellData.trim();
                                if (cellData.trim()) {
                                    cell.classList.add('filled');
                                }
                            }
                        });
                    });

                    utils.showMessage('📋 Veriler tabloya yapıştırıldı. "Tablodan Verileri İşle" butonuna tıklayın.', 'success');
                });
            },

            processTableData: () => {
                const tbody = document.getElementById('dataTableBody');
                if (!tbody) return;

                const rows = Array.from(tbody.children);

                let yeniAnketSayisi = 0;
                let gecersizFormat = 0;
                const hataMesajlari = [];

                rows.forEach((row, rowIndex) => {
                    const values = Array.from(row.children).map(cell => cell.textContent.trim());

                    if (values.every(v => !v)) return;

                    const kod = values[0];

                    if (!kod || !kod.includes('_')) {
                        if (kod) {
                            hataMesajlari.push(`Satır ${rowIndex + 1}: Geçersiz kod "${kod}"`);
                            gecersizFormat++;
                        }
                        return;
                    }

                    if (state.allSurveys.find(s => s.kod === kod)) return;

                    const mudurlukKod = parseInt(kod.split('_')[0]);
                    if (!MUDURLUKLER[mudurlukKod]) {
                        hataMesajlari.push(`Satır ${rowIndex + 1}: Bilinmeyen müdürlük "${mudurlukKod}"`);
                        gecersizFormat++;
                        return;
                    }

                    state.allSurveys.push(dataInput.parseSurveyRow(values, kod, mudurlukKod));
                    yeniAnketSayisi++;
                });

                if (yeniAnketSayisi === 0 && gecersizFormat === 0) {
                    utils.showMessage('⚠️ Tabloda işlenebilecek yeni anket bulunamadı!', 'warning');
                    return;
                }

                if (yeniAnketSayisi === 0 && gecersizFormat > 0) {
                    const hataDetay = hataMesajlari.slice(0, 3).join('<br>') +
                        (hataMesajlari.length > 3 ? `<br>... ve ${hataMesajlari.length - 3} hata daha.` : '');
                    utils.showMessage(`❌ Hiçbir anket işlenemedi. ${gecersizFormat} satırda hata:<br><br>${hataDetay}`, 'error');
                    return;
                }

                state.processedData = dataProcessor.analyzeAllData(state.allSurveys);
                tableRenderer.renderAllTables();

                databaseAPI.saveData();

                let message = `✅ ${yeniAnketSayisi} yeni anket başarıyla işlendi!`;
                if (gecersizFormat > 0) message += `<br>⚠️ ${gecersizFormat} satır atlandı.`;
                message += `<br>📊 Toplam sistemdeki anket: ${state.allSurveys.length}`;
                message += `<br>💾 Veriler otomatik olarak kaydedildi.`;
                utils.showMessage(message, 'success');

                dataInput.clearTableData();
            },

            parseSurveyRow: (values, kod, mudurlukKod) => {
                const surveyData = {
                    kod,
                    mudurlukKod,
                    mudurlukAd: MUDURLUKLER[mudurlukKod].name,
                    cevaplar: Array.from({length: CONFIG.QUESTIONS_PER_SURVEY}, (_, i) => {
                        const val = values[i + 1];
                        return val === '' || val === 'null' ? null : parseInt(val);
                    }),
                    sigara: values[50] || '',
                    acikUclu: values[60] || ''
                };

                const sosyalMedya1to0 = values.slice(52, 60);
                const has1or0Values = sosyalMedya1to0.some(v => v === '1' || v === '0');

                if (has1or0Values) {
                    surveyData.sosyalMedya = {
                        instagram_belediye: sosyalMedya1to0[0] === '1' ? 1 : 0,
                        instagram_baskan: sosyalMedya1to0[1] === '1' ? 1 : 0,
                        twitter_belediye: sosyalMedya1to0[2] === '1' ? 1 : 0,
                        twitter_baskan: sosyalMedya1to0[3] === '1' ? 1 : 0,
                        facebook_belediye: sosyalMedya1to0[4] === '1' ? 1 : 0,
                        facebook_baskan: sosyalMedya1to0[5] === '1' ? 1 : 0,
                        nextsosyal_belediye: sosyalMedya1to0[6] === '1' ? 1 : 0,
                        nextsosyal_baskan: sosyalMedya1to0[7] === '1' ? 1 : 0
                    };
                } else {
                    const sosyalMedyaMetni = values[51] || '';
                    surveyData.sosyalMedya = sosyalMedyaMetni
                        ? utils.parseSocialMediaFromText(sosyalMedyaMetni)
                        : Object.fromEntries(
                            ['instagram_belediye', 'instagram_baskan', 'twitter_belediye', 'twitter_baskan',
                                'facebook_belediye', 'facebook_baskan', 'nextsosyal_belediye', 'nextsosyal_baskan']
                                .map(key => [key, 0])
                        );
                }

                return surveyData;
            }
        };

        const themeManager = {
            showAllResponses: (themeKey, responses) => {
                const container = document.getElementById(`responses-${themeKey}`);
                const themeName = THEME_INFO[themeKey]?.title || themeKey;

                if (!container) return;

                const responsesHTML = responses.map(text => `
                    <div style="font-size: 12px; color: #374151; padding: 8px; background: #FDFCFA; border-radius: 6px; margin-bottom: 4px; border-left: 3px solid #C86A3C;">
                        "${text}"
                    </div>
                `).join('');

                container.innerHTML = responsesHTML;

                const btn = container.nextElementSibling;
                if (btn && btn.tagName === 'BUTTON') {
                    btn.style.display = 'none';
                }

                utils.showMessage(`✅ ${themeName} için tüm ${responses.length} yorum gösteriliyor.`, 'success');
            }
        };

        const sorularManager = {
            // Soru bazlı görünümde sıralama durumu
            questionViewSortAsc: true,
            
            selectQuestion: () => {
                sorularManager.updateTable();
            },
            
            renderQuestionView: (soruIndex, sortAsc = true) => {
                const thead = document.getElementById('sorularTableHead');
                const tbody = document.getElementById('sorularBody');
                
                if (!thead || !tbody) return;
                
                sorularManager.questionViewSortAsc = sortAsc;
                const genelBelediyeSorular = tableRenderer.calculateGenelBelediyeSorular();
                const isReverseCoded = utils.REVERSE_CODED_QUESTIONS.includes(soruIndex);
                
                // Sıralama ikonu
                const sortIcon = sortAsc ? '↑' : '↓';
                const sortTitle = sortAsc ? 'En düşükten yükseğe' : 'En yüksekten düşüğe';
                
                // Header: Müdürlük | Soru (tıklanabilir sıralama)
                let headerHTML = '<tr>';
                headerHTML += '<th class="sticky-col" style="min-width: 300px; text-align: left; position: sticky; left: 0; background: #2B241C; z-index: 12;">Müdürlük</th>';
                headerHTML += `<th class="sortable-header" style="min-width: 400px; text-align: left; cursor: pointer;" onclick="sorularManager.toggleQuestionSort(${soruIndex})" title="${sortTitle}">
                    S${soruIndex + 1}. ${SORULAR[soruIndex]} <span style="opacity: 0.7;">${sortIcon}</span>
                </th>`;
                headerHTML += '</tr>';
                thead.innerHTML = headerHTML;
                
                // Müdürlükleri sırala
                const sortedMudurlukler = Object.values(state.processedData).sort((a, b) => {
                    const valA = parseFloat(a.soruOrtalamalar[soruIndex]) || 0;
                    const valB = parseFloat(b.soruOrtalamalar[soruIndex]) || 0;
                    return sortAsc ? valA - valB : valB - valA;
                });
                
                // Body: Her müdürlük bir satır
                let bodyHTML = '';
                
                // Genel Belediye satırı (her zaman en üstte)
                bodyHTML += `<tr class="highlight">
                    <td style="position: sticky; left: 0; background: #fef9c3; z-index: 2; border-right: 2px solid #e5e7eb;"><strong>GENEL BELEDİYE</strong></td>
                    <td><strong>${genelBelediyeSorular[soruIndex]}%</strong></td>
                </tr>`;
                
                // Sıralanmış müdürlükler
                sortedMudurlukler.forEach(md => {
                    const emoji = MUDURLUK_KOD_EMOJI[md.kod] || '📋';
                    const baseVal = genelBelediyeSorular[soruIndex];
                    const colorClass = utils.getBelowAvgClass(md.soruOrtalamalar[soruIndex], baseVal, isReverseCoded);
                    const tooltip = utils.getBelowAvgTooltip(md.soruOrtalamalar[soruIndex], baseVal, isReverseCoded);
                    const titleAttr = tooltip ? ` title="${tooltip}"` : '';
                    
                    bodyHTML += `<tr>
                        <td style="position: sticky; left: 0; background: #fff; z-index: 2; border-right: 2px solid #e5e7eb;"><strong>${emoji} ${md.ad}</strong></td>
                        <td class="${colorClass}"${titleAttr}>${md.soruOrtalamalar[soruIndex]}%</td>
                    </tr>`;
                });
                
                tbody.innerHTML = bodyHTML;
            },
            
            toggleQuestionSort: (soruIndex) => {
                // Sıralamayı tersine çevir
                sorularManager.renderQuestionView(soruIndex, !sorularManager.questionViewSortAsc);
            },
            
            renderCombinedView: (soruIndex, mudurlukKod) => {
                const thead = document.getElementById('sorularTableHead');
                const tbody = document.getElementById('sorularBody');
                
                if (!thead || !tbody) return;
                
                const genelBelediyeSorular = tableRenderer.calculateGenelBelediyeSorular();
                const selectedMudurluk = state.processedData[mudurlukKod];
                const isReverseCoded = utils.REVERSE_CODED_QUESTIONS.includes(soruIndex);
                
                if (!selectedMudurluk) {
                    return;
                }
                
                const emoji = MUDURLUK_KOD_EMOJI[selectedMudurluk.kod] || '📋';
                
                // Header: Soru | Genel Belediye | Seçili Müdürlük
                let headerHTML = '<tr>';
                headerHTML += '<th class="sticky-col" style="min-width: 400px; text-align: left; position: sticky; left: 0; background: #2B241C; z-index: 12;">Soru</th>';
                headerHTML += '<th style="min-width: 120px; text-align: center; background: #2B241C;">GENEL BELEDİYE</th>';
                headerHTML += `<th style="min-width: 180px; text-align: center; background: #2B241C;">${emoji} ${selectedMudurluk.ad}</th>`;
                headerHTML += '</tr>';
                thead.innerHTML = headerHTML;
                
                // Body: Sadece seçili soru satırı
                const baseVal = genelBelediyeSorular[soruIndex];
                const mudurlukVal = selectedMudurluk.soruOrtalamalar[soruIndex];
                const colorClass = utils.getBelowAvgClass(mudurlukVal, baseVal, isReverseCoded);
                const tooltip = utils.getBelowAvgTooltip(mudurlukVal, baseVal, isReverseCoded);
                const titleAttr = tooltip ? ` title="${tooltip}"` : '';
                
                let bodyHTML = `<tr>
                    <td style="position: sticky; left: 0; background: #fff; z-index: 2; border-right: 2px solid #e5e7eb;">
                        <strong>S${soruIndex + 1}.</strong> ${SORULAR[soruIndex]}
                    </td>
                    <td style="text-align: center; background: #fef9c3;"><strong>${baseVal}%</strong></td>
                    <td style="text-align: center;" class="${colorClass}"${titleAttr}>${mudurlukVal}%</td>
                </tr>`;
                
                tbody.innerHTML = bodyHTML;
            },

            selectMudurluk: () => {
                sorularManager.updateTable();
            },
            
            updateTable: () => {
                const soruSelect = document.getElementById('soruSelect');
                const mudurlukSelect = document.getElementById('mudurlukSoruSelect');
                const thead = document.getElementById('sorularTableHead');
                const tbody = document.getElementById('sorularBody');

                if (!thead || !tbody) return;

                const selectedSoruIndex = soruSelect ? soruSelect.value : '';
                const selectedMudurlukKod = mudurlukSelect ? mudurlukSelect.value : '';
                
                // Durum 1: Hem müdürlük hem soru seçili - tek satır göster
                if (selectedSoruIndex !== '' && selectedMudurlukKod !== '') {
                    sorularManager.renderCombinedView(parseInt(selectedSoruIndex), selectedMudurlukKod);
                    return;
                }
                
                // Durum 2: Sadece soru seçili - müdürlükler satırda
                if (selectedSoruIndex !== '') {
                    sorularManager.renderQuestionView(parseInt(selectedSoruIndex), sorularManager.questionViewSortAsc);
                    return;
                }
                
                // Durum 3: Sadece müdürlük veya hiçbiri - tam tablo + sütun gizleme
                tableRenderer.renderSorular();
                
                if (selectedMudurlukKod !== '') {
                    sorularManager.applyColumnFilter(selectedMudurlukKod);
                }
            },
            
            applyColumnFilter: (selectedKod) => {
                const thead = document.getElementById('sorularTableHead');
                const tbody = document.getElementById('sorularBody');
                
                if (!thead || !tbody) return;
                
                const selectedMudurluk = `md_${selectedKod}`;

                // Header'dan hangi data-col'ları gizleyeceğimizi belirle
                const headerCells = thead.querySelectorAll('th[data-col]');
                const colsToHide = [];

                headerCells.forEach(cell => {
                    const col = cell.getAttribute('data-col');
                    const mudurlukKod = cell.getAttribute('data-mudurluk');

                    if (col === '0' || col === '1' || mudurlukKod === 'genel') {
                        cell.style.display = '';
                    } else if (mudurlukKod === selectedMudurluk) {
                        cell.style.display = '';
                    } else {
                        cell.style.display = 'none';
                        colsToHide.push(col);
                    }
                });

                // Body'deki tüm hücrelerde aynı col numaralarını gizle
                const bodyCells = tbody.querySelectorAll('td[data-col]');
                bodyCells.forEach(cell => {
                    const col = cell.getAttribute('data-col');
                    if (colsToHide.includes(col)) {
                        cell.style.display = 'none';
                    } else {
                        cell.style.display = '';
                    }
                });
            },

            resetFilters: () => {
                const soruSelect = document.getElementById('soruSelect');
                const mudurlukSelect = document.getElementById('mudurlukSoruSelect');

                if (soruSelect) soruSelect.value = '';
                if (mudurlukSelect) mudurlukSelect.value = '';

                sorularManager.selectQuestion();
                sorularManager.selectMudurluk();

                utils.showMessage('🔄 Filtreler sıfırlandı.', 'success');
            }
        };

        const sosyalMedyaManager = {
            renderDashboard: () => {
                const container = document.getElementById('sosyalMedyaDashboard');
                if (!container || !state.processedData) return;

                const allValidSurveys = Object.values(state.processedData).flatMap(md => md.gecerliAnketler);
                const genelSosyalMedya = utils.calculateSocialMedia(allValidSurveys);
                const totalPeople = allValidSurveys.length;

                const belediyeAccounts = [
                    {name: '@arnavutkoybelediyesi', platform: 'Instagram', icon: '<svg width="24" height="24" viewBox="0 0 24 24" fill="#E1306C"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/></svg>', percent: genelSosyalMedya.detay.instagram_belediye, color: '#E1306C'},
                    {name: '@ArnavutkoyBel', platform: 'Twitter', icon: '<svg width="24" height="24" viewBox="0 0 24 24" fill="#1DA1F2"><path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"/></svg>', percent: genelSosyalMedya.detay.twitter_belediye, color: '#1DA1F2'},
                    {name: '@Arnavutkoybelediyesi', platform: 'Facebook', icon: '<svg width="24" height="24" viewBox="0 0 24 24" fill="#4267B2"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>', percent: genelSosyalMedya.detay.facebook_belediye, color: '#4267B2'},
                    {name: '@arnavutkoybelediyesi', platform: 'NextSosyal', icon: '<svg width="24" height="24" viewBox="0 0 24 24" fill="#6B46C1"><circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2"/><path d="M12 6v6l4 2"/></svg>', percent: genelSosyalMedya.detay.nextsosyal_belediye, color: '#6B46C1'}
                ];

                const baskanAccounts = [
                    {name: '@mcandaroglutr', platform: 'Instagram', icon: '<svg width="24" height="24" viewBox="0 0 24 24" fill="#E1306C"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/></svg>', percent: genelSosyalMedya.detay.instagram_baskan, color: '#E1306C'},
                    {name: '@mcandaroglutr', platform: 'Twitter', icon: '<svg width="24" height="24" viewBox="0 0 24 24" fill="#1DA1F2"><path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"/></svg>', percent: genelSosyalMedya.detay.twitter_baskan, color: '#1DA1F2'},
                    {name: '@mcandaroglutr', platform: 'Facebook', icon: '<svg width="24" height="24" viewBox="0 0 24 24" fill="#4267B2"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>', percent: genelSosyalMedya.detay.facebook_baskan, color: '#4267B2'},
                    {name: '@mustafa_candaroglu', platform: 'NextSosyal', icon: '<svg width="24" height="24" viewBox="0 0 24 24" fill="#6B46C1"><circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2"/><path d="M12 6v6l4 2"/></svg>', percent: genelSosyalMedya.detay.nextsosyal_baskan, color: '#6B46C1'}
                ];

                const createAccountCard = (acc) => {
                    const followers = Math.round((parseFloat(acc.percent) / 100) * totalPeople);
                    return `
                        <div style="background: #FDFCFA; padding: 16px; border-radius: 10px; border-left: 4px solid ${acc.color};">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <div style="width: 28px; height: 28px; display: flex; align-items: center; justify-content: center;">${acc.icon}</div>
                                <div>
                                    <div style="font-size: 13px; color: #1a1a1a; font-weight: 600;">${acc.platform}</div>
                                    <div style="font-size: 11px; color: #9ca3af;">${acc.name}</div>
                                </div>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div style="font-size: 24px; font-weight: 700; color: ${acc.color};">${acc.percent}%</div>
                                <div style="font-size: 12px; color: #6b7280; font-weight: 600;">${followers} kişi takip ediyor</div>
                            </div>
                        </div>
                    `;
                };

                container.innerHTML = `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
                        <div style="background: white; padding: 20px; border-radius: 12px;">
                            <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 16px; color: #1a1a1a;">Belediye Hesapları Genel Durum</h3>
                            <div style="display: grid; gap: 12px;">
                                ${belediyeAccounts.map(acc => createAccountCard(acc)).join('')}
                            </div>
                        </div>
                        <div style="background: white; padding: 20px; border-radius: 12px;">
                            <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 16px; color: #1a1a1a;">Başkan Hesapları Genel Durum</h3>
                            <div style="display: grid; gap: 12px;">
                                ${baskanAccounts.map(acc => createAccountCard(acc)).join('')}
                            </div>
                        </div>
                    </div>
                `;
            },

            renderLiderlik: () => {
                const container = document.getElementById('sosyalMedyaLiderlik');
                if (!container || !state.processedData) return;

                const sorted = Object.values(state.processedData)
                    .map(md => {
                        const sm = md.sosyalMedya;
                        const allPlatforms = [
                            parseFloat(sm.detay?.instagram_belediye || 0),
                            parseFloat(sm.detay?.instagram_baskan || 0),
                            parseFloat(sm.detay?.twitter_belediye || 0),
                            parseFloat(sm.detay?.twitter_baskan || 0),
                            parseFloat(sm.detay?.facebook_belediye || 0),
                            parseFloat(sm.detay?.facebook_baskan || 0),
                            parseFloat(sm.detay?.nextsosyal_belediye || 0),
                            parseFloat(sm.detay?.nextsosyal_baskan || 0)
                        ];
                        const avgScore = allPlatforms.reduce((sum, val) => sum + val, 0) / 8;

                        return {
                            ad: md.ad,
                            kod: md.kod,
                            score: avgScore,
                            anketSayisi: md.gecerliAnketler.length
                        };
                    })
                    .sort((a, b) => b.score - a.score);

                const count = sosyalMedyaManager.showAllDepts ? sorted.length : 4;
                const toShow = sorted.slice(0, count);

                container.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px;">
                        ${toShow.map((md, index) => {
                    const medals = ['🥇', '🥈', '🥉'];
                    const medal = index < 3 ? medals[index] : `#${index + 1}`;

                    let color = '#6b7280';
                    if (md.score >= 75) color = '#10b981';
                    else if (md.score >= 50) color = '#C86A3C';
                    else if (md.score >= 25) color = '#f59e0b';

                    return `
                                <div style="background: #FDFCFA; padding: 16px; border-radius: 10px; text-align: center;">
                                    <div style="font-size: 32px; margin-bottom: 8px;">${medal}</div>
                                    <div style="font-size: 13px; font-weight: 600; color: #1a1a1a; margin-bottom: 8px; min-height: 40px; display: flex; align-items: center; justify-content: center;">
                                        ${md.ad}
                                    </div>
                                    <div style="font-size: 24px; font-weight: 700; color: ${color}; margin-bottom: 4px;">
                                        ${md.score.toFixed(1)}%
                                    </div>
                                    <div style="font-size: 11px; color: #9ca3af;">
                                        Ortalama Takip
                                    </div>
                                </div>
                            `;
                }).join('')}
                    </div>
                `;
            }
        };

        const surveyManager = {
            showAllDepts: false,

            toggleAllDepts: () => {
                surveyManager.showAllDepts = !surveyManager.showAllDepts;
                surveyManager.renderEnMemnunMudurlukler();

                const btn = document.getElementById('toggleDeptText');
                if (btn) {
                    btn.textContent = surveyManager.showAllDepts ? 'Daha Az Gör' : 'Tümünü Gör';
                }
            },

            renderGenelBakisCards: () => {
                const container = document.getElementById('genelBakisCards');
                if (!container || !state.processedData) return;

                const genelData = tableRenderer.calculateGenelBelediye();

                const cardsHTML = `
                    <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 16px;">
                        <div style="background: #FDFCFA; padding: 20px; border-radius: 10px; text-align: center;">
                            <p style="color: #6b7280; font-size: 13px; margin-bottom: 8px;">Toplam Personel</p>
                            <p style="color: #1a1a1a; font-size: 28px; font-weight: 700;">${genelData.toplamPersonel}</p>
                        </div>
                        <div style="background: #FDFCFA; padding: 20px; border-radius: 10px; text-align: center;">
                            <p style="color: #6b7280; font-size: 13px; margin-bottom: 8px;">Toplam Katılan</p>
                            <p style="color: #1a1a1a; font-size: 28px; font-weight: 700;">${genelData.anketler.length}</p>
                        </div>
                        <div style="background: #FDFCFA; padding: 20px; border-radius: 10px; text-align: center;">
                            <p style="color: #6b7280; font-size: 13px; margin-bottom: 8px;">Geçerli Anket</p>
                            <p style="color: #1a1a1a; font-size: 28px; font-weight: 700;">${genelData.gecerliAnketler.length}</p>
                        </div>
                        <div style="background: #FDFCFA; padding: 20px; border-radius: 10px; text-align: center;">
                            <p style="color: #6b7280; font-size: 13px; margin-bottom: 8px;">Katılım Oranı</p>
                            <p style="color: #C86A3C; font-size: 28px; font-weight: 700;">${genelData.katilimOrani}%</p>
                        </div>
                        <div style="background: #FDFCFA; padding: 20px; border-radius: 10px; text-align: center;">
                            <p style="color: #6b7280; font-size: 13px; margin-bottom: 8px;">Genel Memnuniyet</p>
                            <p style="color: #C86A3C; font-size: 28px; font-weight: 700;">${genelData.genelMemnuniyet}%</p>
                        </div>
                    </div>
                `;

                container.innerHTML = cardsHTML;
            },

            renderEnMemnunMudurlukler: () => {
                const container = document.getElementById('enMemnunMudurlukler');
                if (!container || !state.processedData) return;

                const sorted = Object.values(state.processedData)
                    .map(md => ({
                        ad: md.ad,
                        memnuniyet: parseFloat(md.genelMemnuniyet) || 0,
                        anketSayisi: md.gecerliAnketler.length
                    }))
                    .sort((a, b) => b.memnuniyet - a.memnuniyet);

                const count = surveyManager.showAllDepts ? sorted.length : 9;
                const toShow = sorted.slice(0, count);

                container.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;">
                        ${toShow.map(md => {
                    let icon = 'sentiment_neutral';
                    let color = '#9ca3af';

                    if (md.anketSayisi > 0) {
                        if (md.memnuniyet >= 80) {
                            icon = 'sentiment_very_satisfied';
                            color = '#10b981';
                        } else if (md.memnuniyet >= 60) {
                            icon = 'sentiment_satisfied';
                            color = '#C86A3C';
                        }
                    }

                    const scoreText = md.anketSayisi === 0
                        ? '<p style="font-size: 13px; color: #9ca3af;">Veri Yok</p>'
                        : `<p style="font-size: 14px; font-weight: 700; color: ${color};">${md.memnuniyet.toFixed(1)}%</p>`;

                    return `
                                <div style="background: #FDFCFA; padding: 16px; border-radius: 10px; display: flex; align-items: center; gap: 14px;">
                                    <span class="material-icons-outlined" style="font-size: 40px; color: ${color};">${icon}</span>
                                    <div style="flex: 1;">
                                        <h3 style="font-size: 14px; font-weight: 600; color: #1a1a1a; margin-bottom: 4px;">${md.ad}</h3>
                                        ${scoreText}
                                    </div>
                                </div>
                            `;
                }).join('')}
                    </div>
                `;
            },

            removeSurvey: (anketKodu) => {
                const index = state.allSurveys.findIndex(s => s.kod === anketKodu);

                if (index !== -1) {
                    state.allSurveys.splice(index, 1);
                    state.processedData = dataProcessor.analyzeAllData(state.allSurveys);
                    tableRenderer.renderAllTables();
                    utils.showMessage(`✅ "${anketKodu}" kodlu anket çıkarıldı.`, 'success');
                }
            },

            removeMudurlukSurveys: (mudurlukKod) => {
                const kod = typeof mudurlukKod === 'string' ? parseInt(mudurlukKod) : mudurlukKod;
                const mudurlukAdi = MUDURLUKLER[kod] ? MUDURLUKLER[kod].name : `#${kod}`;

                if (!confirm(`⚠️ DİKKAT!\n\n${mudurlukAdi} müdürlüğünün TÜM anketlerini silmek istediğinizden emin misiniz?\n\nBu işlem geri alınamaz!\n\n"OK" veya "Tamam" butonuna basarak onaylayın.`)) {
                    return;
                }

                const beforeCount = state.allSurveys.length;
                state.allSurveys = state.allSurveys.filter(s => s.mudurlukKod !== kod);
                const removedCount = beforeCount - state.allSurveys.length;

                state.processedData = dataProcessor.analyzeAllData(state.allSurveys);
                tableRenderer.renderAllTables();
                utils.showMessage(`✅ ${removedCount} anket çıkarıldı.`, 'success');
            },

            updateMudurlukAnalysis: () => {
                const select = document.getElementById('mudurlukSelect');
                const kod = select.value;
                const tbody = document.getElementById('mudurlukSecBody');

                if (!tbody) return;

                if (!kod) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:30px;">Lütfen müdürlük seçiniz...</td></tr>';
                    return;
                }

                const md = state.processedData[kod];
                const genelBelediyeSorular = tableRenderer.calculateGenelBelediyeSorular();

                tbody.innerHTML = SORULAR.map((soru, i) => {
                    const genelSkor = parseFloat(genelBelediyeSorular[i]);
                    const mudurlukSkor = parseFloat(md.soruOrtalamalar[i]);
                    const fark = utils.formatPercentage(mudurlukSkor - genelSkor);
                    const farkClass = parseFloat(fark) >= 0 ? 'positive' : 'negative';
                    const farkSymbol = parseFloat(fark) >= 0 ? '+' : '';

                    return `
                        <tr>
                            <td><strong>S${i + 1}.</strong> ${soru}</td>
                            <td>${genelSkor}%</td>
                            <td><strong>${md.ad}</strong></td>
                            <td>${mudurlukSkor}%</td>
                            <td class="${farkClass}"><strong>${farkSymbol}${fark}%</strong></td>
                        </tr>
                    `;
                }).join('');
            }
        };

        const unifiedPriorityManager = {
            // AI Insights localStorage yönetimi
            getAIInsights: () => {
                const stored = localStorage.getItem('aiInsights');
                return stored ? JSON.parse(stored) : [];
            },

            saveAIInsight: (insight) => {
                const insights = unifiedPriorityManager.getAIInsights();
                insight.id = Date.now().toString();
                insight.createdAt = new Date().toISOString();
                insights.push(insight);
                localStorage.setItem('aiInsights', JSON.stringify(insights));
                return insight;
            },

            removeAIInsight: (id) => {
                const insights = unifiedPriorityManager.getAIInsights();
                const filtered = insights.filter(i => i.id !== id);
                localStorage.setItem('aiInsights', JSON.stringify(filtered));
            },

            // Öncelik puanı hesaplama
            calculatePriorityScore: (severity, scope, visibility) => {
                return Math.round((severity + scope + visibility) / 3);
            },

            // Soru bazlı öncelikler
            getQuestionPriorities: () => {
                if (!state.processedData || Object.keys(state.processedData).length === 0) return [];

                const allValidSurveys = Object.values(state.processedData).flatMap(md => md.gecerliAnketler);
                const genelSoruOrtalamalar = tableRenderer.calculateGenelBelediyeSorular();
                const totalPersonel = Object.values(MUDURLUKLER).reduce((sum, m) => sum + m.personel, 0);

                // Her sorunun açık uçlularda geçme frekansını hesapla
                const commentFrequency = SORULAR.map((soru, index) => {
                    const keywords = soru.toLowerCase().split(' ').filter(w => w.length > 3).slice(0, 3);
                    const matchingComments = allValidSurveys.filter(s =>
                        s.acikUclu && keywords.some(kw => s.acikUclu.toLowerCase().includes(kw))
                    );
                    return (matchingComments.length / allValidSurveys.length) * 100;
                });

                return SORULAR.map((soru, index) => {
                    const soruSkoru = parseFloat(genelSoruOrtalamalar[index]);
                    const belediyeOrtalamasi = parseFloat(
                        genelSoruOrtalamalar.reduce((sum, val) => sum + parseFloat(val), 0) / genelSoruOrtalamalar.length
                    );

                    // Ciddiyet: Skor farkı normalize edilmiş
                    const skorFarki = belediyeOrtalamasi - soruSkoru;
                    const severity = Math.min(100, Math.max(0, (skorFarki / 3) * 100));

                    // Kapsam: Cevaplayan personel oranı
                    const cevapSayisi = allValidSurveys.filter(s => s[`s${index + 1}`] !== undefined).length;
                    const scope = Math.min(100, (cevapSayisi / totalPersonel) * 100);

                    // Görünürlük: Açık uçlularda geçme frekansı
                    const visibility = Math.min(100, commentFrequency[index] * 3);

                    const priorityScore = unifiedPriorityManager.calculatePriorityScore(severity, scope, visibility);

                    return {
                        type: 'soru',
                        id: `soru_${index}`,
                        title: soru,
                        soruNo: index + 1,
                        score: soruSkoru,
                        avgScore: belediyeOrtalamasi,
                        scoreDiff: skorFarki.toFixed(1),
                        affectedCount: cevapSayisi,
                        commentFrequency: commentFrequency[index].toFixed(1),
                        severity,
                        scope,
                        visibility,
                        priorityScore
                    };
                }).filter(item => item.priorityScore > 20); // Sadece önemli olanlar
            },

            // Tema bazlı öncelikler
            getThemePriorities: () => {
                if (!state.processedData || Object.keys(state.processedData).length === 0) return [];

                const allValidSurveys = Object.values(state.processedData).flatMap(md => md.gecerliAnketler);
                const genelTemalar = tableRenderer.calculateGenelBelediyeTemalar();
                const temaOrtalamasi = Object.values(genelTemalar).reduce((sum, val) => sum + parseFloat(val), 0) / 10;
                const totalPersonel = Object.values(MUDURLUKLER).reduce((sum, m) => sum + m.personel, 0);

                return Object.entries(genelTemalar).map(([key, value]) => {
                    const temaSkoru = parseFloat(value);
                    const skorFarki = temaOrtalamasi - temaSkoru;

                    // Ciddiyet
                    const severity = Math.min(100, Math.max(0, (skorFarki / 3) * 100));

                    // Kapsam (tüm belediye)
                    const scope = 100;

                    // Görünürlük (yorumlarda bahsedilme)
                    const keywords = THEME_INFO[key]?.keywords || [];
                    const matchingComments = allValidSurveys.filter(s =>
                        s.acikUclu && keywords.some(kw => s.acikUclu.toLowerCase().includes(kw))
                    );
                    const visibility = Math.min(100, (matchingComments.length / allValidSurveys.length) * 200);

                    const priorityScore = unifiedPriorityManager.calculatePriorityScore(severity, scope, visibility);

                    return {
                        type: 'tema',
                        id: `tema_${key}`,
                        title: THEME_INFO[key]?.title || key,
                        description: THEME_INFO[key]?.description || '',
                        score: temaSkoru,
                        avgScore: temaOrtalamasi,
                        scoreDiff: skorFarki.toFixed(1),
                        affectedCount: totalPersonel,
                        severity,
                        scope,
                        visibility,
                        priorityScore
                    };
                }).filter(item => item.priorityScore > 20);
            },

            // AI Insights öncelikleri
            getAIInsightPriorities: () => {
                const insights = unifiedPriorityManager.getAIInsights();
                const totalPersonel = Object.values(MUDURLUKLER).reduce((sum, m) => sum + m.personel, 0);

                return insights.map(insight => {
                    // Ciddiyet: Duygu skoru (1-10, düşük = kötü)
                    const severity = Math.min(100, ((10 - insight.sentiment) / 10) * 100);

                    // Kapsam: Bahseden kişi sayısı
                    const scope = Math.min(100, (insight.mentionCount / totalPersonel) * 100);

                    // Görünürlük: Frekans yüzdesi
                    const visibility = Math.min(100, insight.frequency * 2);

                    const priorityScore = unifiedPriorityManager.calculatePriorityScore(severity, scope, visibility);

                    return {
                        type: 'yorum',
                        id: `ai_${insight.id}`,
                        title: insight.topic,
                        sentiment: insight.sentiment,
                        frequency: insight.frequency,
                        mentionCount: insight.mentionCount,
                        topPhrases: insight.topPhrases || [],
                        examples: insight.examples || [],
                        severity,
                        scope,
                        visibility,
                        priorityScore
                    };
                }).filter(item => item.priorityScore > 20);
            },

            // Tüm öncelikleri birleştir
            getAllPriorities: (filter = 'all') => {
                let priorities = [];

                if (filter === 'all' || filter === 'soru') {
                    priorities = [...priorities, ...unifiedPriorityManager.getQuestionPriorities()];
                }
                if (filter === 'all' || filter === 'tema') {
                    priorities = [...priorities, ...unifiedPriorityManager.getThemePriorities()];
                }
                if (filter === 'all' || filter === 'yorum') {
                    priorities = [...priorities, ...unifiedPriorityManager.getAIInsightPriorities()];
                }

                return priorities.sort((a, b) => b.priorityScore - a.priorityScore).slice(0, 10);
            }
        };

        const dashboardManager = {
            renderDashboard: () => {
                if (!state.processedData || Object.keys(state.processedData).length === 0) return;

                dashboardManager.renderMetrics();
                dashboardManager.renderUnifiedPriorities();
                dashboardManager.renderStrongWeakAreas();
                dashboardManager.renderMudurlukBarChart();
                dashboardManager.renderTopBottomMudurlukler();
                dashboardManager.renderSosyalMedya();
                dashboardManager.renderAcikUcluSummary();
                dashboardManager.renderRuhSagligi();
                dashboardManager.renderActionPriority();
            },

            renderMetrics: () => {
                const container = document.getElementById('dashboardMetrics');
                if (!container) return;

                const allValidSurveys = Object.values(state.processedData).flatMap(md => md.gecerliAnketler);
                const totalPersonel = Object.values(MUDURLUKLER).reduce((sum, m) => sum + m.personel, 0);
                const totalKatilan = state.allSurveys.length;
                const katilimOrani = utils.formatPercentage((totalKatilan / totalPersonel) * 100);

                const genelMemnuniyet = tableRenderer.calculateGenelBelediyeTemalar();
                const avgMemnuniyet = utils.formatPercentage(
                    Object.values(genelMemnuniyet).reduce((sum, val) => sum + parseFloat(val), 0) / 10
                );

                const workload = utils.calculateAverage(allValidSurveys, THEME_QUESTIONS.hizmetTalepYogunlugu);
                const support = utils.calculateAverage(allValidSurveys,
                    [...THEME_QUESTIONS.yoneticilerleIliskiler, ...THEME_QUESTIONS.calismaArkadaslari, ...THEME_QUESTIONS.kurumIciIletisim]
                );
                const denge = utils.formatPercentage(parseFloat(support) - parseFloat(workload));

                const sosyalMedya = utils.calculateSocialMedia(allValidSurveys);

                const temaListesi = Object.entries(genelMemnuniyet).map(([key, val]) => THEME_INFO[key]?.title || key).join(', ');

                const temaBoxes = Object.entries(genelMemnuniyet).map(([key, val]) => {
                    const info = THEME_INFO[key];
                    return `<span style="display: inline-block; background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 20px; margin: 2px 4px; font-size: 11px; font-weight: 600;">${info?.title || key}: ${val}%</span>`;
                }).join('');

                container.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin: 20px 0;">
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 25px; border-radius: 16px; color: white; box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);">
                            <div style="font-size: 14px; font-weight: 600; opacity: 0.95; margin-bottom: 12px; letter-spacing: 0.5px;">TOPLAM KATILIM</div>
                            <div style="font-size: 56px; font-weight: 900; line-height: 1; margin-bottom: 8px; text-shadow: 0 2px 10px rgba(0,0,0,0.2);">${katilimOrani}%</div>
                            <div style="font-size: 13px; opacity: 0.9; line-height: 1.5; font-weight: 500;">
                                <strong style="font-size: 18px;">${totalKatilan} kişi</strong> katıldı<br>
                                <strong style="font-size: 18px;">${allValidSurveys.length} anket</strong> geçerli sayıldı
                            </div>
                        </div>
                        <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 25px; border-radius: 16px; color: white; box-shadow: 0 8px 20px rgba(240, 147, 251, 0.4);">
                            <div style="font-size: 14px; font-weight: 600; opacity: 0.95; margin-bottom: 12px; letter-spacing: 0.5px;">GENEL MEMNUNİYET</div>
                            <div style="font-size: 56px; font-weight: 900; line-height: 1; margin-bottom: 10px; text-shadow: 0 2px 10px rgba(0,0,0,0.2);">${avgMemnuniyet}%</div>
                            <div style="font-size: 10px; opacity: 0.95; line-height: 1.4;">
                                ${temaBoxes}
                            </div>
                        </div>
                        <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); padding: 25px; border-radius: 16px; color: white; box-shadow: 0 8px 20px rgba(79, 172, 254, 0.4);">
                            <div style="font-size: 13px; font-weight: 600; opacity: 0.95; margin-bottom: 12px; letter-spacing: 0.3px;">ALGILANAN BELEDİYE DESTEĞİNİN HİSSEDİLEN İŞ STRESİ İLE DENGESİ</div>
                            <div style="font-size: 56px; font-weight: 900; line-height: 1; margin-bottom: 8px; text-shadow: 0 2px 10px rgba(0,0,0,0.2);">${denge >= 0 ? '+' : ''}${denge}%</div>
                            <div style="font-size: 13px; opacity: 0.95; line-height: 1.5; font-weight: 500;">
                                ${denge >= 0 ? `Personeller <strong style="font-size: 16px;">+${denge} puan</strong> destek görüyor` : `<strong style="font-size: 16px;">${Math.abs(denge)} puan</strong> destek eksikliği`}
                            </div>
                        </div>
                    </div>
                `;
            },

            renderUnifiedPriorities: () => {
                const container = document.getElementById('dashboardUnifiedPriorities');
                if (!container) return;

                let currentFilter = 'all';

                const renderList = (filter) => {
                    const priorities = unifiedPriorityManager.getAllPriorities(filter);

                    const getTypeBadge = (type) => {
                        if (type === 'soru') return '<span style="background: #3b82f6; color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600;">SORU</span>';
                        if (type === 'tema') return '<span style="background: #10b981; color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600;">TEMA</span>';
                        if (type === 'yorum') return '<span style="background: #f59e0b; color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600;">YORUM</span>';
                    };

                    const renderCard = (item, index) => {
                        if (item.type === 'soru') {
                            return `
                                <div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 15px; border: 2px solid #e5e7eb; border-left: 5px solid #3b82f6;">
                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                                        <div style="flex: 1;">
                                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                                <span style="font-size: 20px; font-weight: 700; color: #1a1a1a;">${index + 1}.</span>
                                                ${getTypeBadge(item.type)}
                                                <span style="font-size: 14px; font-weight: 700; color: #1a1a1a;">${item.title}</span>
                                            </div>
                                        </div>
                                        <div style="text-align: right;">
                                            <div style="font-size: 32px; font-weight: 900; color: #3b82f6;">%${item.priorityScore}</div>
                                            <div style="font-size: 11px; color: #6b7280;">Öncelik Skoru</div>
                                        </div>
                                    </div>
                                    
                                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 15px;">
                                        <div style="background: #eff6ff; padding: 12px; border-radius: 8px;">
                                            <div style="font-size: 11px; color: #3b82f6; font-weight: 600; margin-bottom: 4px;">📊 CİDDİYET</div>
                                            <div style="font-size: 16px; font-weight: 700; color: #1a1a1a;">%${Math.round(item.severity)}</div>
                                            <div style="font-size: 10px; color: #6b7280; margin-top: 4px;">Skor: ${item.score}% (Ort: ${item.avgScore.toFixed(1)}%)</div>
                                        </div>
                                        <div style="background: #f0fdf4; padding: 12px; border-radius: 8px;">
                                            <div style="font-size: 11px; color: #10b981; font-weight: 600; margin-bottom: 4px;">👥 KAPSAM</div>
                                            <div style="font-size: 16px; font-weight: 700; color: #1a1a1a;">%${Math.round(item.scope)}</div>
                                            <div style="font-size: 10px; color: #6b7280; margin-top: 4px;">${item.affectedCount} kişi etkileniyor</div>
                                        </div>
                                        <div style="background: #fef3c7; padding: 12px; border-radius: 8px;">
                                            <div style="font-size: 11px; color: #f59e0b; font-weight: 600; margin-bottom: 4px;">💬 GÖRÜNÜRLÜK</div>
                                            <div style="font-size: 16px; font-weight: 700; color: #1a1a1a;">%${Math.round(item.visibility)}</div>
                                            <div style="font-size: 10px; color: #6b7280; margin-top: 4px;">Yorumlarda %${item.commentFrequency} geçiyor</div>
                                        </div>
                                    </div>
                                    
                                    <div style="background: #FDFCFA; padding: 12px; border-radius: 8px;">
                                        <div style="font-size: 12px; font-weight: 600; color: #374151; margin-bottom: 6px;">💡 Önerilen Aksiyonlar:</div>
                                        <div style="font-size: 12px; color: #6b7280;">
                                            • Soru bazında departman analizi yapın<br>
                                            • Düşük skorlu departmanlarla görüşmeler planlayın<br>
                                            • Kısa vadeli iyileştirme planı hazırlayın
                                        </div>
                                    </div>
                                </div>
                            `;
                        } else if (item.type === 'tema') {
                            return `
                                <div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 15px; border: 2px solid #e5e7eb; border-left: 5px solid #10b981;">
                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                                        <div style="flex: 1;">
                                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                                <span style="font-size: 20px; font-weight: 700; color: #1a1a1a;">${index + 1}.</span>
                                                ${getTypeBadge(item.type)}
                                                <span style="font-size: 14px; font-weight: 700; color: #1a1a1a;">${item.title}</span>
                                            </div>
                                            <div style="font-size: 11px; color: #6b7280; font-style: italic;">${item.description}</div>
                                        </div>
                                        <div style="text-align: right;">
                                            <div style="font-size: 32px; font-weight: 900; color: #10b981;">%${item.priorityScore}</div>
                                            <div style="font-size: 11px; color: #6b7280;">Öncelik Skoru</div>
                                        </div>
                                    </div>
                                    
                                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 15px;">
                                        <div style="background: #eff6ff; padding: 12px; border-radius: 8px;">
                                            <div style="font-size: 11px; color: #3b82f6; font-weight: 600; margin-bottom: 4px;">📊 CİDDİYET</div>
                                            <div style="font-size: 16px; font-weight: 700; color: #1a1a1a;">%${Math.round(item.severity)}</div>
                                            <div style="font-size: 10px; color: #6b7280; margin-top: 4px;">Skor: ${item.score}% (Ort: ${item.avgScore.toFixed(1)}%)</div>
                                        </div>
                                        <div style="background: #f0fdf4; padding: 12px; border-radius: 8px;">
                                            <div style="font-size: 11px; color: #10b981; font-weight: 600; margin-bottom: 4px;">👥 KAPSAM</div>
                                            <div style="font-size: 16px; font-weight: 700; color: #1a1a1a;">%${Math.round(item.scope)}</div>
                                            <div style="font-size: 10px; color: #6b7280; margin-top: 4px;">Tüm belediye (${item.affectedCount} kişi)</div>
                                        </div>
                                        <div style="background: #fef3c7; padding: 12px; border-radius: 8px;">
                                            <div style="font-size: 11px; color: #f59e0b; font-weight: 600; margin-bottom: 4px;">💬 GÖRÜNÜRLÜK</div>
                                            <div style="font-size: 16px; font-weight: 700; color: #1a1a1a;">%${Math.round(item.visibility)}</div>
                                            <div style="font-size: 10px; color: #6b7280; margin-top: 4px;">Yorumlarda bahsediliyor</div>
                                        </div>
                                    </div>
                                    
                                    <div style="background: #FDFCFA; padding: 12px; border-radius: 8px;">
                                        <div style="font-size: 12px; font-weight: 600; color: #374151; margin-bottom: 6px;">💡 Önerilen Aksiyonlar:</div>
                                        <div style="font-size: 12px; color: #6b7280;">
                                            • Tema alt sorularını detaylı inceleyin<br>
                                            • Tüm departmanlara yönelik iyileştirme planı<br>
                                            • Çalıştaylar ve eğitim programları düzenleyin
                                        </div>
                                    </div>
                                </div>
                            `;
                        } else if (item.type === 'yorum') {
                            return `
                                <div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 15px; border: 2px solid #e5e7eb; border-left: 5px solid #f59e0b;">
                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                                        <div style="flex: 1;">
                                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                                <span style="font-size: 20px; font-weight: 700; color: #1a1a1a;">${index + 1}.</span>
                                                ${getTypeBadge(item.type)}
                                                <span style="font-size: 14px; font-weight: 700; color: #1a1a1a;">${item.title}</span>
                                            </div>
                                            <div style="font-size: 11px; color: #6b7280;">⚠️ Ankette direkt soru yok ama açık uçlu yorumlarda tespit edildi</div>
                                        </div>
                                        <div style="text-align: right;">
                                            <div style="font-size: 32px; font-weight: 900; color: #f59e0b;">%${item.priorityScore}</div>
                                            <div style="font-size: 11px; color: #6b7280;">Öncelik Skoru</div>
                                        </div>
                                    </div>
                                    
                                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 15px;">
                                        <div style="background: #eff6ff; padding: 12px; border-radius: 8px;">
                                            <div style="font-size: 11px; color: #3b82f6; font-weight: 600; margin-bottom: 4px;">📊 CİDDİYET</div>
                                            <div style="font-size: 16px; font-weight: 700; color: #1a1a1a;">%${Math.round(item.severity)}</div>
                                            <div style="font-size: 10px; color: #6b7280; margin-top: 4px;">Duygu: ${item.sentiment}/10 ${item.sentiment <= 3 ? '(Çok olumsuz)' : item.sentiment <= 6 ? '(Olumsuz)' : '(Orta)'}</div>
                                        </div>
                                        <div style="background: #f0fdf4; padding: 12px; border-radius: 8px;">
                                            <div style="font-size: 11px; color: #10b981; font-weight: 600; margin-bottom: 4px;">👥 KAPSAM</div>
                                            <div style="font-size: 16px; font-weight: 700; color: #1a1a1a;">%${Math.round(item.scope)}</div>
                                            <div style="font-size: 10px; color: #6b7280; margin-top: 4px;">${item.mentionCount} kişi bahsetmiş</div>
                                        </div>
                                        <div style="background: #fef3c7; padding: 12px; border-radius: 8px;">
                                            <div style="font-size: 11px; color: #f59e0b; font-weight: 600; margin-bottom: 4px;">💬 GÖRÜNÜRLÜK</div>
                                            <div style="font-size: 16px; font-weight: 700; color: #1a1a1a;">%${Math.round(item.visibility)}</div>
                                            <div style="font-size: 10px; color: #6b7280; margin-top: 4px;">%${item.frequency} yorumda geçiyor</div>
                                        </div>
                                    </div>
                                    
                                    ${item.topPhrases && item.topPhrases.length > 0 ? `
                                        <div style="background: #fef3c7; padding: 12px; border-radius: 8px; margin-bottom: 10px;">
                                            <div style="font-size: 11px; font-weight: 600; color: #f59e0b; margin-bottom: 6px;">📝 En Sık Geçen İfadeler:</div>
                                            ${item.topPhrases.map(phrase => `<div style="font-size: 11px; color: #6b7280;">• ${phrase}</div>`).join('')}
                                        </div>
                                    ` : ''}
                                    
                                    ${item.examples && item.examples.length > 0 ? `
                                        <div style="background: #FDFCFA; padding: 12px; border-radius: 8px; margin-bottom: 10px;">
                                            <div style="font-size: 11px; font-weight: 600; color: #374151; margin-bottom: 6px;">💬 Örnek Yorumlar:</div>
                                            ${item.examples.slice(0, 2).map((ex, i) => `<div style="font-size: 11px; color: #6b7280; margin-bottom: 6px;"><strong>${i + 1}.</strong> "${ex}"</div>`).join('')}
                                        </div>
                                    ` : ''}
                                    
                                    <div style="background: #FDFCFA; padding: 12px; border-radius: 8px;">
                                        <div style="font-size: 12px; font-weight: 600; color: #374151; margin-bottom: 6px;">💡 Önerilen Aksiyonlar:</div>
                                        <div style="font-size: 12px; color: #6b7280;">
                                            • Bu konuyu önümüzdeki ankete ekleyin<br>
                                            • Personel odak grupları düzenleyin<br>
                                            • Hızlı aksiyon planı oluşturun
                                        </div>
                                    </div>
                                    
                                    <button onclick="if(confirm('Bu AI analizini silmek istediğinize emin misiniz?')) { unifiedPriorityManager.removeAIInsight('${item.id.replace('ai_', '')}'); dashboardManager.renderUnifiedPriorities(); }" style="margin-top: 10px; padding: 6px 12px; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 11px;">
                                        Sil
                                    </button>
                                </div>
                            `;
                        }
                    };

                    const html = `
                        <div style="background: white; padding: 25px; border-radius: 12px; margin: 20px 0; border: 1px solid #e5e7eb;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h2 style="font-size: 20px; font-weight: 700; color: #1a1a1a; display: flex; align-items: center; gap: 10px;">
                                    <span class="material-icons-outlined" style="font-size: 28px; color: #C86A3C;">priority_high</span>
                                    🎯 Öncelikli Müdahale Alanları (Unified Liste)
                                </h2>
                                <button onclick="document.getElementById('aiInsightModal').style.display='flex';" style="padding: 10px 20px; background: #C86A3C; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                                    <span class="material-icons-outlined" style="font-size: 20px;">add_circle</span>
                                    AI Analizi Ekle
                                </button>
                            </div>
                            
                            <p style="color: #6b7280; margin-bottom: 20px; font-size: 14px;">
                                Tüm veri kaynaklarından (temalar, sorular, açık uçlu yorumlar) öncelik sırasına göre birleştirilmiş liste. 
                                Her öğe Ciddiyet × Kapsam × Görünürlük formülüyle puanlanmıştır.
                            </p>
                            
                            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                                <button onclick="renderUnifiedList('all')" style="padding: 8px 16px; background: ${currentFilter === 'all' ? '#C86A3C' : '#e5e7eb'}; color: ${currentFilter === 'all' ? 'white' : '#6b7280'}; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                    Tümü
                                </button>
                                <button onclick="renderUnifiedList('tema')" style="padding: 8px 16px; background: ${currentFilter === 'tema' ? '#10b981' : '#e5e7eb'}; color: ${currentFilter === 'tema' ? 'white' : '#6b7280'}; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                    Temalar
                                </button>
                                <button onclick="renderUnifiedList('soru')" style="padding: 8px 16px; background: ${currentFilter === 'soru' ? '#3b82f6' : '#e5e7eb'}; color: ${currentFilter === 'soru' ? 'white' : '#6b7280'}; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                    Sorular
                                </button>
                                <button onclick="renderUnifiedList('yorum')" style="padding: 8px 16px; background: ${currentFilter === 'yorum' ? '#f59e0b' : '#e5e7eb'}; color: ${currentFilter === 'yorum' ? 'white' : '#6b7280'}; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                    Yorumlar
                                </button>
                            </div>
                            
                            <div id="unifiedPriorityList">
                                ${priorities.length > 0 ? priorities.map((item, index) => renderCard(item, index)).join('') : '<div style="text-align: center; padding: 40px; color: #6b7280;">Henüz öncelikli alan bulunamadı. Veri girin veya AI analizi ekleyin.</div>'}
                            </div>
                        </div>
                    `;

                    container.innerHTML = html;
                };

                window.renderUnifiedList = (filter) => {
                    currentFilter = filter;
                    renderList(filter);
                };

                renderList(currentFilter);
            },

            renderStrongWeakAreas: () => {
                const strongContainer = document.getElementById('dashboardStrongAreas');
                const weakContainer = document.getElementById('dashboardWeakAreas');
                if (!strongContainer || !weakContainer) return;

                const genelTemalar = tableRenderer.calculateGenelBelediyeTemalar();
                const allValidSurveys = Object.values(state.processedData).flatMap(md => md.gecerliAnketler);

                const temaArray = Object.entries(genelTemalar).map(([key, value]) => ({
                    key,
                    name: THEME_INFO[key]?.title || key,
                    description: THEME_INFO[key]?.description || '',
                    score: parseFloat(value),
                    questions: THEME_QUESTIONS[key] || []
                }));

                const sorted = temaArray.sort((a, b) => b.score - a.score);
                const strongAreas = sorted.slice(0, 5);
                const weakAreas = sorted.slice(-5).reverse();

                const getExampleComments = (tema) => {
                    const comments = allValidSurveys
                        .filter(s => s.acikUclu && s.acikUclu.trim())
                        .map(s => s.acikUclu)
                        .filter(comment => {
                            const keywords = tema.name.toLowerCase().split(' ');
                            return keywords.some(kw => comment.toLowerCase().includes(kw));
                        });
                    return comments.length > 0 ? comments : ['Belirli bir yorum bulunamadı'];
                };

                const getQuestionScores = (tema) => {
                    if (!tema.questions || tema.questions.length === 0) return [];
                    return tema.questions.map(qNum => {
                        const score = utils.calculateAverage(allValidSurveys, [qNum]);
                        const question = SORULAR[qNum - 1];
                        return {
                            number: qNum,
                            text: question || `Soru ${qNum}`,
                            score: parseFloat(score)
                        };
                    });
                };

                strongContainer.innerHTML = `
                    <div style="background: white; padding: 15px; border-radius: 8px; border: 2px solid #10b981;">
                        <h3 style="font-size: 16px; font-weight: 700; margin-bottom: 12px; color: #10b981; display: flex; align-items: center; gap: 8px;">
                            <span class="material-icons-outlined" style="font-size: 20px;">trending_up</span>
                            ✅ En Güçlü 5 Alan
                        </h3>
                        ${strongAreas.map((area, i) => {
                    const examples = getExampleComments(area);
                    const questionScores = getQuestionScores(area);
                    const displayComments = examples.slice(0, 5);
                    const hasMore = examples.length > 5;
                    const strongId = `strong_${i}`;
                    return `
                                <div style="background: #f0fdf4; padding: 10px; border-radius: 6px; margin-bottom: 8px; border-left: 3px solid #10b981;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="
                                        const details = document.getElementById('${strongId}_details');
                                        const icon = document.getElementById('${strongId}_icon');
                                        if (details.style.display === 'none') {
                                            details.style.display = 'block';
                                            icon.textContent = 'expand_less';
                                        } else {
                                            details.style.display = 'none';
                                            icon.textContent = 'expand_more';
                                        }
                                    ">
                                        <div style="flex: 1;">
                                            <span style="font-size: 14px; font-weight: 700; color: #10b981;">${i + 1}.</span>
                                            <strong style="font-size: 14px; color: #1a1a1a;">${area.name}</strong>
                                        </div>
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <div style="font-size: 18px; font-weight: 700; color: #10b981;">${area.score}%</div>
                                            <span class="material-icons-outlined" id="${strongId}_icon" style="font-size: 20px; color: #10b981;">expand_more</span>
                                        </div>
                                    </div>
                                    
                                    <div id="${strongId}_details" style="display: none; margin-top: 10px; padding-top: 10px; border-top: 1px dashed #10b981;">
                                        <div style="font-size: 11px; color: #6b7280; margin-bottom: 8px; font-style: italic;">
                                            ${area.description}
                                        </div>
                                        
                                        ${questionScores.length > 0 ? `
                                            <div style="background: white; padding: 8px; border-radius: 4px; margin-bottom: 8px;">
                                                <div style="font-size: 11px; font-weight: 600; color: #10b981; margin-bottom: 6px;">📊 Sorular:</div>
                                                ${questionScores.map(q => `
                                                    <div style="display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px dashed #e5e7eb; font-size: 11px;">
                                                        <div style="color: #374151; flex: 1;">${q.text}</div>
                                                        <div style="font-weight: 600; color: #10b981; margin-left: 8px;">${q.score}%</div>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        ` : ''}
                                        
                                        <div style="background: white; padding: 8px; border-radius: 4px;">
                                            <div style="font-size: 11px; font-weight: 600; color: #10b981; margin-bottom: 6px;">💬 Yorumlar:</div>
                                            ${displayComments.map((comment, idx) => `
                                                <div style="font-size: 11px; color: #374151; padding: 4px 0; border-bottom: 1px dashed #e5e7eb;">
                                                    <strong>${idx + 1}.</strong> "${comment.substring(0, 120)}${comment.length > 120 ? '...' : ''}"
                                                </div>
                                            `).join('')}
                                            <div id="${strongId}_rest" style="display: none;">
                                                ${examples.slice(5).map((comment, idx) => `
                                                    <div style="font-size: 11px; color: #374151; padding: 4px 0; border-bottom: 1px dashed #e5e7eb;">
                                                        <strong>${idx + 6}.</strong> "${comment.substring(0, 120)}${comment.length > 120 ? '...' : ''}"
                                                    </div>
                                                `).join('')}
                                            </div>
                                            ${hasMore ? `
                                                <button onclick="event.stopPropagation(); 
                                                    const el = document.getElementById('${strongId}_rest');
                                                    const btn = event.target;
                                                    if (el.style.display === 'none') {
                                                        el.style.display = 'block';
                                                        btn.textContent = 'Daha Az';
                                                    } else {
                                                        el.style.display = 'none';
                                                        btn.textContent = 'Tümü (${examples.length})';
                                                    }
                                                " style="margin-top: 6px; padding: 4px 8px; background: #10b981; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 10px;">
                                                    Tümü (${examples.length})
                                                </button>
                                            ` : ''}
                                        </div>
                                    </div>
                                </div>
                            `;
                }).join('')}
                    </div>
                `;

                weakContainer.innerHTML = `
                    <div style="background: white; padding: 15px; border-radius: 8px; border: 2px solid #ef4444;">
                        <h3 style="font-size: 16px; font-weight: 700; margin-bottom: 12px; color: #ef4444; display: flex; align-items: center; gap: 8px;">
                            <span class="material-icons-outlined" style="font-size: 20px;">trending_down</span>
                            ⚠️ Geliştirilmesi Gereken 5 Alan
                        </h3>
                        ${weakAreas.map((area, i) => {
                    const examples = getExampleComments(area);
                    const questionScores = getQuestionScores(area);
                    const displayComments = examples.slice(0, 5);
                    const hasMore = examples.length > 5;
                    const weakId = `weak_${i}`;
                    return `
                                <div style="background: #fef2f2; padding: 10px; border-radius: 6px; margin-bottom: 8px; border-left: 3px solid #ef4444;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="
                                        const details = document.getElementById('${weakId}_details');
                                        const icon = document.getElementById('${weakId}_icon');
                                        if (details.style.display === 'none') {
                                            details.style.display = 'block';
                                            icon.textContent = 'expand_less';
                                        } else {
                                            details.style.display = 'none';
                                            icon.textContent = 'expand_more';
                                        }
                                    ">
                                        <div style="flex: 1;">
                                            <span style="font-size: 14px; font-weight: 700; color: #ef4444;">${i + 1}.</span>
                                            <strong style="font-size: 14px; color: #1a1a1a;">${area.name}</strong>
                                        </div>
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <div style="font-size: 18px; font-weight: 700; color: #ef4444;">${area.score}%</div>
                                            <span class="material-icons-outlined" id="${weakId}_icon" style="font-size: 20px; color: #ef4444;">expand_more</span>
                                        </div>
                                    </div>
                                    
                                    <div id="${weakId}_details" style="display: none; margin-top: 10px; padding-top: 10px; border-top: 1px dashed #ef4444;">
                                        <div style="font-size: 11px; color: #6b7280; margin-bottom: 8px; font-style: italic;">
                                            ${area.description}
                                        </div>
                                        
                                        ${questionScores.length > 0 ? `
                                            <div style="background: white; padding: 8px; border-radius: 4px; margin-bottom: 8px;">
                                                <div style="font-size: 11px; font-weight: 600; color: #ef4444; margin-bottom: 6px;">📊 Sorular:</div>
                                                ${questionScores.map(q => `
                                                    <div style="display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px dashed #e5e7eb; font-size: 11px;">
                                                        <div style="color: #374151; flex: 1;">${q.text}</div>
                                                        <div style="font-weight: 600; color: #ef4444; margin-left: 8px;">${q.score}%</div>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        ` : ''}
                                        
                                        <div style="background: white; padding: 8px; border-radius: 4px;">
                                            <div style="font-size: 11px; font-weight: 600; color: #ef4444; margin-bottom: 6px;">💬 Yorumlar:</div>
                                            ${displayComments.map((comment, idx) => `
                                                <div style="font-size: 11px; color: #374151; padding: 4px 0; border-bottom: 1px dashed #e5e7eb;">
                                                    <strong>${idx + 1}.</strong> "${comment.substring(0, 120)}${comment.length > 120 ? '...' : ''}"
                                                </div>
                                            `).join('')}
                                            <div id="${weakId}_rest" style="display: none;">
                                                ${examples.slice(5).map((comment, idx) => `
                                                    <div style="font-size: 11px; color: #374151; padding: 4px 0; border-bottom: 1px dashed #e5e7eb;">
                                                        <strong>${idx + 6}.</strong> "${comment.substring(0, 120)}${comment.length > 120 ? '...' : ''}"
                                                    </div>
                                                `).join('')}
                                            </div>
                                            ${hasMore ? `
                                                <button onclick="event.stopPropagation(); 
                                                    const el = document.getElementById('${weakId}_rest');
                                                    const btn = event.target;
                                                    if (el.style.display === 'none') {
                                                        el.style.display = 'block';
                                                        btn.textContent = 'Daha Az';
                                                    } else {
                                                        el.style.display = 'none';
                                                        btn.textContent = 'Tümü (${examples.length})';
                                                    }
                                                " style="margin-top: 6px; padding: 4px 8px; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 10px;">
                                                    Tümü (${examples.length})
                                                </button>
                                            ` : ''}
                                        </div>
                                    </div>
                                </div>
                            `;
                }).join('')}
                    </div>
                `;
            },

            renderMudurlukBarChart: () => {
                const canvas = document.getElementById('mudurlukBarChart');
                if (!canvas) return;

                if (typeof Chart === 'undefined') {
                    console.error('Chart.js yüklenmedi!');
                    canvas.parentElement.innerHTML = '<p style="text-align:center;padding:20px;color:#ef4444;">Chart.js yüklenemedi. Lütfen sayfayı yenileyin.</p>';
                    return;
                }

                if (state.charts.mudurlukBar) {
                    state.charts.mudurlukBar.destroy();
                }

                const mudurlukler = Object.values(state.processedData)
                    .sort((a, b) => parseFloat(b.genelMemnuniyet) - parseFloat(a.genelMemnuniyet));

                const ctx = canvas.getContext('2d');
                state.charts.mudurlukBar = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: mudurlukler.map(m => m.ad),
                        datasets: [{
                            label: 'Genel Memnuniyet (%)',
                            data: mudurlukler.map(m => parseFloat(m.genelMemnuniyet)),
                            backgroundColor: mudurlukler.map(m => {
                                const score = parseFloat(m.genelMemnuniyet);
                                if (score >= 70) return '#10b981';
                                if (score >= 50) return '#f59e0b';
                                return '#ef4444';
                            })
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {display: false},
                            tooltip: {
                                callbacks: {
                                    title: (context) => {
                                        const m = mudurlukler[context[0].dataIndex];
                                        return m.ad;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                title: {display: true, text: 'Memnuniyet Skoru (%)'}
                            }
                        }
                    }
                });
            },

            renderTopBottomMudurlukler: () => {
                const topContainer = document.getElementById('topMudurlukler');
                const bottomContainer = document.getElementById('bottomMudurlukler');
                if (!topContainer || !bottomContainer) return;

                const sorted = Object.values(state.processedData)
                    .sort((a, b) => parseFloat(b.genelMemnuniyet) - parseFloat(a.genelMemnuniyet));

                const top5 = sorted.slice(0, 5);
                const bottom5 = sorted.slice(-5).reverse();

                topContainer.innerHTML = top5.map((m, i) => `
                    <div style="display: flex; align-items: center; padding: 12px; background: #f0fdf4; border-radius: 8px; margin-bottom: 8px; border-left: 3px solid #10b981;">
                        <div style="font-size: 20px; font-weight: 700; color: #10b981; width: 30px;">${i + 1}</div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: #1a1a1a;">${m.ad}</div>
                            <div style="font-size: 12px; color: #6b7280;">${m.gecerliAnketler.length} anket</div>
                        </div>
                        <div style="font-size: 24px; font-weight: 700; color: #10b981;">${m.genelMemnuniyet}%</div>
                    </div>
                `).join('');

                bottomContainer.innerHTML = bottom5.map((m, i) => `
                    <div style="display: flex; align-items: center; padding: 12px; background: #fef2f2; border-radius: 8px; margin-bottom: 8px; border-left: 3px solid #ef4444;">
                        <div style="font-size: 20px; font-weight: 700; color: #ef4444; width: 30px;">${i + 1}</div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: #1a1a1a;">${m.ad}</div>
                            <div style="font-size: 12px; color: #6b7280;">${m.gecerliAnketler.length} anket</div>
                        </div>
                        <div style="font-size: 24px; font-weight: 700; color: #ef4444;">${m.genelMemnuniyet}%</div>
                    </div>
                `).join('');
            },

            renderSosyalMedya: () => {
                const container = document.getElementById('dashboardSosyalMedya');
                if (!container) return;

                const allValidSurveys = Object.values(state.processedData).flatMap(md => md.gecerliAnketler);
                const genelSosyalMedya = utils.calculateSocialMedia(allValidSurveys);
                const totalPeople = allValidSurveys.length;

                const belediyeAccounts = [
                    {name: '@arnavutkoybelediyesi', platform: 'Instagram', icon: '<svg width="24" height="24" viewBox="0 0 24 24" fill="#E1306C"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/></svg>', percent: genelSosyalMedya.detay.instagram_belediye, color: '#E1306C'},
                    {name: '@ArnavutkoyBel', platform: 'Twitter', icon: '<svg width="24" height="24" viewBox="0 0 24 24" fill="#1DA1F2"><path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"/></svg>', percent: genelSosyalMedya.detay.twitter_belediye, color: '#1DA1F2'},
                    {name: '@Arnavutkoybelediyesi', platform: 'Facebook', icon: '<svg width="24" height="24" viewBox="0 0 24 24" fill="#4267B2"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>', percent: genelSosyalMedya.detay.facebook_belediye, color: '#4267B2'},
                    {name: '@arnavutkoybelediyesi', platform: 'NextSosyal', icon: '<svg width="24" height="24" viewBox="0 0 24 24" fill="#6B46C1"><circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2"/><path d="M12 6v6l4 2"/></svg>', percent: genelSosyalMedya.detay.nextsosyal_belediye, color: '#6B46C1'}
                ];

                const baskanAccounts = [
                    {name: '@mcanaroglutr', platform: 'Instagram', icon: '<svg width="24" height="24" viewBox="0 0 24 24" fill="#E1306C"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/></svg>', percent: genelSosyalMedya.detay.instagram_baskan, color: '#E1306C'},
                    {name: '@mcanaroglutr', platform: 'Twitter', icon: '<svg width="24" height="24" viewBox="0 0 24 24" fill="#1DA1F2"><path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"/></svg>', percent: genelSosyalMedya.detay.twitter_baskan, color: '#1DA1F2'},
                    {name: '@mcanaroglutr', platform: 'Facebook', icon: '<svg width="24" height="24" viewBox="0 0 24 24" fill="#4267B2"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>', percent: genelSosyalMedya.detay.facebook_baskan, color: '#4267B2'},
                    {name: '@mustafa_canaroglu', platform: 'NextSosyal', icon: '<svg width="24" height="24" viewBox="0 0 24 24" fill="#6B46C1"><circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2"/><path d="M12 6v6l4 2"/></svg>', percent: genelSosyalMedya.detay.nextsosyal_baskan, color: '#6B46C1'}
                ];

                const createAccountCard = (account) => {
                    const followers = Math.round(parseFloat(account.percent) * totalPeople / 100);
                    const percentValue = parseFloat(account.percent);

                    return `
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 16px; background: white; border-radius: 8px; border-left: 4px solid ${account.color};">
                            <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
                                ${account.icon}
                                <div>
                                    <div style="font-weight: 600; font-size: 14px; color: #1a1a1a;">${account.platform}</div>
                                    <div style="font-size: 12px; color: #6b7280;">${account.name}</div>
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 24px; font-weight: 700; color: ${account.color};">${percentValue.toFixed(1)}%</div>
                                <div style="font-size: 12px; color: #6b7280; font-weight: 600;">${followers} kişi takip ediyor</div>
                            </div>
                        </div>
                    `;
                };

                // Calculate bottom 5 departments by social media score
                const mudurluklerSorted = Object.values(state.processedData)
                    .filter(md => md.sosyalMedya && md.sosyalMedya.detay)
                    .map(md => {
                        const sm = md.sosyalMedya;
                        const allPlatforms = [
                            parseFloat(sm.detay?.instagram_belediye || 0),
                            parseFloat(sm.detay?.instagram_baskan || 0),
                            parseFloat(sm.detay?.twitter_belediye || 0),
                            parseFloat(sm.detay?.twitter_baskan || 0),
                            parseFloat(sm.detay?.facebook_belediye || 0),
                            parseFloat(sm.detay?.facebook_baskan || 0),
                            parseFloat(sm.detay?.nextsosyal_belediye || 0),
                            parseFloat(sm.detay?.nextsosyal_baskan || 0)
                        ];
                        const avgScore = allPlatforms.reduce((sum, val) => sum + val, 0) / 8;

                        return {
                            ad: md.ad,
                            score: avgScore,
                            anketSayisi: md.gecerliAnketler.length
                        };
                    })
                    .sort((a, b) => a.score - b.score);

                const bottom5 = mudurluklerSorted.slice(0, 5);

                container.innerHTML = `
                    <div style="background: white; padding: 20px; border-radius: 12px; margin: 20px 0; border: 1px solid #e5e7eb;">
                        <h2 style="font-size: 18px; font-weight: 600; margin-bottom: 20px; color: #1a1a1a;">
                            📱 Sosyal Medya Takip Detayları
                        </h2>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div style="background: #FDFCFA; padding: 20px; border-radius: 12px;">
                                <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 16px; color: #1a1a1a;">Belediye Hesapları Genel Durum</h3>
                                <div style="display: grid; gap: 12px;">
                                    ${belediyeAccounts.map(acc => createAccountCard(acc)).join('')}
                                </div>
                            </div>
                            <div style="background: #FDFCFA; padding: 20px; border-radius: 12px;">
                                <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 16px; color: #1a1a1a;">Başkan Hesapları Genel Durum</h3>
                                <div style="display: grid; gap: 12px;">
                                    ${baskanAccounts.map(acc => createAccountCard(acc)).join('')}
                                </div>
                            </div>
                        </div>
                        
                        <div style="background: #fef2f2; padding: 20px; border-radius: 12px; margin-top: 20px; border: 1px solid #fecaca;">
                            <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 16px; color: #ef4444; display: flex; align-items: center; gap: 8px;">
                                <span class="material-icons-outlined" style="font-size: 20px;">trending_down</span>
                                En Az Takip Eden 5 Müdürlük
                            </h3>
                            <div style="display: grid; gap: 10px;">
                                ${bottom5.map((md, i) => `
                                    <div style="display: flex; align-items: center; padding: 12px; background: white; border-radius: 8px; border-left: 3px solid #ef4444;">
                                        <div style="font-size: 20px; font-weight: 700; color: #ef4444; width: 40px; text-align: center;">${i + 1}</div>
                                        <div style="flex: 1;">
                                            <div style="font-weight: 600; color: #1a1a1a; font-size: 14px;">${md.ad}</div>
                                            <div style="font-size: 12px; color: #6b7280;">${md.anketSayisi} anket</div>
                                        </div>
                                        <div style="text-align: right;">
                                            <div style="font-size: 20px; font-weight: 700; color: #ef4444;">${md.score.toFixed(1)}%</div>
                                            <div style="font-size: 11px; color: #6b7280;">ortalama takip</div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div style="text-align: center; margin-top: 20px;">
                            <button class="btn" onclick="pageManager.showPage('sosyal-medya')" style="background: #3b82f6;">
                                <span class="material-icons-outlined">analytics</span>
                                Detaylı Sosyal Medya Analizini Gör
                            </button>
                        </div>
                    </div>
                `;
            },

            renderAcikUcluSummary: () => {
                const container = document.getElementById('dashboardAcikUclu');
                if (!container) return;

                const allSurveys = Object.values(state.processedData).flatMap(md => [...md.gecerliAnketler, ...md.gecersizAnketler]);
                const keywords = utils.analyzeKeywords(allSurveys);
                const totalResponses = allSurveys.filter(s => s.acikUclu && s.acikUclu.trim()).length;

                const top5 = keywords.slice(0, 5);
                const next5 = keywords.slice(5, 10);

                container.innerHTML = `
                    <div style="background: white; padding: 20px; border-radius: 12px; margin: 20px 0; border: 1px solid #e5e7eb;">
                        <h2 style="font-size: 18px; font-weight: 600; margin-bottom: 15px; color: #1a1a1a;">
                            💬 Açık Uçlu Cevaplar - En Sık Geçen Kelimeler
                        </h2>
                        <div style="background: #FDFCFA; padding: 15px; border-radius: 8px; max-width: 600px; margin: 0 auto;">
                            ${top5.map((k, i) => `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: white; border-radius: 6px; margin-bottom: 8px; border-left: 3px solid #667eea;">
                                    <div>
                                        <span style="font-weight: 700; color: #667eea; margin-right: 8px;">${i + 1}.</span>
                                        <span style="font-size: 14px; font-weight: 600; color: #1a1a1a;">${k.name}</span>
                                    </div>
                                    <div style="background: #667eea; color: white; padding: 4px 12px; border-radius: 12px; font-size: 13px; font-weight: 600;">
                                        ${k.count} kez
                                    </div>
                                </div>
                            `).join('')}
                            <div id="moreKeywords" style="display: none;">
                                ${next5.map((k, i) => `
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: white; border-radius: 6px; margin-bottom: 8px; border-left: 3px solid #9ca3af;">
                                        <div>
                                            <span style="font-weight: 700; color: #6b7280; margin-right: 8px;">${i + 6}.</span>
                                            <span style="font-size: 14px; font-weight: 600; color: #1a1a1a;">${k.name}</span>
                                        </div>
                                        <div style="background: #e5e7eb; color: #374151; padding: 4px 12px; border-radius: 12px; font-size: 13px; font-weight: 600;">
                                            ${k.count} kez
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            ${keywords.length > 5 ? `
                                <button onclick="
                                    const el = document.getElementById('moreKeywords');
                                    const btn = event.target;
                                    if (el.style.display === 'none') {
                                        el.style.display = 'block';
                                        btn.textContent = 'Daha Az Göster';
                                    } else {
                                        el.style.display = 'none';
                                        btn.textContent = '•••';
                                    }
                                " style="width: 100%; margin-top: 10px; padding: 8px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: 600;">
                                    •••
                                </button>
                            ` : ''}
                        </div>
                        <div style="text-align: center; margin-top: 15px;">
                            <button class="btn" onclick="pageManager.showPage('acik-uclu')" style="background: #667eea;">
                                <span class="material-icons-outlined">feedback</span>
                                Tüm Açık Uçlu Cevapları Gör
                            </button>
                        </div>
                    </div>
                `;
            },

            renderRuhSagligi: () => {
                const ruhSagligiContainer = document.getElementById('dashboardRuhSagligi');
                const sigaraContainer = document.getElementById('dashboardSigara');
                if (!ruhSagligiContainer || !sigaraContainer) return;

                const allValidSurveys = Object.values(state.processedData).flatMap(md => md.gecerliAnketler);
                const ruhSagligiSkor = utils.calculateAverage(allValidSurveys, [45, 46, 47, 48]);

                const ruhSagligiSorted = Object.values(state.processedData)
                    .sort((a, b) => parseFloat(b.ruhSagligi) - parseFloat(a.ruhSagligi));

                ruhSagligiContainer.innerHTML = `
                    <div style="background: white; padding: 20px; border-radius: 12px; margin: 20px 0; border: 1px solid #e5e7eb;">
                        <h2 style="font-size: 18px; font-weight: 600; margin-bottom: 15px; color: #1a1a1a;">
                            🩺 Ruh Sağlığı Taraması
                        </h2>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                            <div style="background: #fef2f2; padding: 20px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 12px; color: #6b7280; margin-bottom: 8px;">Genel Ruh Sağlığı Skoru</div>
                                <div style="font-size: 36px; font-weight: 700; color: #ef4444;">${ruhSagligiSkor}%</div>
                                <div style="font-size: 11px; color: #9ca3af; margin-top: 4px;">Yüksek skor = Olumsuz durum</div>
                            </div>
                            <div style="background: #FDFCFA; padding: 20px; border-radius: 8px;">
                                <div style="font-size: 13px; font-weight: 600; color: #6b7280; margin-bottom: 12px;">En Riskli 3 Müdürlük</div>
                                ${ruhSagligiSorted.slice(0, 3).map((md, i) => `
                                    <div style="padding: 8px; background: #fef2f2; border-radius: 6px; margin-bottom: 6px;">
                                        <div style="display: flex; justify-content: space-between; align-items: center;">
                                            <span style="font-size: 13px;">${i + 1}. ${md.ad}</span>
                                            <strong style="color: #ef4444;">${md.ruhSagligi}%</strong>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        <div style="text-align: center; margin-top: 15px;">
                            <button class="btn" onclick="pageManager.showPage('ruh-sagligi')" style="background: #ec4899;">
                                <span class="material-icons-outlined">psychology</span>
                                Detaylı Ruh Sağlığı Analizini Gör
                            </button>
                        </div>
                    </div>
                `;

                const smokers = allValidSurveys.filter(s => s.sigara && ['evet', 'yes'].includes(s.sigara.toLowerCase())).length;
                const sigaraOrani = allValidSurveys.length > 0 ? utils.formatPercentage(smokers / allValidSurveys.length * 100) : '0';

                const sigaraSorted = Object.values(state.processedData)
                    .map(md => {
                        const mdSmokers = md.gecerliAnketler.filter(s => s.sigara && ['evet', 'yes'].includes(s.sigara.toLowerCase())).length;
                        const mdSigaraOrani = md.gecerliAnketler.length > 0 ? (mdSmokers / md.gecerliAnketler.length * 100) : 0;
                        return {
                            ...md,
                            sigaraKisiSayisi: mdSmokers,
                            sigaraOranNumeric: mdSigaraOrani
                        };
                    })
                    .sort((a, b) => b.sigaraOranNumeric - a.sigaraOranNumeric)
                    .filter(md => md.sigaraKisiSayisi > 0);

                sigaraContainer.innerHTML = `
                    <div style="background: white; padding: 20px; border-radius: 12px; margin: 20px 0; border: 1px solid #e5e7eb;">
                        <h2 style="font-size: 18px; font-weight: 600; margin-bottom: 15px; color: #1a1a1a;">
                            🚬 Sigara Kullanım Analizi
                        </h2>
                        <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 20px;">
                            <div style="background: #fef3c7; padding: 20px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 12px; color: #6b7280; margin-bottom: 8px;">Genel Sigara Kullanım Oranı</div>
                                <div style="font-size: 36px; font-weight: 700; color: #f59e0b;">${sigaraOrani}%</div>
                                <div style="font-size: 11px; color: #9ca3af; margin-top: 4px;">${smokers} kişi</div>
                            </div>
                            <div style="background: #FDFCFA; padding: 20px; border-radius: 8px;">
                                <div style="font-size: 13px; font-weight: 600; color: #6b7280; margin-bottom: 12px;">En Çok Sigara Kullanan 5 Müdürlük</div>
                                ${sigaraSorted.slice(0, 5).map((md, i) => `
                                    <div style="padding: 10px; background: white; border: 1px solid #fde68a; border-radius: 6px; margin-bottom: 8px;">
                                        <div style="display: flex; justify-content: space-between; align-items: center;">
                                            <div style="flex: 1;">
                                                <span style="font-size: 14px; font-weight: 600;">${i + 1}. ${md.ad}</span>
                                            </div>
                                            <div style="text-align: right;">
                                                <div style="font-size: 16px; font-weight: 700; color: #f59e0b;">${utils.formatPercentage(md.sigaraOranNumeric)}%</div>
                                                <div style="font-size: 11px; color: #6b7280;">${md.sigaraKisiSayisi} kişi</div>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        <div style="text-align: center; margin-top: 15px;">
                            <button class="btn" onclick="pageManager.showPage('ruh-sagligi')" style="background: #f59e0b;">
                                <span class="material-icons-outlined">analytics</span>
                                Detaylı Ruh Sağlığı ve Sigara Analizini Gör
                            </button>
                        </div>
                    </div>
                `;
            },

            renderActionPriority: () => {
                const container = document.getElementById('dashboardActionPriority');
                if (!container) return;

                const priorityData = Object.values(state.processedData).map(md => {
                    const personelSayisi = MUDURLUKLER[md.kod]?.personel || md.gecerliAnketler.length;
                    const memnuniyetSkoru = parseFloat(md.genelMemnuniyet);
                    const priorityScore = (100 - memnuniyetSkoru) * (personelSayisi / 100);

                    return {
                        kod: md.kod,
                        ad: md.ad,
                        memnuniyet: memnuniyetSkoru,
                        personel: personelSayisi,
                        priorityScore: priorityScore,
                        category: priorityScore > 15 ? 'high' : priorityScore > 8 ? 'medium' : 'low'
                    };
                }).sort((a, b) => b.priorityScore - a.priorityScore);

                const highPriority = priorityData.filter(d => d.category === 'high');
                const mediumPriority = priorityData.filter(d => d.category === 'medium');

                container.innerHTML = `
                    <div style="background: white; padding: 25px; border-radius: 12px; margin: 20px 0; border: 1px solid #e5e7eb;">
                        <h2 style="font-size: 20px; font-weight: 700; margin-bottom: 20px; color: #1a1a1a; display: flex; align-items: center; gap: 10px;">
                            <span class="material-icons-outlined" style="font-size: 28px; color: #ef4444;">priority_high</span>
                            Aksiyon Öncelik Matrisi
                        </h2>
                        <p style="color: #6b7280; margin-bottom: 20px; font-size: 14px;">
                            Düşük memnuniyet skoru + yüksek personel sayısı = yüksek müdahale önceliği
                        </p>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div>
                                <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 15px; color: #ef4444; display: flex; align-items: center; gap: 8px;">
                                    <span class="material-icons-outlined">error</span>
                                    Yüksek Öncelik (${highPriority.length} Müdürlük)
                                </h3>
                                ${highPriority.length > 0 ? highPriority.map((d, i) => `
                                    <div style="background: #fef2f2; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid #ef4444;">
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                            <div style="font-weight: 600; color: #1a1a1a;">${i + 1}. #${d.kod} - ${d.ad}</div>
                                            <div style="background: #ef4444; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">
                                                Öncelik: ${d.priorityScore.toFixed(1)}
                                            </div>
                                        </div>
                                        <div style="display: flex; gap: 15px; font-size: 13px; color: #6b7280;">
                                            <span>📉 Memnuniyet: ${d.memnuniyet}%</span>
                                            <span>👥 Personel: ${d.personel} kişi</span>
                                        </div>
                                    </div>
                                `).join('') : '<div style="color: #9ca3af; padding: 20px; text-align: center;">Yüksek öncelikli müdürlük bulunmuyor.</div>'}
                            </div>
                            
                            <div>
                                <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 15px; color: #f59e0b; display: flex; align-items: center; gap: 8px;">
                                    <span class="material-icons-outlined">warning</span>
                                    Orta Öncelik (${mediumPriority.length} Müdürlük)
                                </h3>
                                ${mediumPriority.length > 0 ? mediumPriority.slice(0, 5).map((d, i) => `
                                    <div style="background: #fef3c7; padding: 12px; border-radius: 8px; margin-bottom: 8px; border-left: 4px solid #f59e0b;">
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                                            <div style="font-weight: 600; color: #1a1a1a; font-size: 14px;">${i + 1}. #${d.kod} - ${d.ad}</div>
                                            <div style="background: #f59e0b; color: white; padding: 3px 10px; border-radius: 10px; font-size: 11px; font-weight: 600;">
                                                ${d.priorityScore.toFixed(1)}
                                            </div>
                                        </div>
                                        <div style="display: flex; gap: 12px; font-size: 12px; color: #6b7280;">
                                            <span>📉 ${d.memnuniyet}%</span>
                                            <span>👥 ${d.personel} kişi</span>
                                        </div>
                                    </div>
                                `).join('') : '<div style="color: #9ca3af; padding: 20px; text-align: center;">Orta öncelikli müdürlük bulunmuyor.</div>'}
                                ${mediumPriority.length > 5 ? `
                                    <div style="text-align: center; margin-top: 10px; color: #6b7280; font-size: 13px;">
                                        +${mediumPriority.length - 5} müdürlük daha...
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        <div style="text-align: center; margin-top: 15px;">
                            <button class="btn" onclick="pageManager.showPage('mudurluk-detay')" style="background: #ef4444;">
                                <span class="material-icons-outlined">business</span>
                                Müdürlük Detay Analizine Git
                            </button>
                        </div>
                    </div>
                `;
            },

            exportPDF: () => {
                alert('PDF rapor özelliği yakında eklenecek!');
            }
        };

        const comparisonManager = {
            updateComparison: () => {
                const select1 = document.getElementById('karsilastir1');
                const select2 = document.getElementById('karsilastir2');
                const container = document.getElementById('comparisonResult');

                if (!select1 || !select2 || !container) return;

                const kod1 = select1.value;
                const kod2 = select2.value;

                if (!kod1 || !kod2) {
                    container.innerHTML = '<div style="text-align: center; padding: 40px; color: #9ca3af;">Lütfen iki müdürlük seçiniz...</div>';
                    return;
                }

                if (kod1 === kod2) {
                    container.innerHTML = '<div class="warning-box">⚠️ Lütfen farklı iki müdürlük seçiniz.</div>';
                    return;
                }

                const md1 = state.processedData[kod1];
                const md2 = state.processedData[kod2];

                container.innerHTML = `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                        <div style="background: white; padding: 20px; border-radius: 12px; border: 2px solid #667eea;">
                            <h3 style="color: #667eea; margin-bottom: 15px;">#${md1.kod} - ${md1.ad}</h3>
                            <div style="margin-bottom: 20px;">
                                <div style="font-size: 12px; color: #6b7280; margin-bottom: 4px;">Genel Memnuniyet</div>
                                <div style="font-size: 32px; font-weight: 700; color: #667eea;">${md1.genelMemnuniyet}%</div>
                            </div>
                            ${Object.entries(md1.temalar).map(([key, value]) => `
                                <div style="display: flex; justify-content: space-between; padding: 8px; background: #FDFCFA; border-radius: 6px; margin-bottom: 6px;">
                                    <span style="font-size: 13px; color: #374151;">${THEME_INFO[key]?.title}</span>
                                    <span style="font-weight: 600; color: #667eea;">${value}%</span>
                                </div>
                            `).join('')}
                        </div>
                        <div style="background: white; padding: 20px; border-radius: 12px; border: 2px solid #f5576c;">
                            <h3 style="color: #f5576c; margin-bottom: 15px;">#${md2.kod} - ${md2.ad}</h3>
                            <div style="margin-bottom: 20px;">
                                <div style="font-size: 12px; color: #6b7280; margin-bottom: 4px;">Genel Memnuniyet</div>
                                <div style="font-size: 32px; font-weight: 700; color: #f5576c;">${md2.genelMemnuniyet}%</div>
                            </div>
                            ${Object.entries(md2.temalar).map(([key, value]) => `
                                <div style="display: flex; justify-content: space-between; padding: 8px; background: #FDFCFA; border-radius: 6px; margin-bottom: 6px;">
                                    <span style="font-size: 13px; color: #374151;">${THEME_INFO[key]?.title}</span>
                                    <span style="font-weight: 600; color: #f5576c;">${value}%</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div style="background: white; padding: 20px; border-radius: 12px; margin-top: 20px; border: 1px solid #e5e7eb;">
                        <h3 style="margin-bottom: 15px;">📊 Tema Bazlı Farklar</h3>
                        ${Object.keys(THEME_INFO).map(key => {
                    const fark = parseFloat(md1.temalar[key]) - parseFloat(md2.temalar[key]);
                    const farkClass = fark >= 0 ? 'positive' : 'negative';
                    const farkSymbol = fark >= 0 ? '+' : '';
                    return `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #f3f4f6;">
                                    <span style="font-weight: 500;">${THEME_INFO[key].title}</span>
                                    <span class="${farkClass}" style="font-weight: 700;">${farkSymbol}${utils.formatPercentage(fark)}%</span>
                                </div>
                            `;
                }).join('')}
                    </div>
                `;
            },

            populateSelects: () => {
                const select1 = document.getElementById('karsilastir1');
                const select2 = document.getElementById('karsilastir2');

                if (!select1 || !select2 || !state.processedData) return;

                const options = Object.values(state.processedData)
                    .map(md => `<option value="${md.kod}">#${md.kod} - ${md.ad}</option>`)
                    .join('');

                if (select1.options.length === 1) {
                    select1.innerHTML += options;
                }
                if (select2.options.length === 1) {
                    select2.innerHTML += options;
                }
            }
        };

        const reportManager = {
            selectedMudurluk: null,

            getMudurlukOptions: () => {
                if (typeof RAPOR_VERILERI === 'undefined' || !RAPOR_VERILERI.mudurlukler) return '';
                return Object.entries(RAPOR_VERILERI.mudurlukler)
                    .sort((a, b) => a[1].name.localeCompare(b[1].name, 'tr'))
                    .map(([key, data]) => `<option value="${key}">${data.name}</option>`)
                    .join('');
            },

            renderReportPage: () => {
                const hasRaporData = typeof RAPOR_VERILERI !== 'undefined';

                return `
                    <div class="max-w-[1100px] mx-auto">
                        <!-- RAPOR İÇERİĞİ -->
                        <div class="bg-white rounded-[20px] shadow-soft p-8 md:p-12 border border-white relative overflow-hidden">
                            <article id="reportContent" class="prose prose-lg max-w-none font-serif text-[#44403C] leading-[1.8]">
                                ${hasRaporData ? `
                                
                                <div class="mb-8 flex items-center gap-3 flex-wrap">
                                    <div class="relative">
                                        <select id="mudurlukFilter" onchange="reportManager.filterReports(this.value)" class="appearance-none pl-4 pr-10 py-2.5 bg-white border border-[#E5DDD5] rounded-full text-sm min-w-[200px] font-sans text-[#4A4641] focus:outline-none focus:ring-2 focus:ring-[#A89080]/20 focus:border-[#A89080] cursor-pointer transition-all hover:border-[#C5B8AA]">
                                            <option value="">Tüm Müdürlükler</option>
                                            ${reportManager.getMudurlukOptions()}
                                        </select>
                                        <span class="material-icons-outlined absolute right-3 top-1/2 -translate-y-1/2 text-[#8C847D] text-[18px] pointer-events-none">expand_more</span>
                                    </div>
                                    <div class="relative flex-1 min-w-[160px] max-w-[280px]">
                                        <input type="text" id="raporArama" placeholder="Ara..." onkeyup="reportManager.searchReports(this.value)" class="pl-10 pr-4 py-2.5 w-full bg-white border border-[#E5DDD5] rounded-full text-sm font-sans text-[#4A4641] placeholder:text-[#B0A99F] focus:outline-none focus:ring-2 focus:ring-[#A89080]/20 focus:border-[#A89080] transition-all hover:border-[#C5B8AA]">
                                        <span class="material-icons-outlined absolute left-3 top-1/2 -translate-y-1/2 text-[#8C847D] text-[18px]">search</span>
                                    </div>
                                </div>
                                
                                <div id="mudurlukRaporlari" class="mt-8">
                                    ${Object.entries(RAPOR_VERILERI.mudurlukler)
                                .sort((a, b) => a[1].name.localeCompare(b[1].name, 'tr'))
                                .map(([key, data]) => `
                                            <div class="mudurluk-rapor-section mb-10 pb-10 border-b border-border-light" data-mudurluk="${key}">
                                                <button onclick="pageManager.goToOzetTablosu();" 
                                                    style="display: inline-flex; align-items: center; gap: 6px; padding: 8px 16px; background: linear-gradient(135deg, #8B7355, #6B5344); color: white; border: none; border-radius: 8px; font-size: 13px; font-weight: 500; cursor: pointer; margin-bottom: 16px; transition: all 0.2s ease; box-shadow: 0 2px 4px rgba(107,83,68,0.2);"
                                                    onmouseover="this.style.background='linear-gradient(135deg, #6B5344, #5A4333)'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 8px rgba(107,83,68,0.3)';"
                                                    onmouseout="this.style.background='linear-gradient(135deg, #8B7355, #6B5344)'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(107,83,68,0.2)';">
                                                    <span style="font-size: 16px;">&#8592;</span>
                                                    Özet Tabloya Dön
                                                </button>
                                                ${data.html}
                                            </div>
                                        `).join('')}
                                </div>
                                ` : `
                                <div class="mt-5 p-5 bg-page-bg rounded-lg border-l-4 border-primary">
                                    <h2 class="text-lg font-bold text-text-body mb-2">Rapor Verileri Yükleniyor...</h2>
                                    <p class="text-text-meta m-0">Rapor verileri henüz yüklenmedi. Lütfen sayfayı yenileyin.</p>
                                </div>
                                `}
                            </article>
                            <div class="mt-20 pt-10 border-t border-gray-100 flex flex-col md:flex-row items-center justify-between text-[11px] text-text-meta uppercase tracking-[0.2em] font-medium">
                                <span class="mb-2 md:mb-0">İnsan Kaynakları ve Eğitim Müdürlüğü © 2025</span>
                                <div class="flex items-center space-x-4 opacity-80">
                                    <div class="flex items-center">
                                        <span class="w-1.5 h-1.5 rounded-full bg-green-500 mr-2"></span>
                                        <span>Gizli</span>
                                    </div>
                                    <span class="opacity-30">/</span>
                                    <span>Hizmete Özel</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            },

            filterReports: (mudurlukKey) => {
                reportManager.selectedMudurluk = mudurlukKey;
                const sections = document.querySelectorAll('.mudurluk-rapor-section');

                if (mudurlukKey) {
                    sections.forEach(section => {
                        if (section.getAttribute('data-mudurluk') === mudurlukKey) {
                            section.style.display = 'block';
                        } else {
                            section.style.display = 'none';
                        }
                    });
                } else {
                    sections.forEach(section => {
                        section.style.display = 'block';
                    });
                }
            },

            searchReports: (query) => {
                const searchTerm = query.toLowerCase().trim();
                const sections = document.querySelectorAll('.mudurluk-rapor-section');

                sections.forEach(section => {
                    const content = section.textContent.toLowerCase();
                    const shouldShow = !searchTerm || content.includes(searchTerm);
                    section.style.display = shouldShow ? 'block' : 'none';
                });
            },

            quickNavigate: (value) => {
                if (!value) return;
                
                // Filtreyi ayarla ve scroll
                const filter = document.getElementById('mudurlukFilter');
                if (filter) {
                    filter.value = value;
                    reportManager.filterReports(value);
                }
                setTimeout(() => {
                    const section = document.querySelector(`.mudurluk-rapor-section[data-mudurluk="${value}"]`);
                    if (section) {
                        section.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                }, 100);
                
                // Dropdown'ı sıfırla
                const quickSelect = document.getElementById('quickMudurlukSelect');
                if (quickSelect) quickSelect.value = '';
            }
        };

        const pageManager = {
            pages: {
                'veri-girisi': () => `
                    <div class="max-w-7xl mx-auto">
                        <div class="bg-white rounded-2xl shadow-soft p-8 border border-border-light mb-6">
                            <h2 class="font-serif text-2xl font-semibold text-title-brown mb-4">Veri Girişi</h2>
                            <p class="text-sm text-text-meta mb-6">Excel veya Sheets'ten kopyalayarak veri yapıştırabilirsiniz.</p>
                            
                            <div class="flex flex-wrap gap-3 mb-4">
                                <button class="px-4 py-2 bg-page-bg text-text-sidebar border border-border-light rounded-lg text-sm font-medium hover:bg-white transition-all flex items-center gap-2" onclick="dataInput.addTableRows(10)">
                                    <span class="material-icons-outlined text-base">add</span> 10 Satır Ekle
                                </button>
                                <button class="px-4 py-2 bg-page-bg text-text-sidebar border border-border-light rounded-lg text-sm font-medium hover:bg-white transition-all flex items-center gap-2" onclick="dataInput.addTableRows(20)">
                                    <span class="material-icons-outlined text-base">add</span> 20 Satır Ekle
                                </button>
                                <button class="px-4 py-2 bg-red-50 text-red-600 border border-red-200 rounded-lg text-sm font-medium hover:bg-red-100 transition-all flex items-center gap-2" onclick="dataInput.clearTableData()">
                                    <span class="material-icons-outlined text-base">delete_sweep</span> Tabloyu Temizle
                                </button>
                                <button class="px-4 py-2 bg-sidebar-active text-white rounded-lg text-sm font-medium hover:opacity-90 transition-all flex items-center gap-2" onclick="dataInput.processTableData()">
                                    <span class="material-icons-outlined text-base">check_circle</span> Tablodan Verileri İşle
                                </button>
                            </div>
                        </div>
                    
                    <div class="table-container" style="max-height: 60vh;">
                        <table id="dataTable" class="excel-table">
                            <thead>
                                <tr>
                                    <th style="min-width: 100px;">#</th>
                                    ${Array.from({length: 49}, (_, i) => `<th>S${i + 1}</th>`).join('')}
                                    <th style="min-width: 80px;">Sigara</th>
                                    <th style="min-width: 200px;">Sosyal Medya</th>
                                    <th>IG_Bel</th><th>IG_Bşk</th><th>TW_Bel</th><th>TW_Bşk</th>
                                    <th>FB_Bel</th><th>FB_Bşk</th><th>NX_Bel</th><th>NX_Bşk</th>
                                    <th style="min-width: 200px;">Açık Uçlu</th>
                                </tr>
                            </thead>
                            <tbody id="dataTableBody"></tbody>
                        </table>
                    </div>
                    
                    <div id="processStatus" style="margin-top: 20px;"></div>
                `,

                'girilen-anketler': () => `
                    <div class="max-w-7xl mx-auto">
                        <div class="bg-white rounded-2xl shadow-soft p-8 border border-border-light mb-6">
                            <h2 class="font-serif text-2xl font-semibold text-title-brown mb-4">Girilen Anketler</h2>
                            <p class="text-sm text-text-meta mb-6">Sisteme girilen tüm anketleri müdürlük bazında görüntüleyin ve yönetin.</p>
                            
                            <div class="grid grid-cols-3 gap-4 mb-6">
                                <div class="bg-page-bg p-5 rounded-xl border border-border-light text-center">
                                    <p class="text-sm text-text-meta mb-1">Toplam Anket</p>
                                    <p id="toplamAnketSayisi" class="text-3xl font-bold text-title-brown">0</p>
                                </div>
                                <div class="bg-green-50 p-5 rounded-xl border border-green-200 text-center">
                                    <p class="text-sm text-green-600 mb-1">Geçerli Anket</p>
                                    <p id="gecerliAnketSayisi" class="text-3xl font-bold text-green-700">0</p>
                                </div>
                                <div class="bg-red-50 p-5 rounded-xl border border-red-200 text-center">
                                    <p class="text-sm text-red-600 mb-1">Geçersiz Anket</p>
                                    <p id="gecersizAnketSayisi" class="text-3xl font-bold text-red-700">0</p>
                                </div>
                            </div>
                            
                            <div class="overflow-x-auto rounded-xl border border-border-light">
                                <table class="w-full">
                                    <thead class="bg-page-bg">
                                <tr>
                                    <th>Müdürlük</th>
                                    <th>Toplam Anket</th>
                                    <th>Geçerli</th>
                                    <th>Geçersiz</th>
                                    <th>Anket Kodları</th>
                                    <th>İşlemler</th>
                                </tr>
                            </thead>
                            <tbody id="girilenAnketlerBody">
                                <tr><td colspan="6" style="text-align:center; padding:30px;">Henüz anket girişi yapılmamış...</td></tr>
                            </tbody>
                        </table>
                    </div>
                `,
                
                'giris-loglari': () => `
                    <div class="max-w-5xl mx-auto">
                        <div class="bg-white rounded-2xl shadow-soft p-8 border border-border-light">
                            <div class="flex justify-between items-center mb-6">
                                <div>
                                    <h2 class="font-serif text-2xl font-semibold text-title-brown mb-2">Giriş Logları</h2>
                                    <p class="text-sm text-text-meta">Sisteme yapılan tüm giriş denemeleri</p>
                                </div>
                                <button onclick="loadAccessLogs()" class="px-4 py-2 bg-sidebar-active text-white rounded-lg text-sm font-medium hover:opacity-90 transition-all flex items-center gap-2">
                                    <span class="material-icons-outlined text-base">refresh</span> Yenile
                                </button>
                            </div>
                            
                            <div class="overflow-x-auto rounded-xl border border-border-light">
                                <table class="w-full">
                                    <thead class="bg-page-bg">
                                        <tr>
                                            <th class="px-4 py-3 text-left text-sm font-semibold text-title-brown">Tarih/Saat</th>
                                            <th class="px-4 py-3 text-left text-sm font-semibold text-title-brown">IP Adresi</th>
                                            <th class="px-4 py-3 text-left text-sm font-semibold text-title-brown">Tarayıcı</th>
                                            <th class="px-4 py-3 text-center text-sm font-semibold text-title-brown">Durum</th>
                                        </tr>
                                    </thead>
                                    <tbody id="accessLogsBody">
                                        <tr><td colspan="4" class="text-center py-8 text-text-meta">Yükleniyor...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `,

                'genel-skorlar': () => `
                    <div class="max-w-7xl mx-auto space-y-6">
                        <div class="bg-white rounded-2xl shadow-soft p-8 border border-border-light">
                            <h2 class="font-serif text-2xl font-semibold text-title-brown mb-2">Genel Bakış</h2>
                            <p class="text-text-meta text-sm mb-6">
                                Arnavutköy Belediyesi genelindeki katılım ve memnuniyet düzeylerini gösteren bu bölüm.
                            </p>
                            <div id="genelBakisCards"></div>
                        </div>
                        
                        <div class="bg-white rounded-2xl shadow-soft p-8 border border-border-light">
                            <div class="flex justify-between items-center mb-2">
                                <h2 class="font-serif text-2xl font-semibold text-title-brown">En Memnun Müdürlükler</h2>
                                <button class="px-4 py-2 bg-page-bg text-text-sidebar border border-border-light rounded-full text-sm font-medium hover:bg-white transition-all flex items-center gap-2" onclick="surveyManager.toggleAllDepts()">
                                    <span id="toggleDeptText">Tümünü Gör</span>
                                    <span class="material-icons-outlined text-base">arrow_forward</span>
                                </button>
                            </div>
                            <p class="text-text-meta text-sm mb-6">
                                Çalışan memnuniyetinin en yüksek olduğu müdürlükleri keşfedin. Bu müdürlüklerin başarılı uygulamaları diğerlerine örnek olabilir.
                            </p>
                            <div id="enMemnunMudurlukler"></div>
                        </div>
                        
                        <div class="bg-white rounded-2xl shadow-soft p-8 border border-border-light">
                            <div class="mb-6 p-4 bg-page-bg rounded-lg border-l-4 border-primary">
                                <p class="text-sm text-text-body"><strong class="font-semibold">Açıklama:</strong> Tüm müdürlüklerin genel performans skorları ve JD-R dengesi. <em class="text-text-meta">Başlıklara tıklayarak sıralayın</em></p>
                            </div>
                            
                            <div class="mb-4">
                                ${tableRenderer.createFilterBar('filterGenelInput', 'genelSkorlarTable')}
                            </div>
                            
                            <div id="genelSkorlarTableWrapper" class="sticky-table-wrapper">
                                <table id="genelSkorlarTable">
                                    <thead class="bg-page-bg">
                                        <tr>
                                            ${tableRenderer.createSortableHeader('Müdürlükler', 'genelSkorlarTable', 0)}
                                            ${tableRenderer.createSortableHeader('Toplam Personel', 'genelSkorlarTable', 1)}
                                            ${tableRenderer.createSortableHeader('Toplam Katılan', 'genelSkorlarTable', 2)}
                                            ${tableRenderer.createSortableHeader('Katılmayan', 'genelSkorlarTable', 3)}
                                            ${tableRenderer.createSortableHeader('Geçerli Anket', 'genelSkorlarTable', 4)}
                                            ${tableRenderer.createSortableHeader('Geçersiz Anket', 'genelSkorlarTable', 5)}
                                            ${tableRenderer.createSortableHeader('Katılım Oranı (%)', 'genelSkorlarTable', 6)}
                                            ${tableRenderer.createSortableHeader('Genel Memnuniyet (%)', 'genelSkorlarTable', 7)}
                                            ${tableRenderer.createSortableHeader('İş Yükü/Stresi (%)', 'genelSkorlarTable', 8)}
                                            ${tableRenderer.createSortableHeader('Kurum Desteği (%)', 'genelSkorlarTable', 9)}
                                            ${tableRenderer.createSortableHeader('İş Yükü-Destek Dengesi', 'genelSkorlarTable', 10)}
                                        </tr>
                                    </thead>
                                    <tbody id="genelSkorlarBody">
                                        <tr><td colspan="11" class="text-center py-8 text-text-meta">Lütfen veri girişi yapınız...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `,

                'sosyal-medya': () => `
                    <div class="max-w-7xl mx-auto space-y-6">
                        <div id="sosyalMedyaDashboard"></div>
                        
                        <div class="bg-white rounded-2xl shadow-soft p-8 border border-border-light">
                            <h3 class="font-serif text-2xl font-semibold text-title-brown mb-4">Detaylı Platform Analizi</h3>
                            
                            <div class="mb-6 p-4 bg-page-bg rounded-lg border-l-4 border-primary">
                                <p class="text-sm text-text-body"><strong class="font-semibold">Açıklama:</strong> Müdürlüklerin belediye ve başkan sosyal medya hesaplarını takip oranları. <em class="text-text-meta">Başlıklara tıklayarak sıralayın</em></p>
                            </div>
                            
                            <div class="mb-4">
                                ${tableRenderer.createFilterBar('filterSosyalInput', 'sosyalMedyaTable')}
                            </div>
                    
                    <div id="sosyalMedyaTableWrapper" class="sticky-table-wrapper">
                        <table id="sosyalMedyaTable">
                            <thead>
                                <tr>
                                    ${tableRenderer.createSortableHeader('Müdürlükler', 'sosyalMedyaTable', 0)}
                                    ${tableRenderer.createSortableHeader('<svg width="16" height="16" viewBox="0 0 24 24" fill="#E1306C" style="vertical-align: middle; margin-right: 4px;"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/></svg> Belediye', 'sosyalMedyaTable', 1)}
                                    ${tableRenderer.createSortableHeader('<svg width="16" height="16" viewBox="0 0 24 24" fill="#E1306C" style="vertical-align: middle; margin-right: 4px;"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/></svg> Başkan', 'sosyalMedyaTable', 2)}
                                    ${tableRenderer.createSortableHeader('<svg width="16" height="16" viewBox="0 0 24 24" fill="#1DA1F2" style="vertical-align: middle; margin-right: 4px;"><path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"/></svg> Belediye', 'sosyalMedyaTable', 3)}
                                    ${tableRenderer.createSortableHeader('<svg width="16" height="16" viewBox="0 0 24 24" fill="#1DA1F2" style="vertical-align: middle; margin-right: 4px;"><path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"/></svg> Başkan', 'sosyalMedyaTable', 4)}
                                    ${tableRenderer.createSortableHeader('<svg width="16" height="16" viewBox="0 0 24 24" fill="#4267B2" style="vertical-align: middle; margin-right: 4px;"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg> Belediye', 'sosyalMedyaTable', 5)}
                                    ${tableRenderer.createSortableHeader('<svg width="16" height="16" viewBox="0 0 24 24" fill="#4267B2" style="vertical-align: middle; margin-right: 4px;"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg> Başkan', 'sosyalMedyaTable', 6)}
                                    ${tableRenderer.createSortableHeader('<svg width="16" height="16" viewBox="0 0 24 24" fill="#6B46C1" style="vertical-align: middle; margin-right: 4px;"><circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2"/><path d="M12 6v6l4 2"/></svg> Belediye', 'sosyalMedyaTable', 7)}
                                    ${tableRenderer.createSortableHeader('<svg width="16" height="16" viewBox="0 0 24 24" fill="#6B46C1" style="vertical-align: middle; margin-right: 4px;"><circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2"/><path d="M12 6v6l4 2"/></svg> Başkan', 'sosyalMedyaTable', 8)}
                                </tr>
                            </thead>
                            <tbody id="sosyalMedyaBody">
                                <tr><td colspan="9" style="text-align:center; padding:30px;">Lütfen veri girişi yapınız...</td></tr>
                            </tbody>
                        </table>
                    </div>
                `,

                'ruh-sagligi': () => `
                    <div class="max-w-7xl mx-auto">
                        <div class="bg-white rounded-2xl shadow-soft p-8 border border-border-light">
                            <h2 class="font-serif text-2xl font-semibold text-title-brown mb-4">Ruh Sağlığı Taraması</h2>
                            
                            <div class="mb-6 p-4 bg-amber-50 rounded-lg border-l-4 border-amber-500">
                                <p class="text-sm text-amber-800"><strong class="font-semibold">Önemli:</strong> Ruh sağlığı taraması skorlarında yüksek değerler olumsuz durumu gösterir. <em>Başlıklara tıklayarak sıralayın</em></p>
                            </div>
                            
                            <div class="mb-4">
                                ${tableRenderer.createFilterBar('filterRuhInput', 'ruhSagligiTable')}
                            </div>
                    
                    <div id="ruhSagligiTableWrapper" class="sticky-table-wrapper">
                        <table id="ruhSagligiTable">
                            <thead>
                                <tr>
                                    ${tableRenderer.createSortableHeader('Müdürlükler', 'ruhSagligiTable', 0)}
                                    ${tableRenderer.createSortableHeader('Ruh Sağlığı Genel (%)', 'ruhSagligiTable', 1)}
                                    ${tableRenderer.createSortableHeader('Sigara Kullanımı (%)', 'ruhSagligiTable', 2)}
                                    ${tableRenderer.createSortableHeader('S46: Keyif Alamama', 'ruhSagligiTable', 3)}
                                    ${tableRenderer.createSortableHeader('S47: Üzgün/Çökkün', 'ruhSagligiTable', 4)}
                                    ${tableRenderer.createSortableHeader('S48: Gergin/Kaygılı', 'ruhSagligiTable', 5)}
                                    ${tableRenderer.createSortableHeader('S49: Endişe Kontrolü', 'ruhSagligiTable', 6)}
                                </tr>
                            </thead>
                            <tbody id="ruhSagligiBody">
                                <tr><td colspan="7" style="text-align:center; padding:30px;">Lütfen veri girişi yapınız...</td></tr>
                            </tbody>
                        </table>
                    </div>
                `,

                'temalar': () => `
                    <div class="max-w-7xl mx-auto">
                        <div class="bg-white rounded-2xl shadow-soft p-8 border border-border-light">
                            <h2 class="font-serif text-2xl font-semibold text-title-brown mb-4">Konular Üzerinden Analiz</h2>
                            
                            <div class="mb-6 p-4 bg-page-bg rounded-lg border-l-4 border-primary">
                                <p class="text-sm text-text-body"><strong class="font-semibold">Açıklama:</strong> Her temanın müdürlük bazında detaylı analizi. <em class="text-text-meta">Başlıklara tıklayarak sıralayın</em></p>
                            </div>
                            
                            <div class="mb-4">
                                ${tableRenderer.createFilterBar('filterTemalarInput', 'temalarTable')}
                            </div>
                    
                    <div id="temalarTableWrapper" class="sticky-table-wrapper">
                        <table id="temalarTable">
                            <thead>
                                <tr>
                                    ${tableRenderer.createSortableHeader('Müdürlükler', 'temalarTable', 0)}
                                    ${tableRenderer.createSortableHeader('İş-Kişi Uyumu', 'temalarTable', 1)}
                                    ${tableRenderer.createSortableHeader('Görev-Rol Netliği', 'temalarTable', 2)}
                                    ${tableRenderer.createSortableHeader('İş Yükü/Stresi', 'temalarTable', 3)}
                                    ${tableRenderer.createSortableHeader('Yöneticilerle İlişkiler', 'temalarTable', 4)}
                                    ${tableRenderer.createSortableHeader('Çalışma Arkadaşları', 'temalarTable', 5)}
                                    ${tableRenderer.createSortableHeader('Kurum İçi İletişim', 'temalarTable', 6)}
                                    ${tableRenderer.createSortableHeader('Çalışma Koşulları', 'temalarTable', 7)}
                                    ${tableRenderer.createSortableHeader('Kamu Hizmeti Motivasyonu', 'temalarTable', 8)}
                                    ${tableRenderer.createSortableHeader('Yetkinlik & Performans', 'temalarTable', 9)}
                                    ${tableRenderer.createSortableHeader('Eğitim & Gelişim', 'temalarTable', 10)}
                                </tr>
                            </thead>
                            <tbody id="temalarBody">
                                <tr><td colspan="11" style="text-align:center; padding:30px;">Lütfen veri girişi yapınız...</td></tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <h2 style="font-size: 20px; font-weight: 700; margin: 40px 0 15px 0; color: #1a1a1a;">📊 Genel Belediye Oranları</h2>
                    <p style="color: #6b7280; font-size: 14px; margin-bottom: 20px;">
                        Her temanın <strong>anket sorularından</strong> hesaplanan performans skoru ve <strong>açık uçlu yorumlardan</strong> elde edilen nitel bulgular bir arada.
                    </p>
                    
                    <div id="themeCardsContainer"></div>
                `,

                'sorular': () => `
                    <div style="max-width: 100%; margin: 0 auto;">
                        <div class="bg-white rounded-2xl shadow-soft p-8 border border-border-light">
                            <h2 class="font-serif text-2xl font-semibold text-title-brown mb-4">Sorular Üzerinden Analiz</h2>
                            
                            <div class="mb-6 p-4 bg-page-bg rounded-lg border-l-4 border-primary">
                                <p class="text-sm text-text-body font-semibold mb-2">Açıklama:</p>
                                <ul class="text-sm text-text-meta list-disc list-inside space-y-1">
                                    <li>Belirli bir <strong>soru</strong> seçerek müdürlüklerin o sorudaki performansını karşılaştırabilirsiniz.</li>
                                    <li>Bir <strong>müdürlük</strong> seçerek tüm sorulardaki performansını inceleyebilirsiniz.</li>
                                    <li>Sütun başlıklarına tıklayarak sıralama yapabilirsiniz.</li>
                                </ul>
                                <p class="text-xs text-text-meta mt-3 italic">* Psikolojik Tarama soruları (S46, S47, S48, S49) ters puanlanır: Düşük değerler psikolojik riskin az olduğunu gösterir ve olumlu olarak değerlendirilir.</p>
                            </div>
                            
                            <div class="flex flex-wrap gap-4 mb-6 items-center">
                                <div class="bg-page-bg p-4 rounded-xl border border-border-light flex items-center gap-3 flex-wrap">
                                    <label for="mudurlukSoruSelect" class="text-sm font-semibold text-text-body whitespace-nowrap">Müdürlük Seç:</label>
                                    <select id="mudurlukSoruSelect" onchange="sorularManager.selectMudurluk()" class="min-w-[300px] px-3 py-2 border border-border-light rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary/50">
                                        <option value="">-- Tüm Müdürlükler --</option>
                                    </select>
                                </div>
                                <div class="bg-page-bg p-4 rounded-xl border border-border-light flex items-center gap-3 flex-wrap">
                                    <label for="soruSelect" class="text-sm font-semibold text-text-body whitespace-nowrap">Soru Seç:</label>
                                    <select id="soruSelect" onchange="sorularManager.selectQuestion()" class="min-w-[350px] px-3 py-2 border border-border-light rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary/50">
                                        <option value="">-- Tüm Sorular --</option>
                                    </select>
                                </div>
                                <button class="px-4 py-2 bg-white text-text-sidebar border border-border-light rounded-lg text-sm font-medium hover:bg-page-bg transition-all flex items-center gap-2" onclick="sorularManager.resetFilters()">
                                    <span class="material-icons-outlined text-base">refresh</span> Sıfırla
                                </button>
                            </div>
                    
                    <div id="sorularTableWrapper">
                        <table id="sorularTable">
                            <thead id="sorularTableHead">
                                <tr>
                                    <th>Soru</th>
                                </tr>
                            </thead>
                            <tbody id="sorularBody">
                                <tr><td style="text-align:center; padding:30px;">Lütfen veri girişi yapınız...</td></tr>
                            </tbody>
                        </table>
                    </div>
                `,

                'acik-uclu': () => `
                    <div class="max-w-7xl mx-auto">
                        <div class="bg-white rounded-2xl shadow-soft p-8 border border-border-light">
                            <div class="mb-6">
                                <h2 class="font-serif text-2xl font-semibold text-title-brown mb-2">Açık Uçlu Cevaplar</h2>
                                <p class="text-sm text-text-meta">Müdürlük bazında en çok tekrarlanan kelimeler ve tüm açık uçlu cevaplar. Kelimeler üzerine gelerek detayları görebilir, cevap sayısına tıklayarak tüm cevapları okuyabilirsiniz.</p>
                            </div>
                    
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th style="min-width: 250px;">Müdürlük</th>
                                    <th style="min-width: 400px;">En Çok Geçen Kelimeler (Top 5)</th>
                                    <th style="min-width: 120px;">Toplam Cevap</th>
                                </tr>
                            </thead>
                            <tbody id="acikUcluBody">
                                <tr><td colspan="3" style="text-align:center; padding:30px;">Lütfen veri girişi yapınız...</td></tr>
                            </tbody>
                        </table>
                    </div>

                    <div id="responsesContainer" class="responses-container"></div>
                `,

                'mudurluk-karsilastir': () => `
                    <div class="max-w-7xl mx-auto">
                        <div class="bg-white rounded-2xl shadow-soft p-8 border border-border-light">
                            <h2 class="font-serif text-2xl font-semibold text-title-brown mb-4">Müdürlük Karşılaştırma</h2>
                            
                            <div class="mb-6 p-4 bg-page-bg rounded-lg border-l-4 border-primary">
                                <p class="text-sm text-text-body"><strong class="font-semibold">Açıklama:</strong> İki müdürlüğü yan yana karşılaştırarak güçlü ve zayıf yönlerini analiz edin.</p>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-6 mb-6">
                                <div class="bg-page-bg p-5 rounded-xl border border-border-light">
                                    <label class="font-semibold text-text-body mb-2 block text-sm">1. Müdürlük Seçin:</label>
                                    <select id="karsilastir1" onchange="comparisonManager.updateComparison()" class="w-full px-3 py-2 border border-border-light rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary/50">
                                        <option value="">-- Müdürlük Seçiniz --</option>
                                    </select>
                                </div>
                                <div class="bg-page-bg p-5 rounded-xl border border-border-light">
                                    <label class="font-semibold text-text-body mb-2 block text-sm">2. Müdürlük Seçin:</label>
                                    <select id="karsilastir2" onchange="comparisonManager.updateComparison()" class="w-full px-3 py-2 border border-border-light rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary/50">
                                        <option value="">-- Müdürlük Seçiniz --</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="comparisonResult"></div>
                `,

                'mudurluk-sec': () => `
                    <div class="max-w-7xl mx-auto">
                        <div class="bg-white rounded-2xl shadow-soft p-8 border border-border-light">
                            <h2 class="font-serif text-2xl font-semibold text-title-brown mb-4">Müdürlük Detay Analizi</h2>
                            
                            <div class="mb-6 p-4 bg-page-bg rounded-lg border-l-4 border-primary">
                                <p class="text-sm text-text-body"><strong class="font-semibold">Açıklama:</strong> Seçili müdürlüğü genel belediye ortalamasıyla karşılaştırın.</p>
                            </div>
                            
                            <div class="mb-6 flex items-center gap-4">
                                <label for="mudurlukSelect" class="font-semibold text-text-body text-sm">Müdürlük Seçin:</label>
                                <select id="mudurlukSelect" onchange="surveyManager.updateMudurlukAnalysis()" class="min-w-[300px] px-3 py-2 border border-border-light rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary/50">
                                    <option value="">-- Müdürlük Seçiniz --</option>
                                </select>
                            </div>
                    <div class="table-container">
                        <table id="mudurlukSecTable">
                            <thead>
                                <tr>
                                    <th style="min-width:400px;">Soru</th>
                                    <th>Genel Belediye (%)</th>
                                    <th>Seçili Müdürlük</th>
                                    <th>Seçili Müdürlük (%)</th>
                                    <th>Fark</th>
                                </tr>
                            </thead>
                            <tbody id="mudurlukSecBody">
                                <tr><td colspan="5" style="text-align:center; padding:30px;">Lütfen müdürlük seçiniz...</td></tr>
                            </tbody>
                        </table>
                    </div>
                `,

                'mudurluk-raporlari': () => reportManager.renderReportPage(),

                'belediye-geneli': () => `
                    <div class="iframe-fullscreen-container">
                        <iframe 
                            id="belediyeGeneliIframe"
                            src="/attached_assets/baskan_raporu_v2-6_1766557449901.html" 
                            style="width: 100%; height: 100%; border: none; background: #FAF8F5;"
                            title="Belediye Geneli Raporu"
                        ></iframe>
                    </div>
                `
            },

            showPage: (pageId) => {
                const contentBody = document.getElementById('contentBody');
                const pageTitle = document.getElementById('pageTitle');

                let menuItem = null;
                MENU_ITEMS.forEach(category => {
                    const found = category.items.find(item => item.id === pageId);
                    if (found) menuItem = found;
                });

                if (menuItem) {
                    pageTitle.textContent = menuItem.title;
                }

                document.querySelectorAll('.menu-item').forEach(item => {
                    item.classList.remove('active');
                });

                const activeMenuItem = document.querySelector(`.menu-item[data-page="${pageId}"]`);
                if (activeMenuItem) {
                    activeMenuItem.classList.add('active');
                }

                if (pageId === 'belediye-geneli') {
                    contentBody.classList.add('no-padding');
                    // Belediye Geneli'ne geçildiğinde seçili müdürlüğü temizle
                    pageManager.selectedMudurluk = null;
                    pageManager.highlightSelectedMudurluk();
                } else {
                    contentBody.classList.remove('no-padding');
                }

                if (pageManager.pages[pageId]) {
                    contentBody.innerHTML = `<div class="page-content active">${pageManager.pages[pageId]()}</div>`;

                    if (pageId === 'veri-girisi') {
                        dataInput.addTableRows(CONFIG.MAX_TABLE_ROWS_INITIAL);
                        setTimeout(() => dataInput.setupPasteHandler(), 100);
                    }


                    if (pageId === 'mudurluk-karsilastir') {
                        setTimeout(() => {
                            comparisonManager.populateSelects();
                            comparisonManager.updateComparison();
                        }, 100);
                    }
                    
                    if (pageId === 'giris-loglari') {
                        setTimeout(() => loadAccessLogs(), 100);
                    }

                    setTimeout(() => tableRenderer.renderAllTables(), 100);
                }
            },

            initMenu: () => {
                const menu = document.getElementById('sidebarMenu');

                MENU_ITEMS.forEach(category => {
                    const categoryDiv = document.createElement('div');
                    categoryDiv.className = 'menu-category';
                    categoryDiv.textContent = category.category;
                    menu.appendChild(categoryDiv);

                    category.items.forEach(item => {
                        const menuItem = document.createElement('div');
                        menuItem.className = item.highlight ? 'menu-item menu-item-highlight' : 'menu-item';
                        menuItem.dataset.page = item.id;
                        const iconColorStyle = item.iconColor ? `style="color: ${item.iconColor};"` : '';
                        const iconClass = item.useSymbols ? 'material-symbols-outlined' : 'material-icons-outlined';
                        menuItem.innerHTML = `
                            <span class="${iconClass} menu-item-icon" ${iconColorStyle}>${item.icon}</span>
                            <span>${item.title}</span>
                        `;
                        menuItem.onclick = () => {
                            if (item.externalLink) {
                                window.location.href = item.externalLink;
                            } else {
                                pageManager.showPage(item.id);
                                closeSidebarIfMobile();
                            }
                        };
                        menu.appendChild(menuItem);
                    });

                    // Rapor kategorisi altına müdürlük hızlı navigasyonu ekle
                    if (category.category === 'RAPOR') {
                        const mudurlukNavContainer = document.createElement('div');
                        mudurlukNavContainer.id = 'mudurlukQuickNav';
                        mudurlukNavContainer.style.cssText = 'padding: 0 12px 8px 12px; margin-top: -2px;';
                        mudurlukNavContainer.innerHTML = `
                            <div style="margin: 0 0 6px 24px; position: relative;">
                                <input type="text" id="mudurlukSearchInput" placeholder="Ara..." oninput="pageManager.filterMudurlukler(this.value)" style="width: calc(100% - 4px); padding: 5px 8px 5px 26px; border: none; border-bottom: 1px solid #E2D9CA; border-radius: 0; font-size: 11px; color: #5A534A; background: transparent; outline: none; transition: all 0.2s;" onfocus="this.style.borderBottomColor='#A89080';" onblur="this.style.borderBottomColor='#E2D9CA';">
                                <span class="material-icons-outlined" style="position: absolute; left: 4px; top: 50%; transform: translateY(-50%); font-size: 14px; color: #B0A99F; pointer-events: none;">search</span>
                            </div>
                            <div id="mudurlukQuickList" style="display: flex; flex-direction: column; gap: 0; background: transparent; border-radius: 8px; padding: 2px 0; margin-left: 20px;"></div>
                            <button id="showAllMudurlukler" onclick="pageManager.toggleAllMudurlukler()" style="display: none; margin: 8px 0 0 20px; padding: 8px 14px; background: transparent; border: 1px dashed #D4C9BB; border-radius: 10px; color: #8C847D; font-size: 11px; cursor: pointer; width: calc(100% - 20px); text-align: center; transition: all 0.25s; font-weight: 500; letter-spacing: 0.02em;">
                                <span class="material-icons-outlined" style="font-size: 13px; vertical-align: middle; margin-right: 4px;">more_horiz</span>Tümünü Göster
                            </button>
                        `;
                        menu.appendChild(mudurlukNavContainer);
                        
                        // Hover effect for button
                        const btn = mudurlukNavContainer.querySelector('#showAllMudurlukler');
                        btn.onmouseover = () => { btn.style.background = 'rgba(168,144,128,0.1)'; btn.style.borderColor = '#A89080'; btn.style.color = '#6B635A'; };
                        btn.onmouseout = () => { btn.style.background = 'transparent'; btn.style.borderColor = '#D4C9BB'; btn.style.color = '#8C847D'; };
                    }
                });

                pageManager.showPage('belediye-geneli');
                
                // Müdürlük listesini doldur
                setTimeout(() => pageManager.populateMudurlukQuickNav(), 500);
            },

            mudurlukNavExpanded: false,

            toggleAllMudurlukler: () => {
                pageManager.mudurlukNavExpanded = !pageManager.mudurlukNavExpanded;
                pageManager.populateMudurlukQuickNav();
            },

            populateMudurlukQuickNav: () => {
                const quickList = document.getElementById('mudurlukQuickList');
                const showAllBtn = document.getElementById('showAllMudurlukler');
                if (!quickList) return;

                // RAPOR_VERILERI varsa müdürlükleri al
                let mudurlukler = [];
                if (typeof RAPOR_VERILERI !== 'undefined' && RAPOR_VERILERI.mudurlukler) {
                    mudurlukler = Object.entries(RAPOR_VERILERI.mudurlukler)
                        .sort((a, b) => a[1].name.localeCompare(b[1].name, 'tr'));
                }

                // Seçili müdürlük varsa en üste taşı
                let visibleMudurlukler = [];
                const selectedKey = pageManager.selectedMudurluk;
                
                if (selectedKey && !pageManager.mudurlukNavExpanded) {
                    // Seçili müdürlüğü bul
                    const selectedEntry = mudurlukler.find(([key]) => key === selectedKey);
                    if (selectedEntry) {
                        // Seçili müdürlük en üstte, sonra diğer 4 tanesi
                        const others = mudurlukler.filter(([key]) => key !== selectedKey).slice(0, 4);
                        visibleMudurlukler = [selectedEntry, ...others];
                    } else {
                        visibleMudurlukler = mudurlukler.slice(0, 5);
                    }
                } else {
                    // Normal davranış
                    const displayCount = pageManager.mudurlukNavExpanded ? mudurlukler.length : 5;
                    visibleMudurlukler = mudurlukler.slice(0, displayCount);
                }

                let html = '';

                visibleMudurlukler.forEach(([key, data]) => {
                    html += `
                        <div class="mudurluk-quick-item" onclick="pageManager.goToMudurlukRapor('${key}')" style="padding: 7px 10px; cursor: pointer; border-radius: 6px; font-size: 12px; color: #7B746A; display: flex; align-items: center; gap: 6px; transition: all 0.2s; white-space: nowrap; overflow: hidden; background: transparent;">
                            <span style="font-size: 13px; opacity: 0.85;">${MUDURLUK_EMOJIS[key] || '📋'}</span>
                            <span style="overflow: hidden; text-overflow: ellipsis; font-weight: 400;">${data.name}</span>
                        </div>
                    `;
                });

                quickList.innerHTML = html;

                // Hover effect ekle
                quickList.querySelectorAll('.mudurluk-quick-item').forEach(item => {
                    const arrow = item.querySelector('.material-icons-outlined');
                    const key = item.getAttribute('onclick')?.match(/'([^']+)'/)?.[1];
                    item.onmouseover = () => { 
                        if (key !== pageManager.selectedMudurluk) {
                            item.style.background = 'rgba(168,144,128,0.15)'; 
                            item.style.color = '#5A534A';
                            if(arrow) { arrow.style.opacity = '1'; arrow.style.transform = 'translateX(2px)'; }
                        }
                    };
                    item.onmouseout = () => { 
                        if (key !== pageManager.selectedMudurluk) {
                            item.style.background = 'transparent'; 
                            item.style.color = '#7B746A';
                            if(arrow) { arrow.style.opacity = '0.5'; arrow.style.transform = 'translateX(0)'; }
                        }
                    };
                });

                // Seçili müdürlüğü vurgula
                pageManager.highlightSelectedMudurluk();

                // Show all button
                if (showAllBtn && mudurlukler.length > 5) {
                    showAllBtn.style.display = 'block';
                    showAllBtn.innerHTML = pageManager.mudurlukNavExpanded 
                        ? '<span class="material-icons-outlined" style="font-size: 13px; vertical-align: middle; margin-right: 4px;">expand_less</span>Daralt'
                        : `<span class="material-icons-outlined" style="font-size: 13px; vertical-align: middle; margin-right: 4px;">more_horiz</span>Tümünü Göster (${mudurlukler.length})`;
                }
            },

            selectedMudurluk: null,

            goToMudurlukRapor: (mudurlukKey) => {
                pageManager.selectedMudurluk = mudurlukKey;
                pageManager.showPage('mudurluk-raporlari');
                pageManager.highlightSelectedMudurluk();
                closeSidebarIfMobile();
                
                setTimeout(() => {
                    const filter = document.getElementById('mudurlukFilter');
                    if (filter) {
                        filter.value = mudurlukKey;
                        reportManager.filterReports(mudurlukKey);
                    }
                    const section = document.querySelector(`.mudurluk-rapor-section[data-mudurluk="${mudurlukKey}"]`);
                    if (section) {
                        section.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                }, 300);
            },

            highlightSelectedMudurluk: () => {
                const items = document.querySelectorAll('.mudurluk-quick-item');
                items.forEach(item => {
                    const key = item.getAttribute('onclick')?.match(/'([^']+)'/)?.[1];
                    if (key === pageManager.selectedMudurluk) {
                        item.style.background = '#8B7355';
                        item.style.color = 'white';
                        item.style.fontWeight = '500';
                        const arrow = item.querySelector('.material-icons-outlined');
                        if (arrow) { arrow.style.opacity = '1'; arrow.style.color = 'white'; }
                    } else {
                        item.style.background = 'transparent';
                        item.style.color = '#7B746A';
                        item.style.fontWeight = '400';
                        const arrow = item.querySelector('.material-icons-outlined');
                        if (arrow) { arrow.style.opacity = '0.5'; arrow.style.color = 'inherit'; }
                    }
                });
            },

            goToOzetTablosu: () => {
                pageManager.pendingScrollToOzet = true;
                pageManager.showPage('belediye-geneli');
                closeSidebarIfMobile();
            },

            filterMudurlukler: (searchTerm) => {
                const quickList = document.getElementById('mudurlukQuickList');
                const showAllBtn = document.getElementById('showAllMudurlukler');
                if (!quickList) return;

                const term = searchTerm.toLowerCase().trim();

                let mudurlukler = [];
                if (typeof RAPOR_VERILERI !== 'undefined' && RAPOR_VERILERI.mudurlukler) {
                    mudurlukler = Object.entries(RAPOR_VERILERI.mudurlukler)
                        .sort((a, b) => a[1].name.localeCompare(b[1].name, 'tr'));
                }

                const filtered = term 
                    ? mudurlukler.filter(([key, data]) => data.name.toLowerCase().includes(term))
                    : mudurlukler.slice(0, pageManager.mudurlukNavExpanded ? mudurlukler.length : 5);

                let html = '';
                filtered.forEach(([key, data]) => {
                    html += `
                        <div class="mudurluk-quick-item" onclick="pageManager.goToMudurlukRapor('${key}')" style="padding: 7px 10px; cursor: pointer; border-radius: 6px; font-size: 12px; color: #7B746A; display: flex; align-items: center; gap: 6px; transition: all 0.2s; white-space: nowrap; overflow: hidden; background: transparent;">
                            <span style="font-size: 13px; opacity: 0.85;">${MUDURLUK_EMOJIS[key] || '📋'}</span>
                            <span style="overflow: hidden; text-overflow: ellipsis; font-weight: 400;">${data.name}</span>
                        </div>
                    `;
                });

                if (filtered.length === 0 && term) {
                    html = '<div style="padding: 12px; color: #A89080; font-size: 11px; text-align: center;">Sonuç bulunamadı</div>';
                }

                quickList.innerHTML = html;

                quickList.querySelectorAll('.mudurluk-quick-item').forEach(item => {
                    const arrow = item.querySelector('.material-icons-outlined');
                    const key = item.getAttribute('onclick')?.match(/'([^']+)'/)?.[1];
                    item.onmouseover = () => { 
                        if (key !== pageManager.selectedMudurluk) {
                            item.style.background = 'rgba(168,144,128,0.15)'; 
                            item.style.color = '#5A534A';
                            if(arrow) { arrow.style.opacity = '1'; arrow.style.transform = 'translateX(2px)'; }
                        }
                    };
                    item.onmouseout = () => { 
                        if (key !== pageManager.selectedMudurluk) {
                            item.style.background = 'transparent'; 
                            item.style.color = '#7B746A';
                            if(arrow) { arrow.style.opacity = '0.5'; arrow.style.transform = 'translateX(0)'; }
                        }
                    };
                });

                pageManager.highlightSelectedMudurluk();

                if (showAllBtn) {
                    showAllBtn.style.display = term ? 'none' : (mudurlukler.length > 5 ? 'block' : 'none');
                }
            }
        };

        // Auth token helper
        function getAuthToken() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('token') || localStorage.getItem('authToken') || '';
        }

        function getAuthHeaders() {
            const token = getAuthToken();
            return token ? { 'X-Auth-Token': token } : {};
        }

        // Database API Helper
        const databaseAPI = {
            async loadData() {
                try {
                    const response = await fetch('/api/survey-data', {
                        headers: getAuthHeaders()
                    });
                    const result = await response.json();

                    if (result.success && result.data) {
                        state.allSurveys = result.data.allSurveys || [];

                        const aiInsights = result.data.aiInsights;
                        if (aiInsights) {
                            localStorage.setItem('aiInsights', JSON.stringify(aiInsights));
                        }

                        if (state.allSurveys.length > 0) {
                            state.processedData = dataProcessor.analyzeAllData(state.allSurveys);
                            console.log(`✅ Veritabanından ${state.allSurveys.length} anket yüklendi`);
                        }
                    }
                } catch (error) {
                    console.error('❌ Veritabanından veri yüklenemedi:', error);
                    utils.showMessage('⚠️ Veriler yükleniyor...', 'warning');
                }
            },

            async saveData() {
                try {
                    const aiInsights = unifiedPriorityManager.getAIInsights();

                    const response = await fetch('/api/survey-data', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            ...getAuthHeaders()
                        },
                        body: JSON.stringify({
                            allSurveys: state.allSurveys,
                            aiInsights: aiInsights
                        })
                    });

                    const result = await response.json();

                    if (result.success) {
                        console.log('✅ Veriler veritabanına kaydedildi');
                        return true;
                    } else {
                        console.error('❌ Kayıt hatası:', result.error);
                        return false;
                    }
                } catch (error) {
                    console.error('❌ Veritabanına kaydetme hatası:', error);
                    return false;
                }
            }
        };

        const csvExporter = {
            exportSorular: () => {
                if (!state.processedData || Object.keys(state.processedData).length === 0) {
                    utils.showMessage('⚠️ CSV indirmek için önce veri girişi yapın!', 'warning');
                    return;
                }

                const genelBelediyeSorular = tableRenderer.calculateGenelBelediyeSorular();
                const mudurlukler = Object.values(state.processedData);

                let csvContent = '\uFEFF';

                const headers = ['Soru', 'GENEL BELEDİYE'];
                mudurlukler.forEach(md => {
                    headers.push(`#${md.kod} - ${md.ad}`);
                });
                csvContent += headers.map(h => `"${h}"`).join(',') + '\n';

                SORULAR.forEach((soru, i) => {
                    const row = [];
                    row.push(`"S${i + 1}. ${soru.replace(/"/g, '""')}"`);
                    row.push(`${genelBelediyeSorular[i]}%`);

                    mudurlukler.forEach(md => {
                        row.push(`${md.soruOrtalamalar[i]}%`);
                    });

                    csvContent += row.join(',') + '\n';
                });

                const blob = new Blob([csvContent], {type: 'text/csv;charset=utf-8;'});
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);

                const today = new Date().toISOString().split('T')[0];
                link.setAttribute('href', url);
                link.setAttribute('download', `sorular_analiz_${today}.csv`);
                link.style.visibility = 'hidden';

                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                utils.showMessage('✅ CSV dosyası indirildi!', 'success');
            },

            exportGenelSkorlar: () => {
                if (!state.processedData || Object.keys(state.processedData).length === 0) {
                    utils.showMessage('⚠️ CSV indirmek için önce veri girişi yapın!', 'warning');
                    return;
                }

                const mudurlukler = Object.values(state.processedData);
                const genelBelediye = tableRenderer.calculateGenelBelediye();

                if (!genelBelediye) {
                    utils.showMessage('⚠️ Genel veriler hesaplanamadı!', 'error');
                    return;
                }

                let csvContent = '\uFEFF';

                const headers = ['Müdürlükler', 'Toplam Personel', 'Toplam Katılan', 'Katılmayan', 'Geçerli Anket', 'Geçersiz Anket',
                    'Katılım Oranı (%)', 'Genel Memnuniyet (%)', 'İş Yükü/Stresi (%)', 'Kurum Desteği (%)', 'İş Yükü-Destek Dengesi'];
                csvContent += headers.map(h => `"${h}"`).join(',') + '\n';

                const genelRow = [
                    '"GENEL BELEDİYE"',
                    genelBelediye.toplamPersonel,
                    genelBelediye.anketler.length,
                    genelBelediye.toplamPersonel - genelBelediye.anketler.length,
                    genelBelediye.gecerliAnketler.length,
                    genelBelediye.gecersizAnketler.length,
                    genelBelediye.katilimOrani,
                    genelBelediye.genelMemnuniyet,
                    genelBelediye.isYuku,
                    genelBelediye.kurumDestegi,
                    genelBelediye.denge
                ];
                csvContent += genelRow.join(',') + '\n';

                mudurlukler.forEach(md => {
                    const row = [
                        `"#${md.kod} - ${md.ad}"`,
                        md.toplamPersonel,
                        md.anketler?.length || 0,
                        md.toplamPersonel - (md.anketler?.length || 0),
                        md.gecerliAnketler?.length || 0,
                        md.gecersizAnketler?.length || 0,
                        md.katilimOrani,
                        md.genelMemnuniyet,
                        md.isYuku,
                        md.kurumDestegi,
                        md.denge
                    ];
                    csvContent += row.join(',') + '\n';
                });

                const blob = new Blob([csvContent], {type: 'text/csv;charset=utf-8;'});
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                const today = new Date().toISOString().split('T')[0];
                link.setAttribute('href', url);
                link.setAttribute('download', `genel_skorlar_${today}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                utils.showMessage('✅ CSV dosyası indirildi!', 'success');
            },

            exportSosyalMedya: () => {
                if (!state.processedData || Object.keys(state.processedData).length === 0) {
                    utils.showMessage('⚠️ CSV indirmek için önce veri girişi yapın!', 'warning');
                    return;
                }

                const mudurlukler = Object.values(state.processedData);
                const genelBelediye = tableRenderer.calculateGenelBelediyeAggregate('sosyalMedya');

                if (!genelBelediye || !genelBelediye.detay) {
                    utils.showMessage('⚠️ Sosyal medya verileri hesaplanamadı!', 'error');
                    return;
                }

                let csvContent = '\uFEFF';

                const headers = ['Müdürlükler', 'Instagram Belediye', 'Instagram Başkan', 'Twitter Belediye',
                    'Twitter Başkan', 'Facebook Belediye', 'Facebook Başkan', 'NextSosyal Belediye', 'NextSosyal Başkan'];
                csvContent += headers.map(h => `"${h}"`).join(',') + '\n';

                const genelRow = [
                    '"GENEL BELEDİYE"',
                    `${genelBelediye.detay.instagram_belediye}%`,
                    `${genelBelediye.detay.instagram_baskan}%`,
                    `${genelBelediye.detay.twitter_belediye}%`,
                    `${genelBelediye.detay.twitter_baskan}%`,
                    `${genelBelediye.detay.facebook_belediye}%`,
                    `${genelBelediye.detay.facebook_baskan}%`,
                    `${genelBelediye.detay.nextsosyal_belediye}%`,
                    `${genelBelediye.detay.nextsosyal_baskan}%`
                ];
                csvContent += genelRow.join(',') + '\n';

                mudurlukler.forEach(md => {
                    const sm = md.sosyalMedya.detay;
                    const row = [
                        `"#${md.kod} - ${md.ad}"`,
                        `${sm.instagram_belediye}%`,
                        `${sm.instagram_baskan}%`,
                        `${sm.twitter_belediye}%`,
                        `${sm.twitter_baskan}%`,
                        `${sm.facebook_belediye}%`,
                        `${sm.facebook_baskan}%`,
                        `${sm.nextsosyal_belediye}%`,
                        `${sm.nextsosyal_baskan}%`
                    ];
                    csvContent += row.join(',') + '\n';
                });

                const blob = new Blob([csvContent], {type: 'text/csv;charset=utf-8;'});
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                const today = new Date().toISOString().split('T')[0];
                link.setAttribute('href', url);
                link.setAttribute('download', `sosyal_medya_${today}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                utils.showMessage('✅ CSV dosyası indirildi!', 'success');
            },

            exportRuhSagligi: () => {
                if (!state.processedData || Object.keys(state.processedData).length === 0) {
                    utils.showMessage('⚠️ CSV indirmek için önce veri girişi yapın!', 'warning');
                    return;
                }

                const mudurlukler = Object.values(state.processedData);
                const genelBelediye = tableRenderer.calculateGenelBelediyeRuhSagligi();

                if (!genelBelediye || !genelBelediye.ruhSagligiDetay) {
                    utils.showMessage('⚠️ Ruh sağlığı verileri hesaplanamadı!', 'error');
                    return;
                }

                let csvContent = '\uFEFF';

                const headers = ['Müdürlükler', 'Ruh Sağlığı Genel (%)', 'Sigara Kullanımı (%)',
                    'S46: Keyif Alamama', 'S47: Üzgün/Çökkün', 'S48: Gergin/Kaygılı', 'S49: Endişe Kontrolü'];
                csvContent += headers.map(h => `"${h}"`).join(',') + '\n';

                const genelRow = [
                    '"GENEL BELEDİYE"',
                    `${genelBelediye.ruhSagligi}%`,
                    `${genelBelediye.sigaraOrani}%`,
                    `${genelBelediye.ruhSagligiDetay.keyifAlamama}%`,
                    `${genelBelediye.ruhSagligiDetay.uzgunCokkun}%`,
                    `${genelBelediye.ruhSagligiDetay.gerginKaygili}%`,
                    `${genelBelediye.ruhSagligiDetay.endiseKontrol}%`
                ];
                csvContent += genelRow.join(',') + '\n';

                mudurlukler.forEach(md => {
                    const row = [
                        `"#${md.kod} - ${md.ad}"`,
                        `${md.ruhSagligi || 0}%`,
                        `${md.sigaraOrani || 0}%`,
                        `${md.ruhSagligiDetay?.keyifAlamama || 0}%`,
                        `${md.ruhSagligiDetay?.uzgunCokkun || 0}%`,
                        `${md.ruhSagligiDetay?.gerginKaygili || 0}%`,
                        `${md.ruhSagligiDetay?.endiseKontrol || 0}%`
                    ];
                    csvContent += row.join(',') + '\n';
                });

                const blob = new Blob([csvContent], {type: 'text/csv;charset=utf-8;'});
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                const today = new Date().toISOString().split('T')[0];
                link.setAttribute('href', url);
                link.setAttribute('download', `ruh_sagligi_${today}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                utils.showMessage('✅ CSV dosyası indirildi!', 'success');
            },

            exportTemalar: () => {
                if (!state.processedData || Object.keys(state.processedData).length === 0) {
                    utils.showMessage('⚠️ CSV indirmek için önce veri girişi yapın!', 'warning');
                    return;
                }

                const mudurlukler = Object.values(state.processedData);
                const genelBelediye = tableRenderer.calculateGenelBelediyeTemalar();

                if (!genelBelediye) {
                    utils.showMessage('⚠️ Tema verileri hesaplanamadı!', 'error');
                    return;
                }

                let csvContent = '\uFEFF';

                const headers = ['Müdürlükler', 'İş-Kişi Uyumu', 'Görev-Rol Netliği', 'İş Yükü/Stresi',
                    'Yöneticilerle İlişkiler', 'Çalışma Arkadaşları', 'Kurum İçi İletişim',
                    'Çalışma Koşulları', 'Kamu Hizmeti Motivasyonu', 'Yetkinlik & Performans', 'Eğitim & Gelişim'];
                csvContent += headers.map(h => `"${h}"`).join(',') + '\n';

                const genelRow = [
                    '"GENEL BELEDİYE"',
                    `${genelBelediye.isKisiUyumu}%`,
                    `${genelBelediye.gorevRolNetligi}%`,
                    `${genelBelediye.hizmetTalepYogunlugu}%`,
                    `${genelBelediye.yoneticilerleIliskiler}%`,
                    `${genelBelediye.calismaArkadaslari}%`,
                    `${genelBelediye.kurumIciIletisim}%`,
                    `${genelBelediye.calismaKosullari}%`,
                    `${genelBelediye.kamuHizmetiMotivasyonu}%`,
                    `${genelBelediye.yetkinlikPerformans}%`,
                    `${genelBelediye.egitimGelisim}%`
                ];
                csvContent += genelRow.join(',') + '\n';

                mudurlukler.forEach(md => {
                    const t = md.temalar;
                    const row = [
                        `"#${md.kod} - ${md.ad}"`,
                        `${t.isKisiUyumu}%`,
                        `${t.gorevRolNetligi}%`,
                        `${t.hizmetTalepYogunlugu}%`,
                        `${t.yoneticilerleIliskiler}%`,
                        `${t.calismaArkadaslari}%`,
                        `${t.kurumIciIletisim}%`,
                        `${t.calismaKosullari}%`,
                        `${t.kamuHizmetiMotivasyonu}%`,
                        `${t.yetkinlikPerformans}%`,
                        `${t.egitimGelisim}%`
                    ];
                    csvContent += row.join(',') + '\n';
                });

                const blob = new Blob([csvContent], {type: 'text/csv;charset=utf-8;'});
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                const today = new Date().toISOString().split('T')[0];
                link.setAttribute('href', url);
                link.setAttribute('download', `temalar_${today}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                utils.showMessage('✅ CSV dosyası indirildi!', 'success');
            },

            exportAcikUclu: () => {
                if (!state.processedData || Object.keys(state.processedData).length === 0) {
                    utils.showMessage('⚠️ CSV indirmek için önce veri girişi yapın!', 'warning');
                    return;
                }

                const mudurlukler = Object.values(state.processedData);
                let csvContent = '\uFEFF';

                const headers = ['Müdürlük', 'En Çok Geçen Kelimeler (Top 5)', 'Toplam Cevap'];
                csvContent += headers.map(h => `"${h}"`).join(',') + '\n';

                const allSurveys = mudurlukler.flatMap(md => [...md.gecerliAnketler, ...md.gecersizAnketler]);
                const genelKeywords = utils.analyzeKeywords(allSurveys);
                const genelCount = allSurveys.filter(s => s.acikUclu && s.acikUclu.trim()).length;
                const genelKeywordsStr = genelKeywords.slice(0, 5).map(k => `${k.word} (${k.count})`).join(', ');
                csvContent += `"GENEL BELEDİYE","${genelKeywordsStr}",${genelCount}\n`;

                mudurlukler.forEach(md => {
                    const allMdSurveys = [...md.gecerliAnketler, ...md.gecersizAnketler];
                    const count = allMdSurveys.filter(s => s.acikUclu && s.acikUclu.trim()).length;
                    const keywords = utils.analyzeKeywords(allMdSurveys);
                    const keywordsStr = keywords.slice(0, 5).map(k => `${k.word} (${k.count})`).join(', ');
                    csvContent += `"#${md.kod} - ${md.ad}","${keywordsStr}",${count}\n`;
                });

                const blob = new Blob([csvContent], {type: 'text/csv;charset=utf-8;'});
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                const today = new Date().toISOString().split('T')[0];
                link.setAttribute('href', url);
                link.setAttribute('download', `acik_uclu_${today}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                utils.showMessage('✅ CSV dosyası indirildi!', 'success');
            }
        };

        document.addEventListener('DOMContentLoaded', async () => {
            window.dataInput = dataInput;
            window.surveyManager = surveyManager;
            window.tableSorter = tableSorter;
            window.tableFilter = tableFilter;
            window.openEndedManager = openEndedManager;
            window.sosyalMedyaManager = sosyalMedyaManager;
            window.sorularManager = sorularManager;
            window.themeManager = themeManager;
            window.dashboardManager = dashboardManager;
            window.comparisonManager = comparisonManager;
            window.pageManager = pageManager;
            window.databaseAPI = databaseAPI;
            window.csvExporter = csvExporter;

            await databaseAPI.loadData();

            pageManager.initMenu();

            document.body.addEventListener('click', (e) => {
                const removeBtn = e.target.closest('.remove-btn');
                if (removeBtn) {
                    e.preventDefault();
                    e.stopPropagation();

                    const anketKod = removeBtn.getAttribute('data-kod');
                    if (anketKod) surveyManager.removeSurvey(anketKod);
                    return false;
                }

                const mudurlukBtn = e.target.closest('.btn-remove-mudurluk');
                if (mudurlukBtn) {
                    e.preventDefault();
                    e.stopPropagation();

                    const mudurlukKod = mudurlukBtn.getAttribute('data-mudurluk');
                    if (mudurlukKod) surveyManager.removeMudurlukSurveys(mudurlukKod);
                    return false;
                }
            });

            window.addEventListener('message', (event) => {
                if (event.data && event.data.type === 'navigateToMudurluk') {
                    const mudurlukKey = event.data.mudurluk;
                    if (mudurlukKey && pageManager.goToMudurlukRapor) {
                        // Seçili müdürlüğü ayarla ve listeyi yenile (seçili en üste gelecek)
                        pageManager.goToMudurlukRapor(mudurlukKey);
                        pageManager.populateMudurlukQuickNav();
                    }
                }
                
                if (event.data && event.data.type === 'belediyeGeneliReady') {
                    if (pageManager.pendingScrollToOzet) {
                        pageManager.pendingScrollToOzet = false;
                        const iframe = document.getElementById('belediyeGeneliIframe');
                        if (iframe && iframe.contentWindow) {
                            iframe.contentWindow.postMessage({ type: 'scrollToOzetTablosu' }, '*');
                        }
                    }
                }
            });
        });
    </script>
    <!-- AI INSIGHT MODAL -->
    <div id="aiInsightModal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center;">
        <div
            style="background: white; padding: 30px; border-radius: 12px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="font-size: 20px; font-weight: 700; color: #1a1a1a;">📊 Açık Uçlu Yorum Analizi Ekle</h3>
                <button onclick="document.getElementById('aiInsightModal').style.display='none';"
                    style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280;">&times;</button>
            </div>

            <p
                style="font-size: 13px; color: #6b7280; margin-bottom: 20px; background: #f3f4f6; padding: 12px; border-radius: 8px;">
                ℹ️ <strong>AI Prompt Şablonu:</strong> ChatGPT'ye veya başka bir AI'ya açık uçlu yorumları gönderin.
                AI'dan gelen analizi aşağıdaki forma girin.
            <details style="margin-top: 10px;">
                <summary style="cursor: pointer; color: #C86A3C; font-weight: 600;">AI'ya Gönderilecek Prompt (Tıkla)
                </summary>
                <pre
                    style="background: #1f2937; color: #10b981; padding: 12px; border-radius: 6px; font-size: 11px; margin-top: 10px; overflow-x: auto;">Aşağıdaki belediye personeli yorumlarını analiz et ve EN SIK GEÇEN 5-10 KONUYU şu formatta çıkar:

KONU: [Kısa başlık]
Kaç yorumda geçiyor: [sayı] yorum ([yüzde]%)
Duygu: [Olumlu/Nötr/Olumsuz]
Duygu puanı: [1-10, 1=çok olumsuz, 10=çok olumlu]
En sık ifadeler:
- "[ifade]" ([kaç kez] kez)
Örnek yorumlar:
1. "[tam yorum]"</pre>
            </details>
            </p>

            <form id="aiInsightForm" onsubmit="event.preventDefault(); saveAIInsight();">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 6px;">1. Konu
                        Başlığı:</label>
                    <input type="text" id="aiTopic" required
                        style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 14px;"
                        placeholder="Örn: Otopark Yetersizliği">
                </div>

                <div style="margin-bottom: 15px;">
                    <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 6px;">2. Duygu Durumu
                        (1-10):</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="range" id="aiSentiment" min="1" max="10" value="5"
                            oninput="document.getElementById('sentimentValue').textContent=this.value" style="flex: 1;">
                        <span id="sentimentValue" style="font-weight: 700; color: #C86A3C; min-width: 30px;">5</span>
                    </div>
                    <div style="font-size: 11px; color: #6b7280; margin-top: 4px;">1 = Çok olumsuz, 10 = Çok olumlu
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div>
                        <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 6px;">3. Kaç
                            Yorumda Geçiyor (%):</label>
                        <input type="number" id="aiFrequency" required min="0" max="100"
                            style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 14px;"
                            placeholder="Örn: 38">
                    </div>
                    <div>
                        <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 6px;">4. Kaç Kişi
                            Bahsetmiş:</label>
                        <input type="number" id="aiMentionCount" required min="0"
                            style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 14px;"
                            placeholder="Örn: 184">
                    </div>
                </div>

                <div style="margin-bottom: 15px;">
                    <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 6px;">5. En Sık Geçen
                        İfadeler (Her satıra bir tane):</label>
                    <textarea id="aiPhrases" rows="3"
                        style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px;"
                        placeholder='"Park yeri bulamıyorum" (72 kez)
"Sabah stres otopark yüzünden" (48 kez)'></textarea>
                </div>

                <div style="margin-bottom: 20px;">
                    <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 6px;">6. Örnek
                        Yorumlar (Her satıra bir tane):</label>
                    <textarea id="aiExamples" rows="3"
                        style="width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px;"
                        placeholder='"Sabah işe gelirken en büyük stresim otopark bulmak."
"Park yeri yetersiz, çok geç kalıyorum."'></textarea>
                </div>

                <div style="display: flex; gap: 10px;">
                    <button type="submit"
                        style="flex: 1; padding: 12px; background: #C86A3C; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                        Kaydet ve Listeye Ekle
                    </button>
                    <button type="button"
                        onclick="document.getElementById('aiInsightModal').style.display='none'; document.getElementById('aiInsightForm').reset();"
                        style="padding: 12px 20px; background: #6b7280; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                        İptal
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        async function loadAccessLogs() {
            const tbody = document.getElementById('accessLogsBody');
            if (!tbody) return;
            
            try {
                const token = localStorage.getItem('authToken') || new URLSearchParams(window.location.search).get('token');
                const response = await fetch(`/api/access-logs?token=${token}`);
                const data = await response.json();
                
                if (data.success && data.logs.length > 0) {
                    tbody.innerHTML = data.logs.map(log => {
                        const date = new Date(log.login_time);
                        const formattedDate = date.toLocaleDateString('tr-TR', {day: '2-digit', month: '2-digit', year: 'numeric'});
                        const formattedTime = date.toLocaleTimeString('tr-TR', {hour: '2-digit', minute: '2-digit'});
                        const browserInfo = log.user_agent ? log.user_agent.substring(0, 60) + (log.user_agent.length > 60 ? '...' : '') : '-';
                        const statusBadge = log.success 
                            ? '<span class="px-2 py-1 bg-green-100 text-green-700 text-xs rounded-full font-medium">Basarili</span>'
                            : '<span class="px-2 py-1 bg-red-100 text-red-700 text-xs rounded-full font-medium">Basarisiz</span>';
                        
                        return `<tr class="border-b border-border-light hover:bg-page-bg transition-colors">
                            <td class="px-4 py-3 text-sm text-text-body">${formattedDate} ${formattedTime}</td>
                            <td class="px-4 py-3 text-sm text-text-body font-mono">${log.ip_address}</td>
                            <td class="px-4 py-3 text-xs text-text-meta" title="${log.user_agent || ''}">${browserInfo}</td>
                            <td class="px-4 py-3 text-center">${statusBadge}</td>
                        </tr>`;
                    }).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="4" class="text-center py-8 text-text-meta">Henuz giris kaydı yok</td></tr>';
                }
            } catch (err) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center py-8 text-red-500">Loglar yuklenemedi</td></tr>';
            }
        }
        
        function saveAIInsight() {
            const topic = document.getElementById('aiTopic').value;
            const sentiment = parseInt(document.getElementById('aiSentiment').value);
            const frequency = parseFloat(document.getElementById('aiFrequency').value);
            const mentionCount = parseInt(document.getElementById('aiMentionCount').value);
            const phrasesText = document.getElementById('aiPhrases').value;
            const examplesText = document.getElementById('aiExamples').value;

            const topPhrases = phrasesText.split('\n').filter(p => p.trim()).map(p => p.trim());
            const examples = examplesText.split('\n').filter(e => e.trim()).map(e => e.trim());

            const insight = {
                topic,
                sentiment,
                frequency,
                mentionCount,
                topPhrases,
                examples
            };

            unifiedPriorityManager.saveAIInsight(insight);

            document.getElementById('aiInsightModal').style.display = 'none';
            document.getElementById('aiInsightForm').reset();
            document.getElementById('sentimentValue').textContent = '5';

            dashboardManager.renderUnifiedPriorities();

            alert('✅ AI analizi başarıyla eklendi!');
        }
    </script>

</body>

</html>